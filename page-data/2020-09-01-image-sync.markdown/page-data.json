{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-09-01-image-sync.markdown/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc Redcarpet -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#docker-image\">docker image</a>\n<ul>\n<li><a href=\"#manifest\">manifest</a></li>\n<li><a href=\"#layer\">layer</a></li>\n<li><a href=\"#%E5%B1%95%E7%A4%BA%E9%95%9C%E5%83%8F%E4%BF%A1%E6%81%AF\">展示镜像信息</a></li>\n</ul>\n</li>\n<li><a href=\"#image-syncer\">image syncer</a>\n<ul>\n<li><a href=\"#%E7%94%9F%E6%88%90%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5%E5%85%B3%E7%B3%BB\">生成镜像同步关系</a></li>\n<li><a href=\"#%E7%94%9F%E6%88%90%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\">生成同步任务</a></li>\n<li><a href=\"#%E8%BF%90%E8%A1%8C%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\">运行同步任务</a>\n<ul>\n<li><a href=\"#task-run\">task.Run</a></li>\n</ul>\n</li>\n<li><a href=\"#%E5%90%8C%E6%AD%A5%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95\">同步失败重试</a></li>\n<li><a href=\"#%E7%AE%80%E5%8C%96%E7%89%88\">简化版</a></li>\n</ul>\n</li>\n<li><a href=\"#references\">References</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>由于我司主要的战场是在海外，所以在海外部署时，希望把镜像也同步到对应的海外区。目前采用的<a href=\"https://github.com/AliyunContainerService/image-syncer\">image-syncer</a></p>\n<h1 id=\"docker-image\" style=\"position:relative;\"><a href=\"#docker-image\" aria-label=\"docker image permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>docker image</h1>\n<h2 id=\"manifest\" style=\"position:relative;\"><a href=\"#manifest\" aria-label=\"manifest permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>manifest</h2>\n<p>镜像的 manifest 提供了一个 config 和一些 layer 作为容器镜像</p>\n<h2 id=\"layer\" style=\"position:relative;\"><a href=\"#layer\" aria-label=\"layer permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>layer</h2>\n<p>layer 是对基础镜像每一步操作，生成的记录</p>\n<h2 id=\"展示镜像信息\" style=\"position:relative;\"><a href=\"#%E5%B1%95%E7%A4%BA%E9%95%9C%E5%83%8F%E4%BF%A1%E6%81%AF\" aria-label=\"展示镜像信息 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>展示镜像信息</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker manifest inspect --verbose hello-world\n</code></pre></div>\n<h1 id=\"image-syncer\" style=\"position:relative;\"><a href=\"#image-syncer\" aria-label=\"image syncer permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>image syncer</h1>\n<p>具体使用不说了，需要两个配置文件(或者写在一个里)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">auth.json：提供镜像仓库的地址\nimages.json: 提供需要同步的镜像</code></pre></div>\n<p>为了保证并发，putATask、getATask，GetAURLPair，PutAURLPair 等均采用通道阻塞</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">c <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>Client<span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n\t\ttaskListChan<span class=\"token punctuation\">:</span>               <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\turlPairListChan<span class=\"token punctuation\">:</span>            <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tfailedTaskListChan<span class=\"token punctuation\">:</span>         <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tfailedTaskGenerateListChan<span class=\"token punctuation\">:</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>Client<span class=\"token punctuation\">)</span> <span class=\"token function\">GetAURLPair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>URLPair<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tc<span class=\"token punctuation\">.</span>urlPairListChan <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span>\n\t<span class=\"token keyword\">defer</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token operator\">&lt;-</span>c<span class=\"token punctuation\">.</span>urlPairListChan\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>启动的时候还可以指定并发 goroutine 数量 proc， 重试次数 retries，</p>\n<h2 id=\"生成镜像同步关系\" style=\"position:relative;\"><a href=\"#%E7%94%9F%E6%88%90%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5%E5%85%B3%E7%B3%BB\" aria-label=\"生成镜像同步关系 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成镜像同步关系</h2>\n<p>根据配置的同步 image 信息，生成源和目的地的对应关系</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">for</span> source<span class=\"token punctuation\">,</span> dest <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> c<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span><span class=\"token function\">GetImageList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">.</span>urlPairList<span class=\"token punctuation\">.</span><span class=\"token function\">PushBack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>URLPair<span class=\"token punctuation\">{</span>\n        source<span class=\"token punctuation\">:</span>      source<span class=\"token punctuation\">,</span>\n        destination<span class=\"token punctuation\">:</span> dest<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 id=\"生成同步任务\" style=\"position:relative;\"><a href=\"#%E7%94%9F%E6%88%90%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\" aria-label=\"生成同步任务 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成同步任务</h2>\n<p>根据并发 goroutine 数，使用<code class=\"language-text\">WaitGroup</code>进行并发，去生成 task</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">openRoutinesGenTaskAndWaitForFinish <span class=\"token operator\">:=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    wg <span class=\"token operator\">:=</span> sync2<span class=\"token punctuation\">.</span>WaitGroup<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> c<span class=\"token punctuation\">.</span>routineNum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n        wg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n                urlPair<span class=\"token punctuation\">,</span> empty <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">GetAURLPair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// no more task to generate</span>\n                <span class=\"token keyword\">if</span> empty <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">break</span>\n                <span class=\"token punctuation\">}</span>\n                moreURLPairs<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">GenerateSyncTask</span><span class=\"token punctuation\">(</span>urlPair<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">,</span> urlPair<span class=\"token punctuation\">.</span>destination<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                    c<span class=\"token punctuation\">.</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Generate sync task %s to %s error: %v\"</span><span class=\"token punctuation\">,</span> urlPair<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">,</span> urlPair<span class=\"token punctuation\">.</span>destination<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n                    <span class=\"token comment\">// put to failedTaskGenerateList</span>\n                    c<span class=\"token punctuation\">.</span><span class=\"token function\">PutAFailedURLPair</span><span class=\"token punctuation\">(</span>urlPair<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> moreURLPairs <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                    c<span class=\"token punctuation\">.</span><span class=\"token function\">PutURLPairs</span><span class=\"token punctuation\">(</span>moreURLPairs<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    wg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 id=\"运行同步任务\" style=\"position:relative;\"><a href=\"#%E8%BF%90%E8%A1%8C%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\" aria-label=\"运行同步任务 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>运行同步任务</h2>\n<p>根据并发 goroutine 数，使用<code class=\"language-text\">WaitGroup</code>进行并发，去执行 task</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">openRoutinesHandleTaskAndWaitForFinish <span class=\"token operator\">:=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    wg <span class=\"token operator\">:=</span> sync2<span class=\"token punctuation\">.</span>WaitGroup<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> c<span class=\"token punctuation\">.</span>routineNum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n        wg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n                task<span class=\"token punctuation\">,</span> empty <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">GetATask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// no more tasks need to handle</span>\n                <span class=\"token keyword\">if</span> empty <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">break</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> task<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// put to failedTaskList</span>\n                    c<span class=\"token punctuation\">.</span><span class=\"token function\">PutAFailedTask</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    wg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3 id=\"taskrun\" style=\"position:relative;\"><a href=\"#taskrun\" aria-label=\"taskrun permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>task.Run</h3>\n<p>从源镜像中获取 manifestType 和 manifestByte，然后从到 Layer 的 Blob 信息，然后同步 Blob 和 Manifest</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>Task<span class=\"token punctuation\">)</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// get manifest from source</span>\n\tmanifestByte<span class=\"token punctuation\">,</span> manifestType<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">GetManifest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\tblobInfos<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">GetBlobInfos</span><span class=\"token punctuation\">(</span>manifestByte<span class=\"token punctuation\">,</span> manifestType<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// blob transformation</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> b <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> blobInfos <span class=\"token punctuation\">{</span>\n\t\tblobExist<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span>destination<span class=\"token punctuation\">.</span><span class=\"token function\">CheckBlobExist</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>blobExist <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// pull a blob from source</span>\n\t\t\tblob<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">GetABlob</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\n\t\t\tb<span class=\"token punctuation\">.</span>Size <span class=\"token operator\">=</span> size\n\t\t\t<span class=\"token comment\">// push a blob to destination</span>\n\t\t\tt<span class=\"token punctuation\">.</span>destination<span class=\"token punctuation\">.</span><span class=\"token function\">PutABlob</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span>\n\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// push manifest to destination</span>\n    t<span class=\"token punctuation\">.</span>destination<span class=\"token punctuation\">.</span><span class=\"token function\">PushManifest</span><span class=\"token punctuation\">(</span>manifestByte<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 id=\"同步失败重试\" style=\"position:relative;\"><a href=\"#%E5%90%8C%E6%AD%A5%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95\" aria-label=\"同步失败重试 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>同步失败重试</h2>\n<p>将生成同步任务失败的 task，重新进去 urlPairList，\n将同步失败的 task，重新进去 TaskList，</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">for</span> times <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> times <span class=\"token operator\">&lt;</span> c<span class=\"token punctuation\">.</span>retries<span class=\"token punctuation\">;</span> times<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>failedTaskGenerateList<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span>urlPairList<span class=\"token punctuation\">.</span><span class=\"token function\">PushBackList</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>failedTaskGenerateList<span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">.</span>failedTaskGenerateList<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// retry to generate task</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Start to retry to generate sync tasks, please wait ...\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">openRoutinesGenTaskAndWaitForFinish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>failedTaskList<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span>taskList<span class=\"token punctuation\">.</span><span class=\"token function\">PushBackList</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>failedTaskList<span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">.</span>failedTaskList<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>taskList<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// retry to handle task</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Start to retry sync tasks, please wait ...\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">openRoutinesHandleTaskAndWaitForFinish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 id=\"简化版\" style=\"position:relative;\"><a href=\"#%E7%AE%80%E5%8C%96%E7%89%88\" aria-label=\"简化版 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>简化版</h2>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>Client<span class=\"token punctuation\">)</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Start to generate sync tasks, please wait ...\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 根据配置的image，生成的镜像源到目的地的对应关系</span>\n    <span class=\"token keyword\">for</span> source<span class=\"token punctuation\">,</span> dest <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> c<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span><span class=\"token function\">GetImageList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tc<span class=\"token punctuation\">.</span>urlPairList<span class=\"token punctuation\">.</span><span class=\"token function\">PushBack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>URLPair<span class=\"token punctuation\">{</span>\n\t\t\tsource<span class=\"token punctuation\">:</span>      source<span class=\"token punctuation\">,</span>\n\t\t\tdestination<span class=\"token punctuation\">:</span> dest<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// generate sync tasks</span>\n\t<span class=\"token function\">openRoutinesGenTaskAndWaitForFinish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n\t<span class=\"token comment\">// generate goroutines to handle sync tasks</span>\n\t<span class=\"token function\">openRoutinesHandleTaskAndWaitForFinish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// retry</span>\n    <span class=\"token function\">retry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h1 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h1>\n<ul>\n<li><a href=\"https://github.com/AliyunContainerService/image-syncer\">https://github.com/AliyunContainerService/image-syncer</a></li>\n<li><a href=\"https://docs.docker.com/registry/spec/manifest-v2-2/#image-manifest-field-descriptions\">https://docs.docker.com/registry/spec/manifest-v2-2/#image-manifest-field-descriptions</a></li>\n<li><a href=\"https://docs.docker.com/engine/reference/commandline/manifest_inspect/\">https://docs.docker.com/engine/reference/commandline/manifest_inspect/</a></li>\n<li><a href=\"https://stackoverflow.com/questions/57937733/how-to-enable-experimental-docker-cli-features\">https://stackoverflow.com/questions/57937733/how-to-enable-experimental-docker-cli-features</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#docker-image\">docker image</a></p>\n<ul>\n<li><a href=\"#manifest\">manifest</a></li>\n<li><a href=\"#layer\">layer</a></li>\n<li><a href=\"#%E5%B1%95%E7%A4%BA%E9%95%9C%E5%83%8F%E4%BF%A1%E6%81%AF\">展示镜像信息</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#image-syncer\">image syncer</a></p>\n<ul>\n<li>\n<p><a href=\"#%E7%94%9F%E6%88%90%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5%E5%85%B3%E7%B3%BB\">生成镜像同步关系</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%94%9F%E6%88%90%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\">生成同步任务</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%BF%90%E8%A1%8C%E5%90%8C%E6%AD%A5%E4%BB%BB%E5%8A%A1\">运行同步任务</a></p>\n<ul>\n<li><a href=\"#taskrun\">task.Run</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%90%8C%E6%AD%A5%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95\">同步失败重试</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%AE%80%E5%8C%96%E7%89%88\">简化版</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#references\">References</a></p>\n</li>\n</ul>","frontmatter":{"title":"[源码阅读]image-syncer","date":"2020-09-01"}}},"pageContext":{"slug":"/2020-09-01-image-sync.markdown"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}