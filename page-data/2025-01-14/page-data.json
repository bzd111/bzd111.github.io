{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-01-14/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc GitLab -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#%E6%9C%80%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95\">最简单方法</a></li>\n<li><a href=\"#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95\">通用方法</a>\n<ul>\n<li><a href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\">使用方法</a></li>\n</ul>\n</li>\n<li><a href=\"#%E6%9C%80%E7%BB%88%E6%96%B9%E6%B3%95\">最终方法</a>\n<ul>\n<li><a href=\"#%E9%83%A8%E7%BD%B2\">部署</a></li>\n<li><a href=\"#%E4%BD%BF%E7%94%A8\">使用</a></li>\n<li><a href=\"#%E9%99%84%E5%8A%A0%E7%8E%A9%E6%B3%95\">附加玩法</a></li>\n</ul>\n</li>\n<li><a href=\"#%E5%85%BC%E5%AE%B9k8s%E4%BD%BF%E7%94%A8\">兼容k8s使用</a></li>\n<li><a href=\"#summary\">summary</a></li>\n<li><a href=\"#reference\">reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>dockerhub 被墙之后，导致docker pull不下来、push不上去，造成了一点麻烦。</p>\n<h1 id=\"最简单方法\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95\" aria-label=\"最简单方法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最简单方法</h1>\n<p>可以给docker增加代理，这样不仅能pull也能push。下面的方法只能解决pull。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vim /etc/systemd/system/docker.service.d/http-proxy.conf\n# appnd\n[Service]\nEnvironment=\"HTTP_PROXY=proxy.example.com:80\"\nEnvironment=\"HTTPS_PROXY=proxy.example.com:443\"</code></pre></div>\n<h1 id=\"通用方法\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95\" aria-label=\"通用方法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通用方法</h1>\n<p>依赖赛博佛祖Cloudflare，使用无服务器，自建Docker仓库镜像代理，部署方法详见<a href=\"https://github.com/cmliu/CF-Workers-docker.io\">链接</a>，</p>\n<h2 id=\"使用方法\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\" aria-label=\"使用方法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用方法</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> pull <span class=\"token punctuation\">{</span>workers.dev<span class=\"token punctuation\">}</span>/nginx</code></pre></div>\n<h1 id=\"最终方法\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%BB%88%E6%96%B9%E6%B3%95\" aria-label=\"最终方法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最终方法</h1>\n<p>上面的方法只能解决dockerhub的镜像，还有其他的镜像仓库拉取不下来，比如gcr.io、ghcr.io、registry.k8s.io、quay.io、mcr.microsoft.com。</p>\n<p>这就需要使用第二个工具了<a href=\"https://github.com/DaoCloud/crproxy\">crproxy</a></p>\n<h2 id=\"部署\" style=\"position:relative;\"><a href=\"#%E9%83%A8%E7%BD%B2\" aria-label=\"部署 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>部署</h2>\n<p>部署也是很简单，可以在外面的服务器上部署，也可以在内网服务器上部署，</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">crproxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ghcr.io/daocloud/crproxy/crproxy<span class=\"token punctuation\">:</span>v0.9.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> crproxy\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 80<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n      <span class=\"token punctuation\">-</span> 443<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      --acme-cache-dir=/tmp/acme\n      --acme-hosts=*\n      --default-registry=docker.io</span>\n    <span class=\"token key atrule\">tmpfs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /tmp/acme\n\n    <span class=\"token comment\"># 非必须, 如果这台服务器无法畅通的达到你要的镜像仓库可以尝试配置</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> https_proxy=http<span class=\"token punctuation\">:</span>//proxy<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n      <span class=\"token punctuation\">-</span> http_proxy=http<span class=\"token punctuation\">:</span>//proxy<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span></code></pre></div>\n<h2 id=\"使用\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8\" aria-label=\"使用 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用</h2>\n<p><code class=\"language-text\">docker pull 你的域名/hello-world -> docker pull hello-world</code></p>\n<p>也可以添加到 /etc/docker/daemon.json，减少域名</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"registry-mirrors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://你的域名\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>没有域名的话，也可以直接使用ip地址加端口的方式，没有证书认证的需要在/etc/docker/daemon.json配置</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span> <span class=\"token property\">\"insecure-registries\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"192jj.168.1.87:8844\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"附加玩法\" style=\"position:relative;\"><a href=\"#%E9%99%84%E5%8A%A0%E7%8E%A9%E6%B3%95\" aria-label=\"附加玩法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>附加玩法</h2>\n<p>如果你有一台vps，正好在部署了xtls，可以使用它的fallback，那么可以复用这个vps</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"你的域名\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dest\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8443</span><span class=\"token punctuation\">,</span> # 上面cproxy监听的端口\n  <span class=\"token property\">\"xver\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"兼容k8s使用\" style=\"position:relative;\"><a href=\"#%E5%85%BC%E5%AE%B9k8s%E4%BD%BF%E7%94%A8\" aria-label=\"兼容k8s使用 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>兼容k8s使用</h1>\n<p>怎么在k8s使用上面提供的镜像代理呢。</p>\n<p>我写了一个mutating webhook，会把特定前缀的镜像，改成新的镜像，这样就可以在k8s上拉去被墙的镜像了。</p>\n<p>使用方法见<a href=\"https://github.com/bzd111/image-transformer/blob/main/README.md\">readme.md</a></p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>summary</h1>\n<ol>\n<li>\n<p>没有域名，使用 CF-Workers-docker 部署一个worker，用来下载docker的镜像。</p>\n</li>\n<li>\n<p>有域名，使用crproxy 部署一个容器，用来下载所有镜像。</p>\n</li>\n<li>\n<p>有在 k8s 下使用的需求，可以使用mutating webhook，部署时自动修改镜像。</p>\n</li>\n</ol>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>reference</h1>\n<ul>\n<li><a href=\"https://github.com/cmliu/CF-Workers-docker.io\">https://github.com/cmliu/CF-Workers-docker.io</a></li>\n<li><a href=\"https://github.com/DaoCloud/crproxy/tree/master/examples/simple\">https://github.com/DaoCloud/crproxy/tree/master/examples/simple</a></li>\n<li><a href=\"https://github.com/DaoCloud/crproxy\">https://github.com/DaoCloud/crproxy</a></li>\n<li><a href=\"https://github.com/cmliu/CF-Workers-docker\">https://github.com/cmliu/CF-Workers-docker</a></li>\n<li><a href=\"https://github.com/bzd111/image-transformer\">https://github.com/bzd111/image-transformer</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%9C%80%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95\">最简单方法</a></p>\n</li>\n<li>\n<p><a href=\"#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95\">通用方法</a></p>\n<ul>\n<li><a href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\">使用方法</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%9C%80%E7%BB%88%E6%96%B9%E6%B3%95\">最终方法</a></p>\n<ul>\n<li><a href=\"#%E9%83%A8%E7%BD%B2\">部署</a></li>\n<li><a href=\"#%E4%BD%BF%E7%94%A8\">使用</a></li>\n<li><a href=\"#%E9%99%84%E5%8A%A0%E7%8E%A9%E6%B3%95\">附加玩法</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%85%BC%E5%AE%B9k8s%E4%BD%BF%E7%94%A8\">兼容k8s使用</a></p>\n</li>\n<li>\n<p><a href=\"#summary\">summary</a></p>\n</li>\n<li>\n<p><a href=\"#reference\">reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"docker被墙之后的使用方法","date":"2025-01-14"}}},"pageContext":{"slug":"/2025-01-14"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}