{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-12-19-aiohttp-usage.markdown/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc GFM -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#asyncio\">asyncio</a>\n<ul>\n<li><a href=\"#asynciorun\">asyncio.run</a></li>\n<li><a href=\"#asyncio-%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%BB%BB%E5%8A%A1\">asyncio 运行多任务</a></li>\n</ul>\n</li>\n<li><a href=\"#aiohttp\">aiohttp</a>\n<ul>\n<li><a href=\"#client\">client</a></li>\n<li><a href=\"#server\">server</a>\n<ul>\n<li><a href=\"#a-minimal-application\">A Minimal Application</a></li>\n<li><a href=\"#%E8%A3%85%E9%A5%B0%E5%99%A8%E6%96%B9%E6%B3%95\">装饰器方法</a></li>\n<li><a href=\"#url-%E5%8F%82%E6%95%B0%E5%92%8C-query-%E5%8F%82%E6%95%B0\">url 参数和 query 参数</a></li>\n<li><a href=\"#%E8%BF%94%E5%9B%9E-json-%E7%9A%84-response\">返回 json 的 response</a></li>\n<li><a href=\"#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93\">使用数据库</a></li>\n</ul>\n</li>\n<li><a href=\"#template\">template</a></li>\n<li><a href=\"#middleware\">middleware</a></li>\n<li><a href=\"#seesion\">seesion</a></li>\n</ul>\n</li>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>这篇文章简单介绍下 aiohttp,这个是看了 pycon2019<a href=\"https://www.youtube.com/watch?v=OxzVApXKWYM&#x26;list=PLPbTDk1hBo3xof51R8pk3kP1BVBuMYP9c&#x26;index=9&#x26;t=2193s\">视频</a>的观后感\n视频不错,作者本身是 python 核心开发者。</p>\n<p>视频时间 2 个小时，比较长，没有时间的话，可以看作者提供的<a href=\"https://us-pycon-2019-tutorial.readthedocs.io/\">文档</a></p>\n<h1 id=\"asyncio\" style=\"position:relative;\"><a href=\"#asyncio\" aria-label=\"asyncio permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>asyncio</h1>\n<p>python3.7 提供了<code class=\"language-text\">asyncio.run方法</code>，运行协程更方便，可以看一下下面的 🌰</p>\n<h2 id=\"asynciorun\" style=\"position:relative;\"><a href=\"#asynciorun\" aria-label=\"asynciorun permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>asyncio.run</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># python3.5之前</span>\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">import</span> asyncio\nIn <span class=\"token punctuation\">:</span>@asyncio<span class=\"token punctuation\">.</span>coroutine\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token keyword\">def</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     a<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         b<span class=\"token punctuation\">,</span> a <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">,</span> b\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> a\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nIn <span class=\"token punctuation\">:</span>@asyncio<span class=\"token punctuation\">.</span>coroutine\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token keyword\">def</span> <span class=\"token function\">coro</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">yield</span> <span class=\"token keyword\">from</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         f <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token keyword\">from</span> fib<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nIn <span class=\"token punctuation\">:</span>loop <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>get_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nIn <span class=\"token punctuation\">:</span>loop<span class=\"token punctuation\">.</span>run_until_complete<span class=\"token punctuation\">(</span>coro<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">0</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">1</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># python3.5以上(包含3.5)</span>\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">import</span> asyncio\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     a<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         b<span class=\"token punctuation\">,</span> a <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">,</span> b\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> a\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">coro</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         f <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> fib<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nIn <span class=\"token punctuation\">:</span>loop <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>get_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nIn <span class=\"token punctuation\">:</span>loop<span class=\"token punctuation\">.</span>run_until_complete<span class=\"token punctuation\">(</span>coro<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">0</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">1</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># python3.7</span>\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">import</span> asyncio\n\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     a<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         b<span class=\"token punctuation\">,</span> a <span class=\"token operator\">=</span> a<span class=\"token punctuation\">,</span> a <span class=\"token operator\">+</span> b\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> a\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nIn <span class=\"token punctuation\">:</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">coro</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         f <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> fib<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n\nIn <span class=\"token punctuation\">:</span>asyncio<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>coro<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">0</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">1</span>\n</code></pre></div>\n<h2 id=\"asyncio-运行多任务\" style=\"position:relative;\"><a href=\"#asyncio-%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%BB%BB%E5%8A%A1\" aria-label=\"asyncio 运行多任务 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>asyncio 运行多任务</h2>\n<p>使用 asyncio.gather，返回的结果就是 task 的结果，而且是无序的</p>\n<p>使用 asyncio.wait，返回的结果是 done, pending 两个参数，分别代表已完成的 task 和正在等待的 pending,</p>\n<p>task 的结果，需要遍历去调用 task 的 result 的方法才能获取到。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> asyncio\n<span class=\"token keyword\">import</span> time\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">long_running_task</span><span class=\"token punctuation\">(</span>time_to_sleep<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Begin sleep for </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>time_to_sleep<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>time_to_sleep<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Awake from </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>time_to_sleep<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> time_to_sleep\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    task1 <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>create_task<span class=\"token punctuation\">(</span>long_running_task<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    task2 <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>create_task<span class=\"token punctuation\">(</span>long_running_task<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    task3 <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>create_task<span class=\"token punctuation\">(</span>long_running_task<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># results = []</span>\n    <span class=\"token comment\"># done, pending = await asyncio.wait([task3, task2, task1])</span>\n    <span class=\"token comment\"># for d in done:</span>\n    <span class=\"token comment\">#     results.append(d.result())</span>\n    <span class=\"token comment\"># print('resuluts: ', results)</span>\n    <span class=\"token comment\"># print('pending: ', pending)</span>\n\n    results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>gather<span class=\"token punctuation\">(</span>task1<span class=\"token punctuation\">,</span> task2<span class=\"token punctuation\">,</span> task3<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resuluts: '</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    s <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>perf_counter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    asyncio<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    elapsed <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>perf_counter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> s\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Excetion time: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>elapsed<span class=\"token punctuation\">:</span><span class=\"token format-spec\">0.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> seconds.'</span></span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h1 id=\"aiohttp\" style=\"position:relative;\"><a href=\"#aiohttp\" aria-label=\"aiohttp permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>aiohttp</h1>\n<p>异步 HTTP 客户端/服务器</p>\n<h2 id=\"client\" style=\"position:relative;\"><a href=\"#client\" aria-label=\"client permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>client</h2>\n<p>可以用作异步请求的客户端，requests 只能做同步请求。</p>\n<p>使用方法也很简单，用 aiohttp.ClientSession()开启一个会话，然后通过这个会话是发起 http 请求，这里\n只演示了 get，也可以用作其他的 method。返回的结果通过 read()方法获取到。</p>\n<p>这里使用异步的上下文管理器，用法和普通的是一样的，只是前面加了 async 关键字。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> asyncio\n<span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">import</span> aiohttp\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">download_pep</span><span class=\"token punctuation\">(</span>pep_number<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">:</span>\n\n    url <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"https://www.python.org/dev/peps/pep-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pep_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">/\"</span></span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Begin downloading </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>url<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> aiohttp<span class=\"token punctuation\">.</span>ClientSession<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> session<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> resp<span class=\"token punctuation\">:</span>\n            content <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> resp<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Finished downloading </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>url<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> content\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">write_to_file</span><span class=\"token punctuation\">(</span>pep_number<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    filename <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"async_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pep_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">.html\"</span></span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> pep_file<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Begin writing to </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>filename<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        pep_file<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Finished writing </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>filename<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">web_scrape_task</span><span class=\"token punctuation\">(</span>pep_number<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    content <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> download_pep<span class=\"token punctuation\">(</span>pep_number<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> write_to_file<span class=\"token punctuation\">(</span>pep_number<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    tasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">8010</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8016</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        tasks<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>web_scrape_task<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>wait<span class=\"token punctuation\">(</span>tasks<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    s <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>perf_counter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    asyncio<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    elapsed <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>perf_counter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> s\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Execution time: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>elapsed<span class=\"token punctuation\">:</span><span class=\"token format-spec\">0.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> seconds.\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"server\" style=\"position:relative;\"><a href=\"#server\" aria-label=\"server permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>server</h2>\n<h3 id=\"a-minimal-application\" style=\"position:relative;\"><a href=\"#a-minimal-application\" aria-label=\"a minimal application permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Minimal Application</h3>\n<p>最简单的例子，使用也很简单，定义一个 handle 函数，然后绑定路由，就可以了。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>web<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"装饰器方法\" style=\"position:relative;\"><a href=\"#%E8%A3%85%E9%A5%B0%E5%99%A8%E6%96%B9%E6%B3%95\" aria-label=\"装饰器方法 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>装饰器方法</h3>\n<p>可以使用路由装饰器的方法</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h3 id=\"url-参数和-query-参数\" style=\"position:relative;\"><a href=\"#url-%E5%8F%82%E6%95%B0%E5%92%8C-query-%E5%8F%82%E6%95%B0\" aria-label=\"url 参数和 query 参数 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>url 参数和 query 参数</h3>\n<p>url 参数和 query 参数，分别由 match_info、rel_url 获取</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/{username}'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">greet_user</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># http://0.0.0.0:8080/&lt;student>?page=&lt;pagenum></span>\n    user <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>match_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    page_num <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>rel_url<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'page'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Hello, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>user<span class=\"token punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>page_num<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"返回-json-的-response\" style=\"position:relative;\"><a href=\"#%E8%BF%94%E5%9B%9E-json-%E7%9A%84-response\" aria-label=\"返回 json 的 response permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>返回 json 的 response</h3>\n<p>这里通过一个 post view 方法展示，post 的 body 可以通过 request.body 获取到，然后通过 json_response 返回一个 json 格式的 response</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/json'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">json</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    args <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">[</span><span class=\"token string\">'key'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>json_response<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"使用数据库\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93\" aria-label=\"使用数据库 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用数据库</h3>\n<p>使用 cleanup_ctx 将 db 实例放入 config_dict 中，然后在 view 中就可以使用了</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sqlite3\n<span class=\"token keyword\">from</span> pathlib <span class=\"token keyword\">import</span> Path\n<span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> AsyncIterator\n\n<span class=\"token keyword\">import</span> aiosqlite\n<span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/post'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">new_post</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    post <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'post'</span><span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">)</span>\n    db <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>config_dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"DB\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"INSERT INTO posts (title, text) VALUES(?, ?)\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>post<span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">[</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cursor<span class=\"token punctuation\">:</span>\n        post_id <span class=\"token operator\">=</span> cursor<span class=\"token punctuation\">.</span>lastrowid\n    <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>json_response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"new_post\"</span><span class=\"token punctuation\">:</span> post_id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>cleanup_ctx<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>init_db<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_db</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> AsyncIterator<span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    sqlite_db <span class=\"token operator\">=</span> get_db_path<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    db <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> aiosqlite<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>sqlite_db<span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">[</span><span class=\"token string\">\"DB\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> db\n    <span class=\"token keyword\">yield</span>\n    <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_db_path</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Path<span class=\"token punctuation\">:</span>\n    here <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span>cwd<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> <span class=\"token punctuation\">(</span>here <span class=\"token operator\">/</span> <span class=\"token string\">\".git\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> here <span class=\"token operator\">==</span> here<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> RuntimeError<span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot find root github dir\"</span><span class=\"token punctuation\">)</span>\n        here <span class=\"token operator\">=</span> here<span class=\"token punctuation\">.</span>parent\n\n    <span class=\"token keyword\">return</span> here <span class=\"token operator\">/</span> <span class=\"token string\">\"db.sqlite3\"</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">try_make_db</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    sqlite_db <span class=\"token operator\">=</span> get_db_path<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> sqlite_db<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span>\n\n    <span class=\"token keyword\">with</span> sqlite3<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>sqlite_db<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> conn<span class=\"token punctuation\">:</span>\n        cur <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        cur<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>\n            <span class=\"token triple-quoted-string string\">\"\"\"CREATE TABLE posts (\n            id INTEGER PRIMARY KEY,\n            title TEXT,\n            text TEXT,\n            owner TEXT,\n            editor TEXT)\n        \"\"\"</span>\n        <span class=\"token punctuation\">)</span>\n        conn<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\ntry_make_db<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"template\" style=\"position:relative;\"><a href=\"#template\" aria-label=\"template permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>template</h2>\n<p>模版渲染需要依赖 aiohttp-jinja2 和 jinja2</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">import</span> aiohttp_jinja2\n<span class=\"token keyword\">import</span> jinja2\n<span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/{username}\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">greet_user</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n\n    context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>match_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"current_date\"</span><span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">.</span>ctime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    response <span class=\"token operator\">=</span> aiohttp_jinja2<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"base.html\"</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> context<span class=\"token operator\">=</span>context<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> response\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    aiohttp_jinja2<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> loader<span class=\"token operator\">=</span>jinja2<span class=\"token punctuation\">.</span>FileSystemLoader<span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>aiohttp page<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>My aiohttp server<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>Date now: {{ current_date }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>Hello {{ username}}.<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>TODO</p>\n<h2 id=\"middleware\" style=\"position:relative;\"><a href=\"#middleware\" aria-label=\"middleware permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>middleware</h2>\n<p>中间件可以修改 request、response，做一些定制化的操作，如果验证用户是否登陆，记录访问次数，访问 ip、记录日志…</p>\n<p>这里演示一个数据库事务操作，数据库操作错误的话，就会把错误用 response 返回</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sqlite3\n<span class=\"token keyword\">from</span> pathlib <span class=\"token keyword\">import</span> Path\n<span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> AsyncIterator<span class=\"token punctuation\">,</span> Awaitable<span class=\"token punctuation\">,</span> Callable\n\n<span class=\"token keyword\">import</span> aiosqlite\n<span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span><span class=\"token string\">\"Hello world\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/post'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">new_post</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    post <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    db <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>config_dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"DB\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"INSERT INTO posts (title, text) VALUES(?, ?, ?, ?)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>post<span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">[</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cursor<span class=\"token punctuation\">:</span>\n        post_id <span class=\"token operator\">=</span> cursor<span class=\"token punctuation\">.</span>lastrowid\n\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>json_response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"new_post\"</span><span class=\"token punctuation\">:</span> post_id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span>middlewares<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>middleware<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>cleanup_ctx<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>init_db<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_db</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> AsyncIterator<span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    sqlite_db <span class=\"token operator\">=</span> get_db_path<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    db <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> aiosqlite<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>sqlite_db<span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">[</span><span class=\"token string\">\"DB\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> db\n    <span class=\"token keyword\">yield</span>\n    <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_db_path</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Path<span class=\"token punctuation\">:</span>\n    here <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span>cwd<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> <span class=\"token punctuation\">(</span>here <span class=\"token operator\">/</span> <span class=\"token string\">\".git\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> here <span class=\"token operator\">==</span> here<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> RuntimeError<span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot find root github dir\"</span><span class=\"token punctuation\">)</span>\n        here <span class=\"token operator\">=</span> here<span class=\"token punctuation\">.</span>parent\n\n    <span class=\"token keyword\">return</span> here <span class=\"token operator\">/</span> <span class=\"token string\">\"db.sqlite3\"</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">try_make_db</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    sqlite_db <span class=\"token operator\">=</span> get_db_path<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> sqlite_db<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span>\n\n    <span class=\"token keyword\">with</span> sqlite3<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>sqlite_db<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> conn<span class=\"token punctuation\">:</span>\n        cur <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        cur<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>\n            <span class=\"token triple-quoted-string string\">\"\"\"CREATE TABLE posts (\n            id INTEGER PRIMARY KEY,\n            title TEXT,\n            text TEXT,\n            owner TEXT,\n            editor TEXT)\n        \"\"\"</span>\n        <span class=\"token punctuation\">)</span>\n        conn<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@web<span class=\"token punctuation\">.</span>middleware</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">middleware</span><span class=\"token punctuation\">(</span>\n    request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">:</span> Callable<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> Awaitable<span class=\"token punctuation\">[</span>web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    db <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>config_dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"DB\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">\"BEGIN\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'begin'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        resp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> handler<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">\"COMMIT\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> resp\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">\"ROLLBACK\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>json_response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\ntry_make_db<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h2 id=\"seesion\" style=\"position:relative;\"><a href=\"#seesion\" aria-label=\"seesion permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seesion</h2>\n<p>Session 是用于保存临时数据(如登录用户信息)的存储\nsession 是类 dict 的对象</p>\n<p>通常用 redis 做 backend，将数据保存到 redis 中，cookie 中只有一个 redis 的 key。</p>\n<p>aiohttp 使用 session，需要安装<code class=\"language-text\">pip install aiohttp_session[aioredis]</code></p>\n<p>会在 redis 中创建以 AIOHTTP<em>SESSION</em>开头的 key。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">import</span> aiohttp_session\n<span class=\"token keyword\">import</span> aioredis\n<span class=\"token keyword\">from</span> aiohttp <span class=\"token keyword\">import</span> web\n<span class=\"token keyword\">from</span> aiohttp_session <span class=\"token keyword\">import</span> redis_storage\n\n\nrouter <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>RouteTableDef<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@router<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">:</span>\n    session <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> aiohttp_session<span class=\"token punctuation\">.</span>get_session<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n    last_visit <span class=\"token operator\">=</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">\"last_visit\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> <span class=\"token string\">\"last_visit\"</span> <span class=\"token keyword\">in</span> session <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span>\n    session<span class=\"token punctuation\">[</span><span class=\"token string\">\"last_visit\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    text <span class=\"token operator\">=</span> <span class=\"token string\">\"Last visited: {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>last_visit<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">(</span>text<span class=\"token operator\">=</span>text<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">init_app</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">:</span>\n    app <span class=\"token operator\">=</span> web<span class=\"token punctuation\">.</span>Application<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    pool <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> aioredis<span class=\"token punctuation\">.</span>create_redis_pool<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    session <span class=\"token operator\">=</span> redis_storage<span class=\"token punctuation\">.</span>RedisStorage<span class=\"token punctuation\">(</span>pool<span class=\"token punctuation\">)</span>\n    aiohttp_session<span class=\"token punctuation\">.</span>setup<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span>add_routes<span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> app\n\n\nweb<span class=\"token punctuation\">.</span>run_app<span class=\"token punctuation\">(</span>init_app<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://youtu.be/OxzVApXKWYM\">https://youtu.be/OxzVApXKWYM</a></li>\n<li><a href=\"https://us-pycon-2019-tutorial.readthedocs.io/\">https://us-pycon-2019-tutorial.readthedocs.io/</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#asyncio\">asyncio</a></p>\n<ul>\n<li><a href=\"#asynciorun\">asyncio.run</a></li>\n<li><a href=\"#asyncio-%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%BB%BB%E5%8A%A1\">asyncio 运行多任务</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#aiohttp\">aiohttp</a></p>\n<ul>\n<li>\n<p><a href=\"#client\">client</a></p>\n</li>\n<li>\n<p><a href=\"#server\">server</a></p>\n<ul>\n<li><a href=\"#a-minimal-application\">A Minimal Application</a></li>\n<li><a href=\"#%E8%A3%85%E9%A5%B0%E5%99%A8%E6%96%B9%E6%B3%95\">装饰器方法</a></li>\n<li><a href=\"#url-%E5%8F%82%E6%95%B0%E5%92%8C-query-%E5%8F%82%E6%95%B0\">url 参数和 query 参数</a></li>\n<li><a href=\"#%E8%BF%94%E5%9B%9E-json-%E7%9A%84-response\">返回 json 的 response</a></li>\n<li><a href=\"#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93\">使用数据库</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#template\">template</a></p>\n</li>\n<li>\n<p><a href=\"#middleware\">middleware</a></p>\n</li>\n<li>\n<p><a href=\"#seesion\">seesion</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"[笔记]aiohttp 使用","date":"2019-12-19"}}},"pageContext":{"slug":"/2019-12-19-aiohttp-usage.markdown"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}