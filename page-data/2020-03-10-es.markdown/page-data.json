{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-03-10-es.markdown/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc Redcarpet -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#es\">ES</a>\n<ul>\n<li><a href=\"#%E5%AE%89%E8%A3%85\">安装</a></li>\n<li><a href=\"#%E8%BF%90%E8%A1%8C\">运行</a></li>\n</ul>\n</li>\n<li><a href=\"#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8\">简单使用</a>\n<ul>\n<li><a href=\"#%E9%80%A0%E6%95%B0%E6%8D%AE\">造数据</a></li>\n<li><a href=\"#query\">Query</a>\n<ul>\n<li><a href=\"#boolquery\">BoolQuery</a></li>\n<li><a href=\"#mathquery\">MathQuery</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></li>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>最近看到一个库<code class=\"language-text\">https://github.com/aquasecurity/esquery/</code>，在这里简单介绍下</p>\n<h1 id=\"es\" style=\"position:relative;\"><a href=\"#es\" aria-label=\"es permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ES</h1>\n<p>elasticsearch(简称 es)，才被用来搜索引擎，也常被用来搭建 ELK(Elasticsearch + Logstash + Kibana)\nes 提供了简单的 restful api 去操作。本文重点在于用 go 的第三方包操作 es。</p>\n<h2 id=\"安装\" style=\"position:relative;\"><a href=\"#%E5%AE%89%E8%A3%85\" aria-label=\"安装 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装</h2>\n<p>在 macos 上安装可以使用以下两条命令</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\nbrew tap elastic/tap\n\nbrew install elastic/tap/elasticsearch-full</code></pre></div>\n<h2 id=\"运行\" style=\"position:relative;\"><a href=\"#%E8%BF%90%E8%A1%8C\" aria-label=\"运行 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>运行</h2>\n<p>先启动服务，后运行二进制文件</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// 启动服务\nbrew services start elastic/tap/elasticsearch-full\n// 运行\nelasticsearch</code></pre></div>\n<h1 id=\"简单使用\" style=\"position:relative;\"><a href=\"#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8\" aria-label=\"简单使用 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>简单使用</h1>\n<p>先介绍几个 es 的概念，\nindex: 索引，相当于 mysql 的数据库\ntype(mapping): 文档类型，相当于 mysql 的表\ndocument: 文档，相当于 mysql 中的行\nfield: 文档中的一个字段\nshards: 分片\nreplica: 副本</p>\n<p>每一个 index，会被拆分到 shards，replica 是用来恢复丢失的 shards</p>\n<p>这里安装的是 es7.0，type 默认是_doc，一个分片、一个副本</p>\n<h2 id=\"造数据\" style=\"position:relative;\"><a href=\"#%E9%80%A0%E6%95%B0%E6%8D%AE\" aria-label=\"造数据 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>造数据</h2>\n<p>这里简单的介绍下 esquery 这个库，看名字就知道它只支持 query。</p>\n<p>查询首先要创建一个 es 的客户端，通过官方提供的 go 包\n这里我们使用[HTTPie]{<a href=\"https://httpie.org/%7D\">https://httpie.org/}</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// 安装HTTPie\nbrew install httpie\n\n// 创建index\nhttp PUT :9200/book\n\n// 创建mapping\nhttp PUT :9200/book/_mapping properties:='{\"tags\":{\"type\":\"text\"},\"publish\":{\"type\":\"date\"},\"title\":{\"type\":\"text\"}}'\n\n// 创建document\nhttp POST :9200/book/_doc title=\"The Go Programming Language\" post_date=\"2015-11-16T\" tags=\"go\"\nhttp POST :9200/book/_doc title=\"Mastering Go\" post_date=\"2019-08-29T\" tags=\"go\"\nhttp POST :9200/book1/_doc title=\"fluent python\" post_date=\"2015-07-30T\" tags=\"python code\"</code></pre></div>\n<h2 id=\"query\" style=\"position:relative;\"><a href=\"#query\" aria-label=\"query permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query</h2>\n<p>首先需要创建一个 es 客户端，然后通过 esquery 构建一个 Query，然后指定具体的查询类型和查询条件</p>\n<div class=\"gatsby-highlight\" data-language=\"golang\"><pre class=\"language-golang\"><code class=\"language-golang\">package main\n\nimport (\n\t&quot;context&quot;\n\t&quot;log&quot;\n\n\t&quot;github.com/aquasecurity/esquery&quot;\n\t&quot;github.com/elastic/go-elasticsearch/v7&quot;\n)\n\nfunc main() {\n    // connect to an ElasticSearch instance\n\tes, err := elasticsearch.NewDefaultClient()\n\tif err != nil {\n\t\tlog.Fatalf(&quot;Failed creating client: %s&quot;, err)\n\t}\n}</code></pre></div>\n<h3 id=\"boolquery\" style=\"position:relative;\"><a href=\"#boolquery\" aria-label=\"boolquery permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BoolQuery</h3>\n<div class=\"gatsby-highlight\" data-language=\"golang\"><pre class=\"language-golang\"><code class=\"language-golang\">qRes, err := esquery.Query(\n\t\tesquery.\n\t\t\tBool().\n\t\t\tMust(esquery.Term(&quot;title&quot;, &quot;go&quot;)).\n\t\t\tFilter(esquery.Term(&quot;tag&quot;, &quot;go&quot;)),\n    ).Run(\n        es,\n\t\tes.Search.WithContext(context.TODO()),\n\t\tes.Search.WithIndex(&quot;book&quot;),\n\t)\n\tif err != nil {\n\t\tlog.Fatalf(&quot;Failed searching for stuff: %s&quot;, err)\n\t}\n\n\tdefer qRes.Body.Close()</code></pre></div>\n<h3 id=\"mathquery\" style=\"position:relative;\"><a href=\"#mathquery\" aria-label=\"mathquery permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MathQuery</h3>\n<div class=\"gatsby-highlight\" data-language=\"golang\"><pre class=\"language-golang\"><code class=\"language-golang\">qRes, _ := esquery.Query(\n\t\tesquery.\n\t\t\tMatch(&quot;title&quot;, &quot;go&quot;),\n\t).Run(\n\t\tes,\n\t\tes.Search.WithIndex(&quot;book&quot;),\n\t)\n\tdefer qRes.Body.Close()</code></pre></div>\n<p>然后可以通过 qRes.String()获取到数据</p>\n<h1 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h1>\n<p>这里只是简单的介绍下 es query，推荐看一下下面的 reference，及官方文档</p>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://github.com/aquasecurity/esquery/\">https://github.com/aquasecurity/esquery/</a></li>\n<li><a href=\"https://laisky.com/p/elasticsearch-quickstart/\">https://laisky.com/p/elasticsearch-quickstart/</a></li>\n<li><a href=\"https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html\">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a></li>\n<li><a href=\"https://strconv.com/posts/use-elastic/\">https://strconv.com/posts/use-elastic/</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#es\">ES</a></p>\n<ul>\n<li><a href=\"#%E5%AE%89%E8%A3%85\">安装</a></li>\n<li><a href=\"#%E8%BF%90%E8%A1%8C\">运行</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8\">简单使用</a></p>\n<ul>\n<li>\n<p><a href=\"#%E9%80%A0%E6%95%B0%E6%8D%AE\">造数据</a></p>\n</li>\n<li>\n<p><a href=\"#query\">Query</a></p>\n<ul>\n<li><a href=\"#boolquery\">BoolQuery</a></li>\n<li><a href=\"#mathquery\">MathQuery</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></p>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"es-query使用","date":"2020-03-10"}}},"pageContext":{"slug":"/2020-03-10-es.markdown"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}