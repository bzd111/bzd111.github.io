{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-09-08-aws-k8s-build.markdown/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc Redcarpet -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#%E5%87%86%E5%A4%87\">准备</a></li>\n<li><a href=\"#%E9%83%A8%E7%BD%B2\">部署</a>\n<ul>\n<li><a href=\"#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91\">划分子网</a></li>\n<li><a href=\"#%E9%83%A8%E7%BD%B2-master\">部署 Master</a></li>\n<li><a href=\"#%E5%88%9B%E5%BB%BA-nodegroup\">创建 NodeGroup</a></li>\n</ul>\n</li>\n<li><a href=\"#alb-%E9%85%8D%E7%BD%AE\">Alb 配置</a></li>\n<li><a href=\"#%E7%9B%91%E6%8E%A7\">监控</a>\n<ul>\n<li><a href=\"#%E9%83%A8%E7%BD%B2\">部署</a></li>\n<li><a href=\"#%E6%8C%81%E4%B9%85%E5%8C%96\">持久化</a>\n<ul>\n<li><a href=\"#prometheus\">prometheus</a></li>\n<li><a href=\"#grafana\">grafana</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#%E5%B0%8F%E7%BB%93\">小结</a></li>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>用了 aws 也有一段时间了，记录下用 cli 命令，创建托管 k8s 集群</p>\n<h1 id=\"准备\" style=\"position:relative;\"><a href=\"#%E5%87%86%E5%A4%87\" aria-label=\"准备 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>准备</h1>\n<ol>\n<li>安装 eksctl</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">brew tap weaveworks/tap\nbrew <span class=\"token function\">install</span> weaveworks/tap/eksctl</code></pre></div>\n<p>更多安装请看<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/eksctl.html#installing-eksctl\">链接</a></p>\n<ol start=\"2\">\n<li>安装 awscli</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">pip <span class=\"token function\">install</span> awscli</code></pre></div>\n<ol start=\"3\">\n<li>配置权限\n根据提示输入 aws ak，配置文件保存在家目录下的.aws 文件下</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">aws configure</code></pre></div>\n<ol start=\"4\">\n<li>验证权限\n有返回用户信息，就说明权限</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws sts get-caller-identity</code></pre></div>\n<h1 id=\"部署\" style=\"position:relative;\"><a href=\"#%E9%83%A8%E7%BD%B2\" aria-label=\"部署 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>部署</h1>\n<h2 id=\"划分子网\" style=\"position:relative;\"><a href=\"#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91\" aria-label=\"划分子网 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>划分子网</h2>\n<p>建议：分散可用区，子网范围尽量大(aws 的 eks node 和 pod 网段是同层的，每个 node 会预留 30 个 ip)</p>\n<p>一般分在 3 个可用区里，如</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pub-1a subnet-111111111111\npub-1b subnet-222222222222\npub-1c subnet-333333333333</code></pre></div>\n<p>为每个子网打上标签(cluster-name 要统一)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubernetes.io/cluster/cluster-name:shared\nkubernetes.io/role/elb:1</code></pre></div>\n<h2 id=\"部署-master\" style=\"position:relative;\"><a href=\"#%E9%83%A8%E7%BD%B2-master\" aria-label=\"部署 master permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>部署 Master</h2>\n<p>create-cluster.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> eksctl.io/v1alpha5\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterConfig\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>name\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>south<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.17\"</span>\n<span class=\"token key atrule\">vpc</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">subnets</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">public</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ap-south-1a</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">111111111111</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">ap-south-1b</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">222222222222</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">ap-south-1c</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">333333333333</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>创建集群</p>\n<p><code class=\"language-text\">eksctl create cluster -f create-cluster.yaml</code></p>\n<h2 id=\"创建-nodegroup\" style=\"position:relative;\"><a href=\"#%E5%88%9B%E5%BB%BA-nodegroup\" aria-label=\"创建 nodegroup permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建 NodeGroup</h2>\n<p>create-nodegroup.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> eksctl.io/v1alpha5\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterConfig\n\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>name\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>south<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.17\"</span>\n\n<span class=\"token key atrule\">vpc</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">subnets</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">public</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ap-south-1a</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">111111111111</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">ap-south-1b</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">222222222222</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">ap-south-1c</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span><span class=\"token number\">333333333333</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">securityGroup</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sg-05067cf3f9fee95c8\"</span>\n<span class=\"token key atrule\">managedNodeGroups</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ng<span class=\"token punctuation\">-</span>workers<span class=\"token punctuation\">-</span><span class=\"token number\">0</span> <span class=\"token comment\"># 指定名称</span>\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> workers <span class=\"token punctuation\">}</span> <span class=\"token comment\"># 打标签</span>\n    <span class=\"token key atrule\">instanceType</span><span class=\"token punctuation\">:</span> m5.2xlarge <span class=\"token comment\"># 指定机型</span>\n    <span class=\"token key atrule\">desiredCapacity</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span> <span class=\"token comment\"># 下面三行和autoScaler有关</span>\n    <span class=\"token key atrule\">minSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token key atrule\">maxSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">40</span>\n    <span class=\"token key atrule\">volumeSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodegroup-role</span><span class=\"token punctuation\">:</span> worker\n    <span class=\"token key atrule\">iam</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">withAddonPolicies</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">autoScaler</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">cloudWatch</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">albIngress</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">ssh</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">publicKeyName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node-key\"</span> <span class=\"token comment\"># 指定ec2上密钥对名称，需提前创建</span></code></pre></div>\n<p>执行文件\n<code class=\"language-text\">eksctl create nodegroup -f create-nodegroup.yaml</code></p>\n<h1 id=\"alb-配置\" style=\"position:relative;\"><a href=\"#alb-%E9%85%8D%E7%BD%AE\" aria-label=\"alb 配置 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alb 配置</h1>\n<p>具体看一下这个<a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html\">文档</a>讲的很详细</p>\n<p>配置文件，可以在<a href=\"https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/\">文档</a>上看到更多用法，如访问日志放到 s3(通过 logstash 同步到 es,然后通过 kibana 展示)、添加证书、健康检查等</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ingress\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> alb\n    <span class=\"token key atrule\">alb.ingress.kubernetes.io/scheme</span><span class=\"token punctuation\">:</span> internet<span class=\"token punctuation\">-</span>facing\n    <span class=\"token key atrule\">alb.ingress.kubernetes.io/actions.service-1</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      {\"Type\":\"forward\",\"ForwardConfig\":{\"TargetGroups\":[{\"ServiceName\":\"service-1\",\"ServicePort\":\"8080\",\"Weight\":98}],\"TargetGroupStickinessConfig\":{\"Enabled\":false}}}</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /path\n            <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n              <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> use<span class=\"token punctuation\">-</span>annotation</code></pre></div>\n<h1 id=\"监控\" style=\"position:relative;\"><a href=\"#%E7%9B%91%E6%8E%A7\" aria-label=\"监控 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>监控</h1>\n<p>采用开源的<a href=\"https://github.com/prometheus-operator/kube-prometheus\">kube-prometheus</a></p>\n<h2 id=\"部署-1\" style=\"position:relative;\"><a href=\"#%E9%83%A8%E7%BD%B2-1\" aria-label=\"部署 1 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>部署</h2>\n<p>在<code class=\"language-text\">kube-prometheus/manifests</code>下直接执行<code class=\"language-text\">kubectl apply -f .</code>即可</p>\n<h2 id=\"持久化\" style=\"position:relative;\"><a href=\"#%E6%8C%81%E4%B9%85%E5%8C%96\" aria-label=\"持久化 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>持久化</h2>\n<h3 id=\"prometheus\" style=\"position:relative;\"><a href=\"#prometheus\" aria-label=\"prometheus permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>prometheus</h3>\n<p>在<code class=\"language-text\">kube-prometheus/manifests/prometheus-prometheus.yaml</code>中添加下文+开头部分，storageClassName 使用 aws eks 自带的 gp2</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> monitoring.coreos.com/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Prometheus\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span> k8s\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> k8s\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> monitoring\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">alerting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">alertmanagers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alertmanager<span class=\"token punctuation\">-</span>main\n      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> monitoring\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> web\n<span class=\"token key atrule\">+ storage</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">+   volumeClaimTemplate</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">+     spec</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">+       storageClassName</span><span class=\"token punctuation\">:</span> gp2\n<span class=\"token key atrule\">+       resources</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">+         requests</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">+           storage</span><span class=\"token punctuation\">:</span> 500Gi\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> quay.io/prometheus/prometheus<span class=\"token punctuation\">:</span>v2.20.0\n  <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kubernetes.io/os</span><span class=\"token punctuation\">:</span> linux\n  <span class=\"token key atrule\">podMonitorNamespaceSelector</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">podMonitorSelector</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 400Mi\n  <span class=\"token key atrule\">ruleSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span> k8s\n      <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> alert<span class=\"token punctuation\">-</span>rules\n  <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">fsGroup</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2000</span>\n    <span class=\"token key atrule\">runAsNonRoot</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">runAsUser</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n  <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> prometheus<span class=\"token punctuation\">-</span>k8s\n  <span class=\"token key atrule\">serviceMonitorNamespaceSelector</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">serviceMonitorSelector</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v2.20.0</code></pre></div>\n<h3 id=\"grafana\" style=\"position:relative;\"><a href=\"#grafana\" aria-label=\"grafana permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>grafana</h3>\n<p>先创建 pvc，使用 aws eks 自带的 gp2</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>pvc\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> monitoring\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ReadWriteOnce\"</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> gp2\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 100Gi</code></pre></div>\n<p>在<code class=\"language-text\">kube-prometheus/manifests/grafana-deployment.yaml</code>中在相应部分替换</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">emptyDir</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>storage</code></pre></div>\n<p>替换成下面的</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>storage\n    <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>pvc</code></pre></div>\n<h1 id=\"小结\" style=\"position:relative;\"><a href=\"#%E5%B0%8F%E7%BB%93\" aria-label=\"小结 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>小结</h1>\n<p>到此，集群就搭建完成</p>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://eksctl.io/usage/creating-and-managing-clusters/\">https://eksctl.io/usage/creating-and-managing-clusters/</a></li>\n<li><a href=\"https://eksctl.io/usage/managing-nodegroups/\">https://eksctl.io/usage/managing-nodegroups/</a></li>\n<li><a href=\"https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html\">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html</a></li>\n<li><a href=\"https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/\">https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%87%86%E5%A4%87\">准备</a></p>\n</li>\n<li>\n<p><a href=\"#%E9%83%A8%E7%BD%B2\">部署</a></p>\n<ul>\n<li><a href=\"#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91\">划分子网</a></li>\n<li><a href=\"#%E9%83%A8%E7%BD%B2-master\">部署 Master</a></li>\n<li><a href=\"#%E5%88%9B%E5%BB%BA-nodegroup\">创建 NodeGroup</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#alb-%E9%85%8D%E7%BD%AE\">Alb 配置</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%9B%91%E6%8E%A7\">监控</a></p>\n<ul>\n<li>\n<p><a href=\"#%E9%83%A8%E7%BD%B2-1\">部署</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%8C%81%E4%B9%85%E5%8C%96\">持久化</a></p>\n<ul>\n<li><a href=\"#prometheus\">prometheus</a></li>\n<li><a href=\"#grafana\">grafana</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%B0%8F%E7%BB%93\">小结</a></p>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"aws eks搭建","date":"2020-09-08"}}},"pageContext":{"slug":"/2020-09-08-aws-k8s-build.markdown"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}