{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-12-03-everything_could_exporter.markdown/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc Redcarpet -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#exporter\">exporter</a>\n<ul>\n<li><a href=\"#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B\">指标类型</a></li>\n<li><a href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\">代码实现</a>\n<ul>\n<li><a href=\"#describe\">Describe</a>\n<ul>\n<li><a href=\"#%F0%9F%8C%B0\">🌰</a></li>\n</ul>\n</li>\n<li><a href=\"#collect\">Collect</a>\n<ul>\n<li><a href=\"#%F0%9F%8C%B0\">🌰</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#%E6%9F%A5%E8%AF%A2%E6%8C%87%E6%A0%87\">查询指标</a></li>\n<li><a href=\"#%E5%B1%95%E7%A4%BA%E6%8C%87%E6%A0%87\">展示指标</a></li>\n</ul>\n</li>\n<li><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></li>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<p>创建一个简单的 prometheus exporter</p>\n<h1 id=\"exporter\" style=\"position:relative;\"><a href=\"#exporter\" aria-label=\"exporter permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>exporter</h1>\n<p>建议阅读本文前，建议新手先看一下<a href=\"https://github.com/yolossn/Prometheus-Basics/blob/master/README.md\">Prometheus-Basics</a></p>\n<p>官方实现了 4 个 client，(Go，Java or Scala，Python，Ruby)，我决定使用 Go 实现</p>\n<h2 id=\"指标类型\" style=\"position:relative;\"><a href=\"#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B\" aria-label=\"指标类型 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>指标类型</h2>\n<p>指标上传的 4 种方式，Counter、Gauge、Histogram、Summary</p>\n<p>1.Counter\ncounter 记录的指标值只能增加或重置为 0。比如请求的数量，错误的数量。</p>\n<p>2.Gauge\ngauge 记录的指标值能增加、能减少。比如当前集群内的 pod 数据，队列里事件的数量。</p>\n<p>3.Histogram\nhistogram 记录的指标值，会落在预先划好的区间里，然后将记录值放入对应的区间。比如请求时间的区间的中位值、平均值，cpu 温度的中位值、平均值。</p>\n<p>4.Summary\nsummary 记录的指标值和 histogram 类似，预先不知道对应的区间，可以使用 summary 记录。</p>\n<h2 id=\"代码实现\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\" aria-label=\"代码实现 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代码实现</h2>\n<p>主要分为两块，</p>\n<p>1、指标的定义\n2、指标采集逻辑</p>\n<p>exporter 只要实现<code class=\"language-text\">Collect</code>和<code class=\"language-text\">Describe</code>两个 method 即可</p>\n<h3 id=\"describe\" style=\"position:relative;\"><a href=\"#describe\" aria-label=\"describe permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Describe</h3>\n<p>负责指标的定义，函数入参是*prometheus.Desc 的单向通道，\n<code class=\"language-text\">func (e *Exporter) Describe(ch chan&lt;- \\*prometheus.Desc)</code></p>\n<p><code class=\"language-text\">func NewDesc(fqName, help string, variableLabels []string, constLabels Labels) *Desc</code>\n指标可以通过 prometheus.NewDesc 生成出来，需要传入参数</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fqName 指标名\nhelp 帮助信息\nvariableLabels  指标的标签\nconstLabels 固定标签</code></pre></div>\n<p>标签名可以通过 prometheus.BuildFQName 构建，函数的作用是_连接非空的入参</p>\n<p><code class=\"language-text\">func BuildFQName(namespace, subsystem, name string) string</code>，</p>\n<h4 id=\"\" style=\"position:relative;\"><a href=\"#\" aria-label=\" permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🌰</h4>\n<div class=\"gatsby-highlight\" data-language=\"golang\"><pre class=\"language-golang\"><code class=\"language-golang\">func (e *Exporter) Describe(ch chan&lt;- *prometheus.Desc) {\n    desc := prometheus.NewDesc(prometheus.BuildFQName(&quot;redis&quot;, &quot;&quot;, &quot;metricName&quot;), &quot;Number of receieved bytes&quot;, []string{&quot;target&quot;}, nil)\n\tch &lt;- desc()\n}</code></pre></div>\n<h3 id=\"collect\" style=\"position:relative;\"><a href=\"#collect\" aria-label=\"collect permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Collect</h3>\n<p>负责采集指标，函数入参是*prometheus.Metrics 的单向通道\n<code class=\"language-text\">func (e *Exporter) Collect(ch chan&lt;- \\*prometheus.Metrics)</code></p>\n<p>Metrics 需要实现<code class=\"language-text\">Desc() *Desc</code>和<code class=\"language-text\">Write(*dto.Metric) error</code>两个接口</p>\n<p>采集逻辑需要自己根据被采集提供的方式，进行封装</p>\n<h4 id=\"-1\" style=\"position:relative;\"><a href=\"#-1\" aria-label=\" 1 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🌰</h4>\n<div class=\"gatsby-highlight\" data-language=\"golang\"><pre class=\"language-golang\"><code class=\"language-golang\">func (e *Exporter) Collect(ch chan&lt;- prometheus.Metric){\n    desc := prometheus.NewDesc(prometheus.BuildFQName(&quot;redis&quot;, &quot;&quot;, &quot;metricName&quot;), &quot;Number of receieved bytes&quot;, []string{&quot;target&quot;}, nil)\n    m, _:= prometheus.NewConstMetric(desc, prometheus.CounterValue, val, labelValues...)\n\tch &lt;- m\n}</code></pre></div>\n<h2 id=\"查询指标\" style=\"position:relative;\"><a href=\"#%E6%9F%A5%E8%AF%A2%E6%8C%87%E6%A0%87\" aria-label=\"查询指标 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>查询指标</h2>\n<p>这时候指标已经进入到 promethus 了，然后可以通过<code class=\"language-text\">promql</code>进行查询了，</p>\n<p><a href=\"https://prometheus.io/docs/prometheus/latest/querying/basics/\">基本的查询教程</a></p>\n<p>有一些常用的函数，需要了解下</p>\n<p>rate 常用来 counter 指标类型的增长速率</p>\n<p>max_over_time、min_over_time、avg_over_time 常用来查询 gauge 的指标类型</p>\n<p>查询命令也可以和 lable 互动，</p>\n<h2 id=\"展示指标\" style=\"position:relative;\"><a href=\"#%E5%B1%95%E7%A4%BA%E6%8C%87%E6%A0%87\" aria-label=\"展示指标 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>展示指标</h2>\n<p>指标最后会在 granafa 里展示，汇聚成一个 dashboard，可以保存为一个 json 文件，到处使用。\n官方和社区维护很多<a href=\"https://grafana.com/grafana/dashboards\">dashboards</a>，自己多玩玩就知道了。</p>\n<p>granfana 里需要配置 promethus 的数据源，一般都是一个 granfana 和一个 promethus 单独配对。</p>\n<p>dashboard 里还可以配置变量，然后在 dashboard 里，根据变量选择不同的值，展示不同的数据\ngranfana 本身也是可以配置变量的</p>\n<h1 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h1>\n<p>整个流程是一环套一环。 1.采集指标 2.查询指标 3.绘制 dashboard</p>\n<p>最好自己实现一个 exporter，走一遍流程，granfana、promethus 可以用 docker 启动，简单玩玩。</p>\n<p>我可以参考<a href=\"https://github.com/wi1dcard/v2ray-exporter\">v2ray-exporter</a>，实现了一个<a href=\"https://github.com/bzd111/trojan-go-exporter\">trojan-go-exporter</a></p>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://prometheus.io/docs/instrumenting/writing_exporters/\">https://prometheus.io/docs/instrumenting/writing_exporters/</a></li>\n<li><a href=\"https://prometheus.io/docs/prometheus/latest/querying/examples/\">https://prometheus.io/docs/prometheus/latest/querying/examples/</a></li>\n<li><a href=\"https://github.com/wi1dcard/v2ray-exporter\">https://github.com/wi1dcard/v2ray-exporter</a></li>\n<li><a href=\"https://github.com/bzd111/trojan-go-exporter\">https://github.com/bzd111/trojan-go-exporter</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#exporter\">exporter</a></p>\n<ul>\n<li>\n<p><a href=\"#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B\">指标类型</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\">代码实现</a></p>\n<ul>\n<li>\n<p><a href=\"#describe\">Describe</a></p>\n<ul>\n<li><a href=\"#\">🌰</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#collect\">Collect</a></p>\n<ul>\n<li><a href=\"#-1\">🌰</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%9F%A5%E8%AF%A2%E6%8C%87%E6%A0%87\">查询指标</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B1%95%E7%A4%BA%E6%8C%87%E6%A0%87\">展示指标</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></p>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"万物皆可exporter","date":"2020-12-03"}}},"pageContext":{"slug":"/2020-12-03-everything_could_exporter.markdown"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}