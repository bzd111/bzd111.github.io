{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-02-13-argo-ci-cd/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"argo-cicd\" style=\"position:relative;\"><a href=\"#argo-cicd\" aria-label=\"argo cicd permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>argo ci/cd</h1>\n<p>从一个<a href=\"https://github.com/pipekit/argo-workflows-ci-example\">demo</a>开始，由于一些网络问题，镜像拉取不下来，可以看我之前的 blog 解决。</p>\n<h1 id=\"注意\" style=\"position:relative;\"><a href=\"#%E6%B3%A8%E6%84%8F\" aria-label=\"注意 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>注意</h1>\n<p>项目里有一些应用是 kustomization 和 helm 安装的，由于网络原因，安装会失败。我使用下面的命令，生成了最终的 yaml。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kustomize build <span class=\"token builtin class-name\">.</span> <span class=\"token operator\">></span> output.yaml\nhelm template <span class=\"token builtin class-name\">.</span> <span class=\"token operator\">></span> output.yaml</code></pre></div>\n<h1 id=\"开始\" style=\"position:relative;\"><a href=\"#%E5%BC%80%E5%A7%8B\" aria-label=\"开始 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>开始</h1>\n<p>整个项目目录结构是这样。入口文件是 setup.sh。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">├── argo.yaml\n├── assets\n│   └── images\n├── bootstrap\n│   ├── applications\n│   ├── applications<span class=\"token punctuation\">-</span>rollouts\n│   ├── app<span class=\"token punctuation\">-</span>of<span class=\"token punctuation\">-</span>apps\n│   ├── app<span class=\"token punctuation\">-</span>of<span class=\"token punctuation\">-</span>apps<span class=\"token punctuation\">-</span>rollouts\n│   ├── argocd\n│   ├── argo<span class=\"token punctuation\">-</span>rollouts\n│   ├── argo<span class=\"token punctuation\">-</span>workflows\n│   ├── final<span class=\"token punctuation\">-</span>application\n│   ├── ingress<span class=\"token punctuation\">-</span>nginx\n│   ├── k3d.conf\n│   ├── minio\n│   ├── nfs<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>provisioner\n│   ├── output.yaml\n│   └── workflow<span class=\"token punctuation\">-</span>templates\n├── CI\n│   ├── Dockerfile\n│   └── index.html\n├── hera\n│   └── nfs\n├── LICENSE\n├── output.yaml\n├── README.md\n├── renovate.json\n├── rollouts<span class=\"token punctuation\">-</span>workflow<span class=\"token punctuation\">-</span>2.yml\n├── rollouts<span class=\"token punctuation\">-</span>workflow<span class=\"token punctuation\">-</span>s3<span class=\"token punctuation\">-</span>2.yml\n├── rollouts<span class=\"token punctuation\">-</span>workflow<span class=\"token punctuation\">-</span>s3.yml\n├── rollouts<span class=\"token punctuation\">-</span>workflow.yml\n├── setup.sh\n├── workflow<span class=\"token punctuation\">-</span>s3.yml\n└── workflow.yml</code></pre></div>\n<p>看一下 setup.sh 的内容。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\nk3d cluster delete workflows-ci <span class=\"token operator\">||</span> <span class=\"token boolean\">true</span>\nk3d cluster create <span class=\"token parameter variable\">--config</span> bootstrap/k3d.conf\n\n<span class=\"token comment\"># Prevent users from accidentally deploying to the wrong cluster.</span>\n<span class=\"token assign-left variable\">currentContext</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl config current-context<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$currentContext</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"k3d-workflows-ci\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Starting deployment to cluster...\"</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"The kubectl context is not what we expected. Exiting for safety. Perhaps the k3d cluster failed to create?\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># Deploy Argo CD, which in turn deploys everything else</span>\nkubectl <span class=\"token parameter variable\">-n</span> kube-system rollout status deployment/metrics-server\nkubectl apply <span class=\"token parameter variable\">-k</span> bootstrap/argocd\nkubectl <span class=\"token parameter variable\">-n</span> argocd rollout status statefulset/argocd-application-controller\nkubectl <span class=\"token parameter variable\">-n</span> argocd rollout status deployment/argocd-repo-server\nkubectl <span class=\"token parameter variable\">-n</span> argocd apply <span class=\"token parameter variable\">-f</span> bootstrap/app-of-apps<span class=\"token string\">\"<span class=\"token variable\">${1}</span>\"</span>\n\n<span class=\"token comment\"># Create 'final-application' namespace for the final application</span>\nkubectl create namespace final-application\n\n<span class=\"token comment\"># Wait for Argo CD to start syncing its new-found applications</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">30</span>\nkubectl <span class=\"token parameter variable\">-n</span> nfs-server-provisioner rollout status statefulset/nfs-server-provisioner\nkubectl <span class=\"token parameter variable\">-n</span> ingress-nginx rollout status deployment/nginx-ingress-nginx-controller\nkubectl <span class=\"token parameter variable\">-n</span> ingress-nginx rollout status daemonset/svclb-nginx-ingress-nginx-controller\nkubectl <span class=\"token parameter variable\">-n</span> argo rollout status deployment/workflow-controller\nkubectl <span class=\"token parameter variable\">-n</span> argo rollout status deployment/argo-server\nkubectl <span class=\"token parameter variable\">-n</span> minio rollout status deployment/minio\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Complete. You should be able to navigate to https://localhost:8443/argo/workflows/argo in your browser now. (Remember to accept the self-signed SSL cert).\"</span></code></pre></div>\n<p>setup.sh 会部署一个 k3s 的集群，然后部署 kubectl apply -k bootstrap/argocd，会把 argocd 部署起来，</p>\n<p>再通过<code class=\"language-text\">kubectl -n argocd apply -f bootstrap/app-of-apps</code>部署一个 Application，</p>\n<p>这个 Application 会 bootstrap/applications-rollouts 下的 6 个 Application 启动起来。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ tree <span class=\"token parameter variable\">-L</span> <span class=\"token number\">2</span> bootstrap/applications-rollouts\nbootstrap/applications-rollouts\n├── argocd.yml\n├── argo-rollouts.yml\n├── argo-workflows-templates.yml\n├── argo-workflows.yml\n├── minio.yml\n└── nginx.yml</code></pre></div>\n<p>应用分别对应下面的文件的内容，就是定义了这些 Application。原来的仓库是有 nfs 的，我部署不成功，然后手动安装了<a href=\"https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/example/nfs-provisioner/README.md\">nfs</a>，所以会比官方少一个。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bootstrap/argocd\nbootstrap/argo-rollouts\nbootstrap/workflow-templates\nbootstrap/argo-workflows\nbootstrap/minio\nbootstrap/ingress-nginx</code></pre></div>\n<p>你也可以使用自己的集群，直接去执行然后下面两个命令。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-k</span> bootstrap/argocd\nkubectl <span class=\"token parameter variable\">-n</span> argocd apply <span class=\"token parameter variable\">-f</span> bootstrap/app-of-apps</code></pre></div>\n<p>通过 port-forward 转发就可以在浏览器看到页面了。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">k port-forward services/argocd-server <span class=\"token parameter variable\">--address</span> <span class=\"token number\">0.0</span>.0.0 <span class=\"token number\">8443</span>:443\nk port-forward services/argo-server <span class=\"token parameter variable\">--address</span> <span class=\"token number\">0.0</span>.0.0 <span class=\"token number\">8843</span>:2746</code></pre></div>\n<p>初始化完成应该可以看到这几个 application</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2494cd92ee40c750f8613a560b608232/9b641/argo_image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.852760736196316%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/klEQVR42jVSiXLaMBT0//9Wpw0dDhNCICkGgm184VOW5TvblWg1s2Np9d5qtbK18V28Bj524R3bu4+V50Jz9t17ctxbcb32b7D51TWvoY+1F2DlZrC9HEs3x+KWYXl7wErLErmsUXcKVdfhmpbIqhIJ+apt0PQd3CJHmGeI8hwP7rVjD68sEBWCvQpl07FuRKl6WE2jkLG573t0w4SwkOjaFnkpIKTEPM2IhUBVS6I2mMYJSS1Qywal2ROsG9G0HSzJQkEMFOzHGQEFm6aBJDo6/p6/EbMhryrowxUPm+cZCW9VUExSVHPTNEH1A6yFvcdi+45fmzeUtH+NMqx2R7zYb/i53iFOc0QU+/16wJL4sdziyw+RNRK7zzNeNs+6w+mKWtFhnBYQTctFawRvyQNBnCLJK1MgCZ+iXvSgI4my1u5bcgL3JGNcgpwyGlklYelrCV5vMBkOCBm25io66LreXC8SFSrmWcn/GQ503TJjRfHnG+ivyVApTgjd2DHsUL8iMzG5jiP00A+gBU1WrNMjFlqwMXlrA3ooGrD+nL/w+Q/twN8hS+FcXRydC3E1L5nQ1fF8Nfz+00GaF8jUiIsb4IM1h9MFXhA9BdcHB/bHGZvjGfdHjnMQwz7qtWO4rzCBG2dmvv24YP1+guOGzLDE3rlB92+I48VDkBb4C18v7n9i8QJeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/2494cd92ee40c750f8613a560b608232/a6d36/argo_image.png\"\n        srcset=\"/static/2494cd92ee40c750f8613a560b608232/222b7/argo_image.png 163w,\n/static/2494cd92ee40c750f8613a560b608232/ff46a/argo_image.png 325w,\n/static/2494cd92ee40c750f8613a560b608232/a6d36/argo_image.png 650w,\n/static/2494cd92ee40c750f8613a560b608232/e548f/argo_image.png 975w,\n/static/2494cd92ee40c750f8613a560b608232/3c492/argo_image.png 1300w,\n/static/2494cd92ee40c750f8613a560b608232/9b641/argo_image.png 3588w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>也可以点卡片进去看到详情。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0cc32814c1b053cd470825016965937/0a758/argo_image_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABX0lEQVR42pWS2W6DMBRE+f+vq6omapMCWQzEu1kTqVGmY8NDH6rQIo2wDffYM77Z60eOg2jwnh/wtiuoHC/bHTYcb/clNvsCX/c7nj3T9QbpW4Txiqw2BjoEnOoG2jh0/YBxuuJsNIRSsC7gvgJ8PB5J8clG0qfbDdp5XAh03YB+4jz0qLSDtC0Mx74fVzSld3a8WAjtcZIWRa3xWamkOK+4XpmAPK6JvynLCYkFeaUTMI4PjYHp+nTSjrmUaZ2qZxVPlP36gcWN9XBtD+ValI3GWdGJcqh54n8B8wV41haGQNsOXFeMxRHeMQL/T+Bi/eJDshyGcc6W+eyFpNQ6sEwyS5YsoGreuCFUsW3i92Q5XZRjBOY5cN5Z4siCk3QJKmjZ0rK0c2bx1mW0rFcsx902pcD2IFIfKd/NlnmywCaPfRn/yZd2Sg5WLTd6tlHFrGQqqmjZE6a5wVqr/AR+AxrJf6jOvrIwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/f0cc32814c1b053cd470825016965937/a6d36/argo_image_1.png\"\n        srcset=\"/static/f0cc32814c1b053cd470825016965937/222b7/argo_image_1.png 163w,\n/static/f0cc32814c1b053cd470825016965937/ff46a/argo_image_1.png 325w,\n/static/f0cc32814c1b053cd470825016965937/a6d36/argo_image_1.png 650w,\n/static/f0cc32814c1b053cd470825016965937/e548f/argo_image_1.png 975w,\n/static/f0cc32814c1b053cd470825016965937/3c492/argo_image_1.png 1300w,\n/static/f0cc32814c1b053cd470825016965937/0a758/argo_image_1.png 3604w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c5b4e0279dd2505d427d63979232928c/75ac7/argo_image_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.89570552147239%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABQklEQVR42p2SW3PCIBSE8///XR9aZ7ylagwBAgTIxdTq9gDxoZc41czsMCzh47CHbJEfsCsqvC63eFuRaHxZLKd5HnU+f+Ledxo/wLWFch0yXmsY5/BeMrBKQDcWXd/TosOWM3CpMNKG6/U6Cwxrl8sljll/GjHQBuM8mNSQxsF3J9huAFMGXDWQdLrxHZq2T/K/ZSc/23OFQhrsqhp5WWNzlFgfBaIfpbElf1VwrA5J60LMKtuUkiCCNslvqnSDth9iZTmrcTs4KMx//n9T9veCQEnZ+gkYvCPFoayHoEjyGdhdYMiv7Udo28Z5iGE9XTvE8jiQrmwp5ARMfqgsZ/OwWWDINGTYuBZ14yIkeKlK8RywDE+IoJwUvAM1paSGMGUfb0rIKjah8ahUAu4rRXBHvnmuQqYNfNvRg0/P5r9X/gK6YX/WOK4HrgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/c5b4e0279dd2505d427d63979232928c/a6d36/argo_image_2.png\"\n        srcset=\"/static/c5b4e0279dd2505d427d63979232928c/222b7/argo_image_2.png 163w,\n/static/c5b4e0279dd2505d427d63979232928c/ff46a/argo_image_2.png 325w,\n/static/c5b4e0279dd2505d427d63979232928c/a6d36/argo_image_2.png 650w,\n/static/c5b4e0279dd2505d427d63979232928c/e548f/argo_image_2.png 975w,\n/static/c5b4e0279dd2505d427d63979232928c/3c492/argo_image_2.png 1300w,\n/static/c5b4e0279dd2505d427d63979232928c/75ac7/argo_image_2.png 3600w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9835a2e3a47fb69a19a1c62bc060362c/75ac7/argo_image_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42qWS6W7CMBCE8/4v16qi5QghkMt24sQY52yB6dqhqD8ggtbSyLay/rK7s97L3McuYXhb+JgtA8xWAV4/lnhfbTD3Q7d/HY+YWm3XQygNVbfwuJSQWiPmAmWpYOoGXd8jLiXSokBFgcfTaRJ4Po+yy2v7Ae3wCVlpcKmgTIO6GyAPNZisUBCw0jU0/X1P0k3n9nvyIl5SJgqRKLHJCqzTHOskR5AW7m7lJ4LunCoxKPaGzmPMLXn2we/HtxQQcMtyHGx2pkXI7sd6U6ArkDLaZuICbCZjHwLakjepcLCS+vk0MGTSybbC9YtgW55T0xtnmv32MNAGLyOGVcyQ5hUZVl1LVmSKJFPCZzK0wMUuwyLK3LDaCRhd5zQ+xo1Q+PeSCXQZJevyOIvN/132Y0FZCWjz08P7wG924H784lMrwgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/9835a2e3a47fb69a19a1c62bc060362c/a6d36/argo_image_3.png\"\n        srcset=\"/static/9835a2e3a47fb69a19a1c62bc060362c/222b7/argo_image_3.png 163w,\n/static/9835a2e3a47fb69a19a1c62bc060362c/ff46a/argo_image_3.png 325w,\n/static/9835a2e3a47fb69a19a1c62bc060362c/a6d36/argo_image_3.png 650w,\n/static/9835a2e3a47fb69a19a1c62bc060362c/e548f/argo_image_3.png 975w,\n/static/9835a2e3a47fb69a19a1c62bc060362c/3c492/argo_image_3.png 1300w,\n/static/9835a2e3a47fb69a19a1c62bc060362c/75ac7/argo_image_3.png 3600w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d56779037cee7083d7fb9f3844deec6c/a05a9/argo_image_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVR42q2S2W6DMBBF+f/Pq5TyAMFNICzebTAkCuJ2TKP2iSRVYuloZFu+nuUmu5zhcGqRsRKfWYEd8ZFmSDOGNP8iGK7zjHtrnM5ojYMJE5JGSnBjcKwbCKng+wFhnFBKgZJzKG0xPxBcluWXJJwvmAhBDzupYXzAMF4gXY9aaHDtoNwA2493cQNFIjm0ChXXOFIsaoH8xJFX3bpvlUMjLfbr2XMkexKJD2IsbjCisw6efjR9AGv+7h6RbF10VKqmsmO5rH5VkDJupIGyfu3lWwQ7soEnG2ga0suCsZ8tTT1mKIx/Uw8pQxdGKN8/LbadYeyhseStQCXTUBr544Qb/xaMPqy4XAUllR3PSq7Im3L1bPxgS/AbSkh/h6XqAFQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/d56779037cee7083d7fb9f3844deec6c/a6d36/argo_image_4.png\"\n        srcset=\"/static/d56779037cee7083d7fb9f3844deec6c/222b7/argo_image_4.png 163w,\n/static/d56779037cee7083d7fb9f3844deec6c/ff46a/argo_image_4.png 325w,\n/static/d56779037cee7083d7fb9f3844deec6c/a6d36/argo_image_4.png 650w,\n/static/d56779037cee7083d7fb9f3844deec6c/e548f/argo_image_4.png 975w,\n/static/d56779037cee7083d7fb9f3844deec6c/3c492/argo_image_4.png 1300w,\n/static/d56779037cee7083d7fb9f3844deec6c/a05a9/argo_image_4.png 3616w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35cc04cdf951d744502d56f88b8dcc2d/2176f/argo_image_5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.78527607361963%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGklEQVR42pWRC2+DMAyE+f8/b9O2rrwKg4SShPBIoEyUm3E3aarWao30CdtyTrkjeA5TZKLCPs3wGiZ4IZ52IddvUYpddMCynHHv+OmEo+1h/YRAKE1Ni6yUqLVBNzg4PyJTNfLjEdo0WM73Bdd1ZbYT+NOMkaiNRaUtbO/hphm6GyCU4ZnpHOzg0fSO8Fz/pnUj2mHkOsgqg0JZeo1BIhSiskZU1Ijpu/Vxqbg+SIWS9krVIi4uO38RXC5dLv+QSs2wOAmmNKsai2Gc0LmJ++QGwfVgE9plEvtcctBCtywgKZKGYlBtTzuPCh4E3j8k57jZTOilpW7Q0V/c8tx2/i14bTkW35Zth3H+5PAfsnyLvNZkd+AI7u19AUWtoXWqE76BAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/35cc04cdf951d744502d56f88b8dcc2d/a6d36/argo_image_5.png\"\n        srcset=\"/static/35cc04cdf951d744502d56f88b8dcc2d/222b7/argo_image_5.png 163w,\n/static/35cc04cdf951d744502d56f88b8dcc2d/ff46a/argo_image_5.png 325w,\n/static/35cc04cdf951d744502d56f88b8dcc2d/a6d36/argo_image_5.png 650w,\n/static/35cc04cdf951d744502d56f88b8dcc2d/e548f/argo_image_5.png 975w,\n/static/35cc04cdf951d744502d56f88b8dcc2d/3c492/argo_image_5.png 1300w,\n/static/35cc04cdf951d744502d56f88b8dcc2d/2176f/argo_image_5.png 3622w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0370606aaddcab5ff077738387912ecf/91010/argo_image_6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.21472392638037%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVR42oVSi26DMBDj//9u2rpSWqAUCK8kJDxLJ9W7g3bqOrZFspSn7fPFeQ8iRGmOwzHBxgsIPl62e7ztfGz3IV53B6jagMf1esXa4H1lWxR1A0dICWkMwlSgqCSMbTAOZ2S1RljkKCuFcRzx32BShjNME6bLBzQRlaqGbjr05wtsP0BIjbRUUKaF7QY0/fgvnCiXyJRBQg8DUcFPKxzSElGuaE8j1xbHTOKQlN+RrsNZSMoZPL8jrTS5btGNZ5wKEqPzI4kzQhJ4vPuImTDMFtxVAnIZc6lti35YCHndUNnDeUImzQ8DX4Ss5sU5dicxlyfoMpeYUwy262cCJjyRs5LOle0Wx1yZWEgfHc+EbpRhE8aobq3ng2R22MG2AzjnkCBIpKAGnShbl+642sClxnm0fip5yeUeOJeTUIalsXPn4kJjS5F49B89It2Twzl3EvEFR/WU4Rq485K+Uku5xeSAHwYsemtg+FdT1sBdzuhf5rL+9fEa4SfBgDbsuSU5+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/0370606aaddcab5ff077738387912ecf/a6d36/argo_image_6.png\"\n        srcset=\"/static/0370606aaddcab5ff077738387912ecf/222b7/argo_image_6.png 163w,\n/static/0370606aaddcab5ff077738387912ecf/ff46a/argo_image_6.png 325w,\n/static/0370606aaddcab5ff077738387912ecf/a6d36/argo_image_6.png 650w,\n/static/0370606aaddcab5ff077738387912ecf/e548f/argo_image_6.png 975w,\n/static/0370606aaddcab5ff077738387912ecf/3c492/argo_image_6.png 1300w,\n/static/0370606aaddcab5ff077738387912ecf/91010/argo_image_6.png 3492w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bc23d2fb3ec2db415deacd902ef736e5/e2d4c/argo_image_7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.50920245398773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABhklEQVR42pVSi27bMBDz///csBZN+rCdpLEty3rajptmeXA8JQW2Nh0yAcRBJ4lH3in78ZhjrTo8lks8PBd4eClxN3/BjHH2XGKeL3A4HiHreDzhdDrh85q272hDjzhtkSnj4PsBS6VQKw0Xe2ymCaEfsdKeccB+v09kh/0vHA67L4RS5Awgm7Y7bN93JB3RdBYdK/WbN4TxDToMMHGA9hGdH+Cjgwsafpy+IFyQrVqLqvOQWDYGed2hIF615B3WPCsuuaI2vGORV/pbZAVJ0uXGJEKJC6INkUo3sFS4UAaGauP4sT8Xv4bsWlIKLPlIIOQl99oFWh5SLJW5nfBDYWU9DHunfZ/ya+2gXMSrtIYFbifkZbEkw+g3U7Io+dp4qotoWeQvy5/sX7fcdJy4SwpbG1OuoWJH8pr5nOdzFniyATMO70/Sb3u4aDUsv1B3sSwQu6vL4zRMdf4VN/WwYXWxV7F3MoS1qOVfrVz8vymnv0a0JLQkMVQpKu5o9Z62f9Ji8Q/C36l1f2aV09ZXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/bc23d2fb3ec2db415deacd902ef736e5/a6d36/argo_image_7.png\"\n        srcset=\"/static/bc23d2fb3ec2db415deacd902ef736e5/222b7/argo_image_7.png 163w,\n/static/bc23d2fb3ec2db415deacd902ef736e5/ff46a/argo_image_7.png 325w,\n/static/bc23d2fb3ec2db415deacd902ef736e5/a6d36/argo_image_7.png 650w,\n/static/bc23d2fb3ec2db415deacd902ef736e5/e548f/argo_image_7.png 975w,\n/static/bc23d2fb3ec2db415deacd902ef736e5/3c492/argo_image_7.png 1300w,\n/static/bc23d2fb3ec2db415deacd902ef736e5/e2d4c/argo_image_7.png 3618w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16a958a52039393bf42eae6e882b6987/ea7d0/argo_image_8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.993865030674847%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmUlEQVR42qXM3QqCQBAF4H3/F4sggijCLlwrUMufXV1N0F07zboKVtJNFx9n5gwM2xw8rLZ7rHdH5KWCefbotCEa2lCaManTfe8Yd7faUdN2kHUDdrrGsLxLBD9MECYCUtWQ1QMFyQs1ZCpKpLJERrt1FwVu1PEofcOCOIN1Jq5MhnlJQPfJtH895Aulb4Vjzszv/KP7+fAfL0rydN/tYLeVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/16a958a52039393bf42eae6e882b6987/a6d36/argo_image_8.png\"\n        srcset=\"/static/16a958a52039393bf42eae6e882b6987/222b7/argo_image_8.png 163w,\n/static/16a958a52039393bf42eae6e882b6987/ff46a/argo_image_8.png 325w,\n/static/16a958a52039393bf42eae6e882b6987/a6d36/argo_image_8.png 650w,\n/static/16a958a52039393bf42eae6e882b6987/e548f/argo_image_8.png 975w,\n/static/16a958a52039393bf42eae6e882b6987/3c492/argo_image_8.png 1300w,\n/static/16a958a52039393bf42eae6e882b6987/ea7d0/argo_image_8.png 3620w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"手动触发\" style=\"position:relative;\"><a href=\"#%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91\" aria-label=\"手动触发 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>手动触发</h2>\n<p>使用<code class=\"language-text\">kubectl -n argo create -f workflow.yml</code>创建流水线。</p>\n<p>我们简单看下 workflow.yaml 的内容，引用的是 ci-workflow，然后指定了一些参数，包括 app_repo、git_branch、target_branch、container_tag、dockerfile、path。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Workflow\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">generateName</span><span class=\"token punctuation\">:</span> ci<span class=\"token punctuation\">-</span>workflow<span class=\"token punctuation\">-</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> argo\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/workflow-template</span><span class=\"token punctuation\">:</span> ci<span class=\"token punctuation\">-</span>workflow\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> app_repo\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"argo-workflows-ci-example\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git_branch\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"main\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> target_branch\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"main\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container_tag\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"stable\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container_image\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"192.168.1.94:443/my_test/hello-world\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dockerfile\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> Dockerfile\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> path\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/CI\"</span>\n  <span class=\"token key atrule\">workflowTemplateRef</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ci<span class=\"token punctuation\">-</span>workflow</code></pre></div>\n<p>再来看看 ci-workflow 是啥？文件位置：bootstrap/workflow-templates/nfs/ci-workflow.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> WorkflowTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ci<span class=\"token punctuation\">-</span>workflow\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      A basic CI leveraging Argo Workflows.\n\n      The Workflow<span class=\"token punctuation\">...</span>\n\n      * pulls a repo from git. Specifically pulling a branch based on a pull request; * merges the target branch into it; * modifies the html that will be copied into the container to inject the unique name of the running workflow; * builds a container from a Dockerfile and pushes to a registry; * deploys an Argo CD application that uses the newly<span class=\"token punctuation\">-</span>built container to deploy a static website.\n\n      It does not pretend to be a definitive example<span class=\"token punctuation\">,</span> but it aims to inspire. In order to make this a semi<span class=\"token punctuation\">-</span>usable example<span class=\"token punctuation\">,</span> we have cut a number of security corners. Please don't just blindly run this in production.\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pipekit Inc\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">= 3.3.6\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># This is entirely optional. It allows us to use Prometheus to scrape the metrics from the argo Workflow Controller, and to measure the success of our CI.</span>\n  <span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Writes a prometheus metric stating the length of time it took the workflow to complete. Grouped by workflow status and 'type'.</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> exec_duration_gauge\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> name\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ci-workflow\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> type\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"pull-request\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> status\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{status}}\"</span>\n        <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Duration gauge by name\"</span>\n        <span class=\"token key atrule\">gauge</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{workflow.duration}}\"</span>\n          <span class=\"token key atrule\">realtime</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token comment\"># If the workflow fails, we increase the Prometheus failure counter by 1.</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> result_counter\n        <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Count of step execution by result status\"</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> status\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> Failed\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> name\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ci-workflow\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> type\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"pull-request\"</span>\n        <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{status}} == Failed\"</span>\n        <span class=\"token key atrule\">counter</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span>\n      <span class=\"token comment\"># If the workflow succeeds, we increase the Prometheus succeeded counter by 1.</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> result_counter\n        <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Count of step execution by result status\"</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> status\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> Succeeded\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> name\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ci-workflow\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> type\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"pull-request\"</span>\n        <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{status}} == Succeeded\"</span>\n        <span class=\"token key atrule\">counter</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token comment\"># We request an NFS share (called 'workdir') so that we can pull the code, and manipulate it across multiple nodes.</span>\n  <span class=\"token comment\"># By the nature of the share, we would be able to access it from multiple nodes at the same time, allowing for parallel nodes.</span>\n  <span class=\"token comment\"># We use nfs-server-provisioner for this, which uses disk on the Kubernetes node to provision the share. The PVCs are cleaned up when the workflow finishes.</span>\n  <span class=\"token key atrule\">volumeClaimTemplates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> workdir\n      <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> nfs<span class=\"token punctuation\">-</span>csi\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi\n  <span class=\"token comment\"># The container build step copies the code from the NFS share to this ephemeral volume, and then runs the build.</span>\n  <span class=\"token comment\"># We do this a) because NFS shares are slow and b) to allow us to run another workflow step alongside the build if we wish.</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> harbor<span class=\"token punctuation\">-</span>cert\n      <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> harbor<span class=\"token punctuation\">-</span>ca<span class=\"token punctuation\">-</span>cert\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>config\n      <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> registry<span class=\"token punctuation\">-</span>auth\n        <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> .dockerconfigjson\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> config.json\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n      <span class=\"token key atrule\">emptyDir</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token comment\"># You can set default parameters here if you prefer. If you simply don't inject them when calling this template, the defaults will come through.</span>\n      <span class=\"token comment\"># We default 'container_tag' to 'stable' here.</span>\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> app_repo\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git_branch\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> target_branch\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container_tag\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"stable\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container_image\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dockerfile\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> path\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n        <span class=\"token comment\"># All the steps in this DAG are referencing external templates.</span>\n        <span class=\"token comment\"># This allows us to re-use those templates in other workflows, and also makes this CI workflow quite tidy.</span>\n        <span class=\"token comment\"># For reference we have also included a 'local' template (delete-application) to show that it's possible to mix-and-match local and external templates.</span>\n  <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n      <span class=\"token key atrule\">dag</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n            <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n              <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n            <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n              <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n            <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n            <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n              <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n            <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n            <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n              <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n            <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>application\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>application\n            <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> (deploy<span class=\"token punctuation\">-</span>application.Failed)\n    <span class=\"token comment\"># This only runs if deploy-application fails. This allows us to ensure that we have a tidy environment for the next Workflow run.</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>application\n      <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">action</span><span class=\"token punctuation\">:</span> delete\n        <span class=\"token key atrule\">manifest</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          apiVersion: argoproj.io/v1alpha1\n          kind: Application\n          metadata:\n            name: final-application\n            namespace: argocd</span></code></pre></div>\n<p>注意：相比官方的文件，我增加了 docker-config、harbor-cert 两个 volumes，这个很重要，后面再讲。</p>\n<p>可以看到 workflow 的定义有参数的定义，正好对应我们运行流水线时，传入的参数。</p>\n<p>重点看一下 tasks 部署，应用了一些其他的 template。这些 template 也是在 bootstrap/workflow-templates/nfs 下。</p>\n<p>通过 depends 的定义，可以看到流水线的执行过程，</p>\n<p>git-checkout-pr → html-modifier → container-build → deploy-application</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n    <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n    <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n    <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n    <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n    <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n    <span class=\"token key atrule\">templateRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> main\n    <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>application\n    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>application\n    <span class=\"token key atrule\">depends</span><span class=\"token punctuation\">:</span> (deploy<span class=\"token punctuation\">-</span>application.Failed)</code></pre></div>\n<h3 id=\"git-checkout-pr\" style=\"position:relative;\"><a href=\"#git-checkout-pr\" aria-label=\"git checkout pr permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>git-checkout-pr</h3>\n<p>由于我的服务器连不上 github，我 clone 了一个，放到自建的 gitlab，然后创建 token 下载。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> WorkflowTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      Clones a git repository and then performs a git checkout of a branch defined in the workflow workflow.parameters. Then merges in a defined target branch.\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pipekit Inc\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/pipekit/argo-workflows-ci-example\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">= 3.3.6\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n      <span class=\"token key atrule\">dag</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git<span class=\"token punctuation\">-</span>checkout<span class=\"token punctuation\">-</span>pr\n      <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine<span class=\"token punctuation\">:</span>latest\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> sh\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>c\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            apk --update add git\n            cd /workdir\n            echo \"Start Clone of source branch\"\n            git clone http://gitlab-token:xxxx@192.168.80.36/xxxxx/{{workflow.parameters.app_repo}}.git\n            cd {{workflow.parameters.app_repo}}\n            ## These lines are a hack just for the example.\n            git config --global --add safe.directory /workdir/{{workflow.parameters.app_repo}}\n            git config --global user.email \"sales@pipekit.io\"\n            git config --global user.name \"Tim Collins\"\n            git checkout {{workflow.parameters.git_branch}}\n            echo \"Merge in target branch\"\n            git merge origin/{{workflow.parameters.target_branch}}\n            echo \"Complete.\"</span>\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"workdir\"</span>\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /workdir\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 250Mi\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 4m\n      <span class=\"token comment\">#20 minutes</span>\n      <span class=\"token key atrule\">activeDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1200</span></code></pre></div>\n<h3 id=\"html-modifier\" style=\"position:relative;\"><a href=\"#html-modifier\" aria-label=\"html modifier permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>html-modifier</h3>\n<p>这个步骤是模拟修改、提交。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> WorkflowTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      Performs a sed command to inject the current running Workflow name into a given file.\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pipekit Inc\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/pipekit/argo-workflows-ci-example\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">= 3.3.6\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n      <span class=\"token key atrule\">dag</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> html<span class=\"token punctuation\">-</span>modifier\n      <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">:</span>latest\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> /bin/bash\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>c\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            cd /workdir/{{workflow.parameters.app_repo}}/CI</span>\n\n            if grep <span class=\"token punctuation\">-</span>q CHANGEMEPLEASE index.html; then\n              cat index.html <span class=\"token punctuation\">|</span> sed <span class=\"token punctuation\">-</span>E 's/CHANGEMEPLEASE/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.name<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> and it used nfs<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>provisioner for artifact passing./g' <span class=\"token punctuation\">></span> tmp_index.html\n              mv tmp_index.html index.html\n            else\n              echo \"CHANGEMEPLEASE was not found in index.html. Exiting\"\n              exit 1\n            fi\n\n            cat index.html\n\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> workdir\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /workdir\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 256Mi\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 100m\n      <span class=\"token comment\">#20 minutes</span>\n      <span class=\"token key atrule\">activeDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1200</span></code></pre></div>\n<h3 id=\"container-build\" style=\"position:relative;\"><a href=\"#container-build\" aria-label=\"container build permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>container-build</h3>\n<p>当我再尝试 jenkins 打包镜像时，也遇到 buildkit:v0.18.2-rootless，打包失败的问题和上传镜像失败的问题。因为我的 harbor 的证书是自签的，才会遇到这个。如果你的都是标准的，不会遇到这些问题。</p>\n<p>经过千辛万苦的尝试，最终还是解决了。通过增加 harbor-ca.crt 和 config.json，</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> WorkflowTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      Uses Buildkit to build a container image within Kubernetes.\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pipekit Inc\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/pipekit/argo-workflows-ci-example\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">= 3.3.6\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n      <span class=\"token key atrule\">dag</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n      <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> moby/buildkit<span class=\"token punctuation\">:</span>v0.18.2<span class=\"token punctuation\">-</span>rootless\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> sh\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>c\n          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            echo \"Retrieving git clone...\" &amp;&amp; cp -R /workdir/{{workflow.parameters.app_repo}} /container-build</span>\n\n            mkdir <span class=\"token punctuation\">-</span>p /home/user/.docker\n\n            buildctl<span class=\"token punctuation\">-</span>daemonless.sh build \\\n            <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frontend \\\n            dockerfile.v0 \\\n            <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>local \\\n            context=/container<span class=\"token punctuation\">-</span>build/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.app_repo<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.path<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> \\\n            <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>local \\\n            dockerfile=/container<span class=\"token punctuation\">-</span>build/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.app_repo<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.path<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> \\\n            <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>opt filename=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.dockerfile<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> \\\n            <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>output \\\n            type=image<span class=\"token punctuation\">,</span>name=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.container_image<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>workflow.parameters.container_tag<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>push=true<span class=\"token punctuation\">,</span>registry.insecure=true\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> BUILDKITD_FLAGS\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>oci<span class=\"token punctuation\">-</span>worker<span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>process<span class=\"token punctuation\">-</span>sandbox\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> container<span class=\"token punctuation\">-</span>build\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /container<span class=\"token punctuation\">-</span>build\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> workdir\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /workdir\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>config\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /home/user/.docker/config.json\n            <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> config.json\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> harbor<span class=\"token punctuation\">-</span>cert\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /etc/ssl/certs/harbor<span class=\"token punctuation\">-</span>ca.crt\n            <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> harbor<span class=\"token punctuation\">-</span>ca.crt\n        <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">seccompProfile</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Unconfined\n          <span class=\"token key atrule\">runAsUser</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n          <span class=\"token key atrule\">runAsGroup</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 1Gi\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n      <span class=\"token comment\">#20 minutes</span>\n      <span class=\"token key atrule\">activeDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1200</span></code></pre></div>\n<p>harbor-ca.crt 创建</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">## download ca</span>\nopenssl s_client <span class=\"token parameter variable\">-showcerts</span> <span class=\"token parameter variable\">-connect</span> <span class=\"token number\">192.168</span>.1.94:443 <span class=\"token operator\">&lt;</span>/dev/null <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null <span class=\"token operator\">|</span> openssl x509 <span class=\"token parameter variable\">-outform</span> PEM <span class=\"token operator\">></span> harbor-ca.crt\n\nkubectl create secret generic harbor-ca-cert --from-file<span class=\"token operator\">=</span>harbor-ca.crt<span class=\"token operator\">=</span>/etc/ssl/certs/harbor-ca.crt</code></pre></div>\n<p>config.json 创建</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl create secret docker-registry registry-auth --docker-server<span class=\"token operator\">=</span>https://192.168.1.94:443 --docker-username<span class=\"token operator\">=</span>admin --docker-password<span class=\"token operator\">=</span>Harbor12345</code></pre></div>\n<h3 id=\"deploy-application\" style=\"position:relative;\"><a href=\"#deploy-application\" aria-label=\"deploy application permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deploy-application</h3>\n<p>最后创建了一个 argo 的 application，用于部署。通过 application 的 status.health.status，判断是否部署成功。部署失败，会删除这个应用，这个功能是在</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> WorkflowTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      Leverages Argo Workflows' ability to interact directly with Kubernetes to deploy an Argo CD Application.\n      It monitors the health status of the application and is only considered 'done' once the Argo CD\n      Application reports itself as healthy.\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pipekit Inc\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/maintainer_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/pipekit/argo-workflows-ci-example\"</span>\n    <span class=\"token key atrule\">workflows.argoproj.io/version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">= 3.3.6\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> main\n  <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n      <span class=\"token key atrule\">dag</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>application\n      <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">action</span><span class=\"token punctuation\">:</span> create\n        <span class=\"token key atrule\">successCondition</span><span class=\"token punctuation\">:</span> status.health.status == Healthy\n        <span class=\"token key atrule\">failureCondition</span><span class=\"token punctuation\">:</span> status.health.status == Degraded\n        <span class=\"token key atrule\">manifest</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          apiVersion: argoproj.io/v1alpha1\n          kind: Application\n          metadata:\n            name: final-application\n            finalizers:\n              - resources-finalizer.argocd.argoproj.io\n            namespace: argocd\n          spec:\n            destination:\n              namespace: final-application\n              server: 'https://kubernetes.default.svc'\n            project: default\n            source:\n              path: bootstrap/final-application\n              repoURL: 'http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git'\n              targetRevision: HEAD\n            syncPolicy:\n              automated:\n                prune: true\n                selfHeal: true\n              syncOptions:\n                - PrunePropagationPolicy=background\n                - PruneLast=true\n                - CreateNamespace=true</span></code></pre></div>\n<h3 id=\"delete-application\" style=\"position:relative;\"><a href=\"#delete-application\" aria-label=\"delete application permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>delete-application</h3>\n<p>是在 ci-workflow.yml 里定义的。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    - name: delete-application\n      resource:\n        action: delete\n        manifest: <span class=\"token operator\">|</span>\n          apiVersion: argoproj.io/v1alpha1\n          kind: Application\n          metadata:\n            name: final-application\n            namespace: argocd</code></pre></div>\n<p>一切顺利的话，可以看到下面的执行的流水线和详细的执行过程。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/70c57dc4451d7f13bf59c9b52e2e1696/7bbaa/argo_image_9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.539877300613497%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVR42p2QXQ6CMBCEe/97GH0wxkQBz2IAQa2ipSA/EpXCuBRFosYHm3yZ3ezstCkbDEdY+hyrDUdd1yhV1XErFanS+k7fp71EdrmCjSdTRGkOEcU4ZQVEnEImGdVnRKRSk2tPnL40yYu2p/mzb2Bz00JzFN0Q0qK9PcDlR3hBCD+QnX6jP/N2Auu9AJsZhg6sqjbQoTCXhg4Xuv6tnz5mWos2kP5P0tPtR+C/3AGnl3Ztp9Cl8gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/70c57dc4451d7f13bf59c9b52e2e1696/a6d36/argo_image_9.png\"\n        srcset=\"/static/70c57dc4451d7f13bf59c9b52e2e1696/222b7/argo_image_9.png 163w,\n/static/70c57dc4451d7f13bf59c9b52e2e1696/ff46a/argo_image_9.png 325w,\n/static/70c57dc4451d7f13bf59c9b52e2e1696/a6d36/argo_image_9.png 650w,\n/static/70c57dc4451d7f13bf59c9b52e2e1696/e548f/argo_image_9.png 975w,\n/static/70c57dc4451d7f13bf59c9b52e2e1696/3c492/argo_image_9.png 1300w,\n/static/70c57dc4451d7f13bf59c9b52e2e1696/7bbaa/argo_image_9.png 4082w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e168629731dabaca262c5354e68ad114/79da4/argo_image_10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABgElEQVR42nWS2W7CQAxF8/9f1NfSly5qoRVL9qVk3yAFErLe2oGqBCUjXXmizJzxtS2IuoXFWsYnaSVrWEoavkQVHysJ86WE/eGEpmlR1g2qG5V1jaKsUFQ1coopnYuzAwQv3sOJUrjxDi5FP9lDc0IoWx9zw4LqBDDdCMaNdCeCfb3jJBlsuuNR5LuCzoe8GBxvZfkJXg0Dsh1cIFfxXrVDpD8n8Oq6DvkpR5EXOFPWwj2IpTGQHnk3LSjONLBpGjRtiyMDy7K3PgrkSwx6VGVsbI++hw5UKkmaHVFTRgzkevKq6IEJYAyRQE+qgs12HJgQsM+QLB/ZblWRRixrbgjzanemKZRpOLD8DzygJEjTdjiXF9go8K9JL4aON13v4do9sK8hZUjjQwn2jeFVT1nmsZlJGywsg5qT9FkP/0cIaEQs28W345M8mLSPdtk4UCfgs6xCuhuZ4VjFkMwtRGNL0YZM8qPddFO4yzzU+gSQy2DSrHJ5rCDB+tvHw1zELw5TMbVgpOveAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/e168629731dabaca262c5354e68ad114/a6d36/argo_image_10.png\"\n        srcset=\"/static/e168629731dabaca262c5354e68ad114/222b7/argo_image_10.png 163w,\n/static/e168629731dabaca262c5354e68ad114/ff46a/argo_image_10.png 325w,\n/static/e168629731dabaca262c5354e68ad114/a6d36/argo_image_10.png 650w,\n/static/e168629731dabaca262c5354e68ad114/e548f/argo_image_10.png 975w,\n/static/e168629731dabaca262c5354e68ad114/3c492/argo_image_10.png 1300w,\n/static/e168629731dabaca262c5354e68ad114/79da4/argo_image_10.png 3946w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>发生错误，可以点开该节点，看到详细的报错信息。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5757fd7cf032011966c90330494f293/d20e4/argo_image_11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkUlEQVR42n2T6Y6CQBCEef+32TfY/bPrXooXyo1yyOXFISoDtT0T3ZiIklRSA5NvuqsHaTgz0J+qGCoaxqqJCUkmP5hq6E/m+CH1yb8PJvCjFGfW4HA8CeWHI+mEojoh2WUI1ztIHm1arBK4YQqXvB9voC1DzBcBPnUfihNAJT9b+NDdEJYfw/Ai+MkW8ZYgpGCzx4pgHCqZQQLrIu5NP4G9SoV+7QAGvXMu6+s+w4ux3hcAWrQtUJYlsizHqWaQrBvgrWzSt21D9yPhb79x4CYrwBgDI2J5qFBRBA156RGMg94MDaoXdgJ5hXVdE7TBmSq7Pg+AKaZugFdDfQrk/bZNiyIvUBQlatbRshnEIrMv28KHZVKm8d2BV2DbNMRssdtnQozWHUAaAkGUuU4ZOgJuPmmZ51ZVR5Qk1pWhyM9LII/oXjpLAq5F1ffAHPW5FhVyKA27eyg8P81bYTqS4bgRrJvr8g+kDtJdjizPceDViSkfBbz72tCEraXbmd9VXrQWf5es6BjPDfSGCl56Mv4AfjsxDD191jkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/d5757fd7cf032011966c90330494f293/a6d36/argo_image_11.png\"\n        srcset=\"/static/d5757fd7cf032011966c90330494f293/222b7/argo_image_11.png 163w,\n/static/d5757fd7cf032011966c90330494f293/ff46a/argo_image_11.png 325w,\n/static/d5757fd7cf032011966c90330494f293/a6d36/argo_image_11.png 650w,\n/static/d5757fd7cf032011966c90330494f293/e548f/argo_image_11.png 975w,\n/static/d5757fd7cf032011966c90330494f293/3c492/argo_image_11.png 1300w,\n/static/d5757fd7cf032011966c90330494f293/d20e4/argo_image_11.png 3906w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>workflow template 的定义</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64717c22149c85640d1617d51ab1e8eb/2170d/argo_image_12.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.601226993865026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdUlEQVR42oVSTU/DMAzN//8TaAeGRtlgQ0LaBXHgB3BCGtoBtJUNWMvWNs13jZ02hZYhKj3ZdeyXZ8fsZDCAp9UGHh4X8J6k4CoAbSwY646if6Zt/Z8L5cGGowg4Osk+g226h4wL2OccDkXp/Z84NGd5KVukWQEZ2gI5KIdNZ9fgv6rCBAFaW5BKA0dfad2CYgphUY3DNgIMKiZbIRTWsmg88XxUkOLtWhuQUkEppI8FCIxJpXzLRBqgMN9fQr4ywE5HF7D55LCM3+Blu8N5WF/MhfCK+oR0bp1rQQLIOleTs7NoAnGaw3JNhAneZluFvl0koyLyyRKhawgI2hhvq0AYXc4gTr4Jg8ISFQZ1nZn1FZqewuH5GF7T4hdhwUuvNDxEwL+Eo8lVp2V6tbKZIc2MFIZiQ/jjUQgCc9n0Zg7rJDvSsqwJ0Td+mW1ruwrrf4drR6RsfnsHq49DQ7jzgycy7nfSdF6a0F8bitEOZlzC/eIZvgCvYVAl52R98AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/64717c22149c85640d1617d51ab1e8eb/a6d36/argo_image_12.png\"\n        srcset=\"/static/64717c22149c85640d1617d51ab1e8eb/222b7/argo_image_12.png 163w,\n/static/64717c22149c85640d1617d51ab1e8eb/ff46a/argo_image_12.png 325w,\n/static/64717c22149c85640d1617d51ab1e8eb/a6d36/argo_image_12.png 650w,\n/static/64717c22149c85640d1617d51ab1e8eb/e548f/argo_image_12.png 975w,\n/static/64717c22149c85640d1617d51ab1e8eb/3c492/argo_image_12.png 1300w,\n/static/64717c22149c85640d1617d51ab1e8eb/2170d/argo_image_12.png 4092w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>最终结果，final-application 是一个 argo appliction，所以也能在页面上看到</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26e7fb90997b2c0e72e3a02d5083f81c/bf9d2/argo_image_13.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.263803680981596%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABN0lEQVR42n1QiW6DMAzl//9uWkc1GmBQCDkhHKXrob45YWzdVBXpYTs+np+jzS5HVnLEZN+SDJskxcs2IT9FzJa38+WCZ9/pfIZse5jhgKjRBrJzKHkDbVsM44R5PqI0CqWUsLbD9Xp9OvB2u/0gmj9P8FDUKEyHllim4wm6H1FJE95sP6EbZ8Ih5Bf/L9w3okJYcOOwly1YpZBUEjvCR6MhbI+GkNYaKeVYrZBx8sn62keI8sbglZWIi4o2GaHdiJyaKtPCTYfA6mNFN+oo77cshEFGQ3MiyvlCsiLyxcleBNaaNl2LOUlV3UBbOipUdHSHnobZfsAH1eykBdMdmGqR+Z51oP/5LTNugqRVVi40at2iItzHhdDhBFuy7xTHdBrW/Bv4EPXS+Hu35XbpShgkq6DmXvIXK2RXbHFLB2AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image.png\"\n        title=\"\"\n        src=\"/static/26e7fb90997b2c0e72e3a02d5083f81c/a6d36/argo_image_13.png\"\n        srcset=\"/static/26e7fb90997b2c0e72e3a02d5083f81c/222b7/argo_image_13.png 163w,\n/static/26e7fb90997b2c0e72e3a02d5083f81c/ff46a/argo_image_13.png 325w,\n/static/26e7fb90997b2c0e72e3a02d5083f81c/a6d36/argo_image_13.png 650w,\n/static/26e7fb90997b2c0e72e3a02d5083f81c/e548f/argo_image_13.png 975w,\n/static/26e7fb90997b2c0e72e3a02d5083f81c/3c492/argo_image_13.png 1300w,\n/static/26e7fb90997b2c0e72e3a02d5083f81c/bf9d2/argo_image_13.png 3602w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"代码触发\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E7%A0%81%E8%A7%A6%E5%8F%91\" aria-label=\"代码触发 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代码触发</h2>\n<p>项目在 hera 文件下提供了 python 代码调用的方式，<code class=\"language-text\">python hera/nfs/workflow.py</code>， 入口函数是在 workflow.py 里。</p>\n<p>制定了参数和引用的 workflow，引用的 workflow 是 ci_workflow.py 里的 ci_workflow</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> ci_workflow <span class=\"token keyword\">import</span> ci_workflow\n\n<span class=\"token keyword\">with</span> Workflow<span class=\"token punctuation\">(</span>\n    generate_name<span class=\"token operator\">=</span><span class=\"token string\">\"hera-ci-workflow-\"</span><span class=\"token punctuation\">,</span>\n    namespace<span class=\"token operator\">=</span><span class=\"token string\">\"argo\"</span><span class=\"token punctuation\">,</span>\n    labels<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'argoworkflows.argoproj.io/workflow-template'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'hera-ci-workflow'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    arguments<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"app_repo\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"argo-workflows-ci-example\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"git_branch\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"target_branch\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"stable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container_image\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"k3d-registry.localhost:5000/hello-world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"dockerfile\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"Dockerfile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"/CI\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    workflow_template_ref<span class=\"token operator\">=</span>ci_workflow\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> workflow<span class=\"token punctuation\">:</span>\n    workflow<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>workflow<span class=\"token punctuation\">.</span>get_workflow_link<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\"># get a link for monitoring</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting for workflow to complete\"</span><span class=\"token punctuation\">)</span>\n    workflow<span class=\"token punctuation\">.</span>wait<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>再来看看 ci_workflow.py。从其他 4 个 py 文件里，引入了 5 个 workflowtemplate，和上面 yaml 的定义过程是一样的。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> git_checkout_pr <span class=\"token keyword\">import</span> git_checkout_pr\n<span class=\"token keyword\">from</span> html_modifier <span class=\"token keyword\">import</span> html_modifier\n<span class=\"token keyword\">from</span> container_build <span class=\"token keyword\">import</span> container_build\n<span class=\"token keyword\">from</span> deploy_application <span class=\"token keyword\">import</span> deploy_application<span class=\"token punctuation\">,</span> deploy_application_manifest\n\n<span class=\"token keyword\">with</span> WorkflowTemplate<span class=\"token punctuation\">(</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"hera-ci-workflow\"</span><span class=\"token punctuation\">,</span>\n    entrypoint<span class=\"token operator\">=</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span>\n    volume_claim_templates<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n        m<span class=\"token punctuation\">.</span>PersistentVolumeClaim<span class=\"token punctuation\">(</span>\n            metadata<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>ObjectMeta<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"workdir\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            spec<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>PersistentVolumeClaimSpec<span class=\"token punctuation\">(</span>\n                access_modes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'ReadWriteMany'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                storage_class_name<span class=\"token operator\">=</span><span class=\"token string\">'nfs'</span><span class=\"token punctuation\">,</span>\n                resources<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>ResourceRequirements<span class=\"token punctuation\">(</span>\n                    requests<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"storage\"</span><span class=\"token punctuation\">:</span> m<span class=\"token punctuation\">.</span>Quantity<span class=\"token punctuation\">(</span>__root__<span class=\"token operator\">=</span><span class=\"token string\">\"1Gi\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\"># The container build step copies the code from the NFS share to this ephemeral volume, and then runs the build.</span>\n        <span class=\"token comment\"># We do this a) because NFS shares are slow and b) to allow us to run another workflow step alongside the build if we wish.</span>\n    volumes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>EmptyDirVolume<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container-build\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    arguments<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"app_repo\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"git_branch\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"target_branch\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container_image\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"dockerfile\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Parameter<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    annotations<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'workflows.argoproj.io/description'</span><span class=\"token punctuation\">:</span> <span class=\"token triple-quoted-string string\">'''A basic CI leveraging Argo Workflows.\n\nThe Workflow...\n\n* pulls a repo from git. Specifically pulling a branch based on a pull request;\n* merges the target branch into it;\n* modifies the html that will be copied into the container to inject the unique name of the running workflow;\n* builds a container from a Dockerfile and pushes to a registry;\n* deploys an Argo CD application that uses the newly-built container to deploy a static website.\n\nIt does not pretend to be a definitive example, but it aims to inspire. In order to make this a semi-usable example, we have cut a number of security corners. Please don't just blindly run this in production.\n'''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> ci_workflow<span class=\"token punctuation\">:</span>\n    delete_application_resource <span class=\"token operator\">=</span> Resource<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"delete-application\"</span><span class=\"token punctuation\">,</span>\n                  action<span class=\"token operator\">=</span><span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">,</span>\n                  manifest<span class=\"token operator\">=</span>deploy_application_manifest\n                  <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> main<span class=\"token punctuation\">:</span>\n        git_checkout_pr_task <span class=\"token operator\">=</span> git_checkout_pr<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"git-checkout-pr\"</span><span class=\"token punctuation\">)</span>\n        html_modifier_task <span class=\"token operator\">=</span> html_modifier<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"html-modifier\"</span><span class=\"token punctuation\">)</span>\n        container_build_task <span class=\"token operator\">=</span> container_build<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container-build\"</span><span class=\"token punctuation\">)</span>\n        deploy_application_task <span class=\"token operator\">=</span> deploy_application<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"deploy-application\"</span><span class=\"token punctuation\">)</span>\n        delete_application_task <span class=\"token operator\">=</span> delete_application_resource<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"delete-application\"</span><span class=\"token punctuation\">,</span> depends<span class=\"token operator\">=</span><span class=\"token string\">\"deploy-application.Failed\"</span><span class=\"token punctuation\">)</span>\n        git_checkout_pr_task <span class=\"token operator\">>></span> html_modifier_task <span class=\"token operator\">>></span> container_build_task <span class=\"token operator\">>></span> deploy_application_task\n\nci_workflow<span class=\"token punctuation\">.</span>to_file<span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    ci_workflow<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">except</span> AlreadyExists<span class=\"token punctuation\">:</span>\n    ci_workflow<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>重点看一下，流程的定义，使用 DAG 定义的有向无环图。<code class=\"language-text\">git_checkout_pr_task >> html_modifier_task >> container_build_task >> deploy_application_task</code>，hera 通过重载<a href=\"https://github.com/argoproj-labs/hera/blob/f3c7a0198760160d8f758dba7e145ae3c519f7b8/src/hera/workflows/task.py#L106\">rshift</a> 实现了类似 pipeline 的调用。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> main<span class=\"token punctuation\">:</span>\n        git_checkout_pr_task <span class=\"token operator\">=</span> git_checkout_pr<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"git-checkout-pr\"</span><span class=\"token punctuation\">)</span>\n        html_modifier_task <span class=\"token operator\">=</span> html_modifier<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"html-modifier\"</span><span class=\"token punctuation\">)</span>\n        container_build_task <span class=\"token operator\">=</span> container_build<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container-build\"</span><span class=\"token punctuation\">)</span>\n        deploy_application_task <span class=\"token operator\">=</span> deploy_application<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"deploy-application\"</span><span class=\"token punctuation\">)</span>\n        delete_application_task <span class=\"token operator\">=</span> delete_application_resource<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"delete-application\"</span><span class=\"token punctuation\">,</span> depends<span class=\"token operator\">=</span><span class=\"token string\">\"deploy-application.Failed\"</span><span class=\"token punctuation\">)</span>\n        git_checkout_pr_task <span class=\"token operator\">>></span> html_modifier_task <span class=\"token operator\">>></span> container_build_task <span class=\"token operator\">>></span> deploy_application_task</code></pre></div>\n<h3 id=\"git_checkout_pr\" style=\"position:relative;\"><a href=\"#git_checkout_pr\" aria-label=\"git_checkout_pr permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>git_checkout_pr</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">git_checkout_script <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''apk --update add git\n\ncd /workdir\necho \"Start Clone of source branch\"\ngit clone https://github.com/pipekit/{{workflow.parameters.app_repo}}.git\ncd {{workflow.parameters.app_repo}}\n\n## These lines are a hack just for the example.\ngit config --global --add safe.directory /workdir/{{workflow.parameters.app_repo}}\ngit config --global user.email \"sales@pipekit.io\"\ngit config --global user.name \"Tim Collins\"\n\ngit checkout {{workflow.parameters.git_branch}}\n\necho \"Merge in target branch\"\ngit merge origin/{{workflow.parameters.target_branch}}\n\necho \"Complete.\"\n'''</span>\n\ngit_checkout_pr <span class=\"token operator\">=</span> Container<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"git-checkout-pr\"</span><span class=\"token punctuation\">,</span>\n               image<span class=\"token operator\">=</span><span class=\"token string\">\"alpine:latest\"</span><span class=\"token punctuation\">,</span>\n               command<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> git_checkout_script<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n               volume_mounts<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                   m<span class=\"token punctuation\">.</span>VolumeMount<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"workdir\"</span><span class=\"token punctuation\">,</span>\n                                 mount_path<span class=\"token operator\">=</span><span class=\"token string\">\"/workdir\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n               resources<span class=\"token operator\">=</span>Resources<span class=\"token punctuation\">(</span>memory_request<span class=\"token operator\">=</span><span class=\"token string\">\"250Mi\"</span><span class=\"token punctuation\">,</span> cpu_request<span class=\"token operator\">=</span><span class=\"token string\">\"4m\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n               active_deadline_seconds<span class=\"token operator\">=</span><span class=\"token number\">1200</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h3 id=\"html_modifier\" style=\"position:relative;\"><a href=\"#html_modifier\" aria-label=\"html_modifier permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>html_modifier</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">html_modifier_script <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''cd /workdir/{{workflow.parameters.app_repo}}/CI\n\nif grep -q CHANGEMEPLEASE index.html; then\n  cat index.html | sed -E 's/CHANGEMEPLEASE/{{workflow.name}} and it used nfs-server-provisioner for artifact passing./g' > tmp_index.html\n  mv tmp_index.html index.html\nelse\n  echo \"CHANGEMEPLEASE was not found in index.html. Exiting\"\n  exit 1\nfi\n\ncat index.html\n'''</span>\n\nhtml_modifier <span class=\"token operator\">=</span> Container<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"html-modifier\"</span><span class=\"token punctuation\">,</span>\n                               image<span class=\"token operator\">=</span><span class=\"token string\">\"ubuntu:latest\"</span><span class=\"token punctuation\">,</span>\n                               command<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> html_modifier_script<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                               volume_mounts<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                                   m<span class=\"token punctuation\">.</span>VolumeMount<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"workdir\"</span><span class=\"token punctuation\">,</span>\n                                                 mount_path<span class=\"token operator\">=</span><span class=\"token string\">\"/workdir\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                               resources<span class=\"token operator\">=</span>Resources<span class=\"token punctuation\">(</span>memory_request<span class=\"token operator\">=</span><span class=\"token string\">\"256Mi\"</span><span class=\"token punctuation\">,</span> cpu_request<span class=\"token operator\">=</span><span class=\"token string\">\"100m\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                               active_deadline_seconds<span class=\"token operator\">=</span><span class=\"token number\">1200</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h3 id=\"container_build\" style=\"position:relative;\"><a href=\"#container_build\" aria-label=\"container_build permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>container_build</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">container_build_script <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''echo \"Retrieving git clone...\" &amp;&amp; cp -R /workdir/{{workflow.parameters.app_repo}} /container-build &amp;&amp; \\\nbuildctl-daemonless.sh build \\\n--frontend \\\ndockerfile.v0 \\\n--local \\\ncontext=/container-build/{{workflow.parameters.app_repo}}{{workflow.parameters.path}} \\\n--local \\\ndockerfile=/container-build/{{workflow.parameters.app_repo}}{{workflow.parameters.path}} \\\n--opt filename={{workflow.parameters.dockerfile}} \\\n--output \\\ntype=image,name={{workflow.parameters.container_image}}:{{workflow.parameters.container_tag}},push=true,registry.insecure=true\n'''</span>\n\n<span class=\"token comment\"># Uses Buildkit to build a container image within Kubernetes.</span>\ncontainer_build <span class=\"token operator\">=</span> Container<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container-build\"</span><span class=\"token punctuation\">,</span>\n                            image<span class=\"token operator\">=</span><span class=\"token string\">\"moby/buildkit:v0.12.3-rootless\"</span><span class=\"token punctuation\">,</span>\n                            command<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> container_build_script<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                            env<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                                Env<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"BUILDKITD_FLAGS\"</span><span class=\"token punctuation\">,</span>\n                                    value<span class=\"token operator\">=</span><span class=\"token string\">\"--oci-worker-no-process-sandbox\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                            volume_mounts<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                                m<span class=\"token punctuation\">.</span>VolumeMount<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"container-build\"</span><span class=\"token punctuation\">,</span>\n                                              mount_path<span class=\"token operator\">=</span><span class=\"token string\">\"/container-build\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                m<span class=\"token punctuation\">.</span>VolumeMount<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"workdir\"</span><span class=\"token punctuation\">,</span>\n                                              mount_path<span class=\"token operator\">=</span><span class=\"token string\">\"/workdir\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                            resources<span class=\"token operator\">=</span>Resources<span class=\"token punctuation\">(</span>memory_request<span class=\"token operator\">=</span><span class=\"token string\">\"1Gi\"</span><span class=\"token punctuation\">,</span> cpu_request<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                            security_context<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>SecurityContext<span class=\"token punctuation\">(</span>seccomp_profile<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>SeccompProfile<span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"Unconfined\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                                               run_as_user<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span>\n                                                               run_as_group<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                            active_deadline_seconds<span class=\"token operator\">=</span><span class=\"token number\">1200</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h3 id=\"deploy_application\" style=\"position:relative;\"><a href=\"#deploy_application\" aria-label=\"deploy_application permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deploy_application</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">deploy_application_manifest <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: final-application\n  finalizers:\n    - resources-finalizer.argocd.argoproj.io\n  namespace: argocd\nspec:\n  destination:\n    namespace: final-application\n    server: 'https://kubernetes.default.svc'\n  project: default\n  source:\n    path: bootstrap/final-application\n    repoURL: 'http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git'\n    targetRevision: HEAD\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n    syncOptions:\n      - PrunePropagationPolicy=background\n      - PruneLast=true\n      - CreateNamespace=true\n'''</span>\n\ndeploy_application <span class=\"token operator\">=</span> Resource<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"deploy-application\"</span><span class=\"token punctuation\">,</span>\n                              action<span class=\"token operator\">=</span><span class=\"token string\">\"create\"</span><span class=\"token punctuation\">,</span>\n                              success_condition<span class=\"token operator\">=</span><span class=\"token string\">\"status.health.status == Healthy\"</span><span class=\"token punctuation\">,</span>\n                              failure_condition<span class=\"token operator\">=</span><span class=\"token string\">\"status.health.status == Degraded\"</span><span class=\"token punctuation\">,</span>\n                              manifest<span class=\"token operator\">=</span>deploy_application_manifest\n                              <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h3 id=\"delete_application_resource\" style=\"position:relative;\"><a href=\"#delete_application_resource\" aria-label=\"delete_application_resource permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>delete_application_resource</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">  delete_application_resource <span class=\"token operator\">=</span> Resource<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"delete-application\"</span><span class=\"token punctuation\">,</span>\n                action<span class=\"token operator\">=</span><span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">,</span>\n                manifest<span class=\"token operator\">=</span>deploy_application_manifest\n                <span class=\"token punctuation\">)</span>\n</code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#argo-cicd\">argo ci/cd</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%B3%A8%E6%84%8F\">注意</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%BC%80%E5%A7%8B\">开始</a></p>\n<ul>\n<li>\n<p><a href=\"#%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91\">手动触发</a></p>\n<ul>\n<li><a href=\"#git-checkout-pr\">git-checkout-pr</a></li>\n<li><a href=\"#html-modifier\">html-modifier</a></li>\n<li><a href=\"#container-build\">container-build</a></li>\n<li><a href=\"#deploy-application\">deploy-application</a></li>\n<li><a href=\"#delete-application\">delete-application</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E4%BB%A3%E7%A0%81%E8%A7%A6%E5%8F%91\">代码触发</a></p>\n<ul>\n<li><a href=\"#git_checkout_pr\">git_checkout_pr</a></li>\n<li><a href=\"#html_modifier\">html_modifier</a></li>\n<li><a href=\"#container_build\">container_build</a></li>\n<li><a href=\"#deploy_application\">deploy_application</a></li>\n<li><a href=\"#delete_application_resource\">delete_application_resource</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"argo ci/cd初体验","date":"2025-02-13"}}},"pageContext":{"slug":"/2025-02-13-argo-ci-cd"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}