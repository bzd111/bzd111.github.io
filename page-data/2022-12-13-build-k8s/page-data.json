{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-12-13-build-k8s/","result":{"data":{"markdownRemark":{"html":"<!-- vim-markdown-toc GitLab -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#%E5%AE%89%E8%A3%85\">安装</a>\n<ul>\n<li><a href=\"#00-set-hostname\">0.0 set hostname</a></li>\n<li><a href=\"#01kubeadm-install\">01.kubeadm install</a></li>\n<li><a href=\"#02linux-config\">02.linux config</a></li>\n<li><a href=\"#03containerd-install-and-config\">03.containerd install and config</a></li>\n<li><a href=\"#04k8s-config\">04.k8s config</a></li>\n<li><a href=\"#05kubeadm-%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C\">05.kubeadm 相关操作</a>\n<ul>\n<li><a href=\"#init\">init</a></li>\n<li><a href=\"#cni\">cni</a></li>\n<li><a href=\"#join\">join</a></li>\n<li><a href=\"#clean\">clean</a></li>\n</ul>\n</li>\n<li><a href=\"#%E6%B5%8B%E8%AF%95\">测试</a>\n<ul>\n<li><a href=\"#%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8\">命令补全</a></li>\n<li><a href=\"#%E5%88%9B%E5%BB%BA-deployment\">创建 deployment</a></li>\n</ul>\n</li>\n<li><a href=\"#%E5%BC%80%E6%94%BE%E5%85%AC%E7%BD%91%E8%AE%BF%E9%97%AE\">开放公网访问</a></li>\n</ul>\n</li>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n<!-- vim-markdown-toc -->\n<h1 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h1>\n<h1 id=\"安装\" style=\"position:relative;\"><a href=\"#%E5%AE%89%E8%A3%85\" aria-label=\"安装 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装</h1>\n<h2 id=\"00-set-hostname\" style=\"position:relative;\"><a href=\"#00-set-hostname\" aria-label=\"00 set hostname permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0.0 set hostname</h2>\n<table>\n<thead>\n<tr>\n<th>Role</th>\n<th>IP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>k8s-master</td>\n<td>10.0.0.175</td>\n</tr>\n<tr>\n<td>k8s-node1</td>\n<td>10.0.0.158</td>\n</tr>\n</tbody>\n</table>\n<p>准备两台内网互通的机器，</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\n10.0.0.175 k8s-master\n10.0.0.158 k8s-node1\n\"</span> <span class=\"token operator\">>></span> /etc/hosts</code></pre></div>\n<h2 id=\"01kubeadm-install\" style=\"position:relative;\"><a href=\"#01kubeadm-install\" aria-label=\"01kubeadm install permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>01.kubeadm install</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://apt.kubernetes.io/ kubernetes-xenial main\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/kubernetes.list\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token parameter variable\">-y</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> <span class=\"token function\">install</span> <span class=\"token function\">vim</span> <span class=\"token function\">git</span> <span class=\"token function\">curl</span> <span class=\"token function\">wget</span>\n\n<span class=\"token comment\"># 安装不同的版本</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> isntall <span class=\"token assign-left variable\">kubelet</span><span class=\"token operator\">=</span><span class=\"token number\">1.24</span>.3-00 <span class=\"token assign-left variable\">kubeadm</span><span class=\"token operator\">=</span><span class=\"token number\">1.24</span>.3-00 <span class=\"token assign-left variable\">kubectl</span><span class=\"token operator\">=</span><span class=\"token number\">1.24</span>.3-00\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> <span class=\"token function\">install</span> <span class=\"token assign-left variable\">kubelet</span><span class=\"token operator\">=</span><span class=\"token number\">1.25</span>.4-00 <span class=\"token assign-left variable\">kubeadm</span><span class=\"token operator\">=</span><span class=\"token number\">1.25</span>.4-00 <span class=\"token assign-left variable\">kubectl</span><span class=\"token operator\">=</span><span class=\"token number\">1.25</span>.4-00</code></pre></div>\n<h2 id=\"02linux-config\" style=\"position:relative;\"><a href=\"#02linux-config\" aria-label=\"02linux config permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>02.linux config</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"memory swapoff\"</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/ swap / s/^\\(.*\\)$/#\\1/g'</span> /etc/fstab\n<span class=\"token function\">sudo</span> swapoff <span class=\"token parameter variable\">-a</span>\n<span class=\"token function\">sysctl</span> <span class=\"token assign-left variable\">net.ipv4.conf.all.forwarding</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></code></pre></div>\n<h2 id=\"03containerd-install-and-config\" style=\"position:relative;\"><a href=\"#03containerd-install-and-config\" aria-label=\"03containerd install and config permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>03.containerd install and config</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\n<span class=\"token comment\"># 手动安装</span>\n<span class=\"token function\">wget</span> https://github.com/containerd/containerd/releases/download/v1.6.2/containerd-1.6.2-linux-arm64.tar.gz\n<span class=\"token function\">sudo</span> <span class=\"token function\">tar</span> Czxvf /usr/local containerd-1.6.2-linux-arm64.tar.gz\n\n\n<span class=\"token function\">wget</span> https://raw.githubusercontent.com/containerd/containerd/main/containerd.service\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> containerd.service /usr/lib/systemd/system/\n\n<span class=\"token function\">wget</span> https://github.com/opencontainers/runc/releases/download/v1.1.1/runc.amd64\n<span class=\"token function\">sudo</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-m</span> <span class=\"token number\">755</span> runc.amd64 /usr/local/sbin/runc\n\n<span class=\"token comment\"># 通过依赖安装</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> gpg <span class=\"token parameter variable\">--dearmor</span> <span class=\"token parameter variable\">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb [arch=<span class=\"token variable\"><span class=\"token variable\">$(</span>dpkg --print-architecture<span class=\"token variable\">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release <span class=\"token parameter variable\">-cs</span><span class=\"token variable\">)</span></span> stable\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/docker.list\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> containerd.io\n\n\n<span class=\"token comment\"># 配置containerd</span>\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/containerd\ncontainerd config default<span class=\"token operator\">></span>/etc/containerd/config.toml\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/SystemdCgroup \\= false/SystemdCgroup \\= true/g'</span> /etc/containerd/config.toml\n<span class=\"token function\">sudo</span> systemctl restart containerd\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> containerd\n\n<span class=\"token function\">cat</span> /etc/crictl.yaml <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: true\nEOF</span></code></pre></div>\n<h2 id=\"04k8s-config\" style=\"position:relative;\"><a href=\"#04k8s-config\" aria-label=\"04k8s config permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>04.k8s config</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/modules-load.d/containerd.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\noverlay\nbr_netfilter\nEOF</span>\n\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/modules-load.d/containerd.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\noverlay\nbr_netfilter\nEOF</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span>\n</code></pre></div>\n<h2 id=\"05kubeadm-相关操作\" style=\"position:relative;\"><a href=\"#05kubeadm-%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C\" aria-label=\"05kubeadm 相关操作 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>05.kubeadm 相关操作</h2>\n<h3 id=\"init\" style=\"position:relative;\"><a href=\"#init\" aria-label=\"init permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>init</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm init --apiserver-advertise-address<span class=\"token operator\">=</span><span class=\"token number\">10.0</span>.0.175 <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># master的地址</span>\n             --kubernetes-version v1.25.4 <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># k8s版本</span>\n             --pod-network-cidr<span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.0/16 <span class=\"token punctuation\">\\</span> pod ip池\n             --cri-socket<span class=\"token operator\">=</span>unix:///run/containerd/containerd.sock <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># cri sock 路径</span>\n             <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">5</span></code></pre></div>\n<h3 id=\"cni\" style=\"position:relative;\"><a href=\"#cni\" aria-label=\"cni permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cni</h3>\n<p>安装 cni 之前 kubectl get node 都是 NotReady 的，安装完 cni 就是 Ready 了</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://docs.projectcalico.org/manifests/calico.yaml <span class=\"token parameter variable\">-O</span>\n<span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.conf kubectl apply <span class=\"token parameter variable\">-f</span> calico.yaml</code></pre></div>\n<h3 id=\"join\" style=\"position:relative;\"><a href=\"#join\" aria-label=\"join permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>join</h3>\n<p>如果一切顺利的话，就可以把其他节点加入集群了，其他节点需要执行前 5 步(00-04)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm <span class=\"token function\">join</span> <span class=\"token number\">10.0</span>.0.175:6443 <span class=\"token parameter variable\">--token</span> emuni5.vpyzqfm51d2dpk6y --discovery-token-ca-cert-hash sha256:ad547694790f288d2e801d3d933723a472b73f6809619c9b13a9e56784203d0d\n\n<span class=\"token comment\"># 由于token会过期，可以通过命令重新生成</span>\nkubeadm token create --print-join-command</code></pre></div>\n<h3 id=\"clean\" style=\"position:relative;\"><a href=\"#clean\" aria-label=\"clean permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>clean</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> kubeadm reset --cri-socket<span class=\"token operator\">=</span>unix:///run/containerd/containerd.sock <span class=\"token parameter variable\">-f</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> /var/lib/<span class=\"token punctuation\">{</span>calico,etcd,kubelet,kubernetes,cni<span class=\"token punctuation\">}</span> /etc/cni/net.d /etc/kubernetes /opt/cni/bin/*</code></pre></div>\n<h2 id=\"测试\" style=\"position:relative;\"><a href=\"#%E6%B5%8B%E8%AF%95\" aria-label=\"测试 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>测试</h2>\n<h3 id=\"命令补全\" style=\"position:relative;\"><a href=\"#%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8\" aria-label=\"命令补全 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>命令补全</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 临时生效</span>\n<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>crictl completion<span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>kubeadm completion <span class=\"token function\">bash</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>kubectl completion <span class=\"token function\">bash</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 永久生效</span>\ncrictl completion <span class=\"token operator\">></span> /etc/bash_completion.d/crictl\nkubectl completion <span class=\"token function\">bash</span> <span class=\"token operator\">></span> /etc/bash_completion.d/kubectl\nkubeadm completion <span class=\"token function\">bash</span> <span class=\"token operator\">></span> /etc/bash_completion.d/kubeadm</code></pre></div>\n<h3 id=\"创建-deployment\" style=\"position:relative;\"><a href=\"#%E5%88%9B%E5%BB%BA-deployment\" aria-label=\"创建 deployment permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建 deployment</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl create deployment nginx-app <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>nginx <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\nkubectl expose deployment nginx-app <span class=\"token parameter variable\">--type</span><span class=\"token operator\">=</span>NodePort <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">80</span></code></pre></div>\n<h2 id=\"开放公网访问\" style=\"position:relative;\"><a href=\"#%E5%BC%80%E6%94%BE%E5%85%AC%E7%BD%91%E8%AE%BF%E9%97%AE\" aria-label=\"开放公网访问 permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>开放公网访问</h2>\n<p>当节点有公网 IP，想要通过公网 IP 访问时，需要修改 certSANs 的信息 kubectl -n kube-system get configmap kubeadm-config -o jsonpath=‘{.data.ClusterConfiguration}’ > kubeadm.yaml</p>\n<ol>\n<li>生成 kubeadm.yaml</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl <span class=\"token parameter variable\">-n</span> kube-system get configmap kubeadm-config <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'{.data.ClusterConfiguration}'</span> <span class=\"token operator\">></span> kubeadm.yaml</code></pre></div>\n<ol start=\"2\">\n<li>修改 kubeadm.yaml，添加 ip</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">apiServer:\n  certSANs:\n  - <span class=\"token string\">\"172.29.50.162\"</span>\n  - <span class=\"token string\">\"k8s.domain.com\"</span>\n  - <span class=\"token string\">\"other-k8s.domain.net\"</span>\n  extraArgs:\n    authorization-mode: Node,RBAC\n  timeoutForControlPlane: 4m0s</code></pre></div>\n<ol start=\"3\">\n<li>生成证书和更新配置</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mv</span> /etc/kubernetes/pki/apiserver.<span class=\"token punctuation\">{</span>crt,key<span class=\"token punctuation\">}</span> ~\nkubeadm init phase certs apiserver <span class=\"token parameter variable\">--config</span> kubeadm.yaml\nkubeadm init phase upload-config kubeadm <span class=\"token parameter variable\">--config</span> kubeadm.yaml</code></pre></div>\n<ol start=\"4\">\n<li>使用原来的 kubeconfig 即可</li>\n</ol>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"toc-anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://mritd.com/2020/01/21/set-up-kubernetes-ha-cluster-by-kubeadm/\">https://mritd.com/2020/01/21/set-up-kubernetes-ha-cluster-by-kubeadm/</a></li>\n<li><a href=\"https://mritd.com/2021/05/29/use-containerd-with-kubernetes/\">https://mritd.com/2021/05/29/use-containerd-with-kubernetes/</a></li>\n<li><a href=\"https://blog.laisky.com/p/k8s-install/\">https://blog.laisky.com/p/k8s-install/</a></li>\n<li><a href=\"https://dragonfly.fun/devops/kubeadm.html\">https://dragonfly.fun/devops/kubeadm.html</a></li>\n<li><a href=\"https://gist.github.com/saiyam1814/931dca8f83da83816e2ed8cd10275d41\">https://gist.github.com/saiyam1814/931dca8f83da83816e2ed8cd10275d41</a></li>\n<li><a href=\"https://www.itzgeek.com/how-tos/linux/ubuntu-how-tos/install-containerd-on-ubuntu-22-04.html\">https://www.itzgeek.com/how-tos/linux/ubuntu-how-tos/install-containerd-on-ubuntu-22-04.html</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%AE%89%E8%A3%85\">安装</a></p>\n<ul>\n<li>\n<p><a href=\"#00-set-hostname\">0.0 set hostname</a></p>\n</li>\n<li>\n<p><a href=\"#01kubeadm-install\">01.kubeadm install</a></p>\n</li>\n<li>\n<p><a href=\"#02linux-config\">02.linux config</a></p>\n</li>\n<li>\n<p><a href=\"#03containerd-install-and-config\">03.containerd install and config</a></p>\n</li>\n<li>\n<p><a href=\"#04k8s-config\">04.k8s config</a></p>\n</li>\n<li>\n<p><a href=\"#05kubeadm-%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C\">05.kubeadm 相关操作</a></p>\n<ul>\n<li><a href=\"#init\">init</a></li>\n<li><a href=\"#cni\">cni</a></li>\n<li><a href=\"#join\">join</a></li>\n<li><a href=\"#clean\">clean</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%B5%8B%E8%AF%95\">测试</a></p>\n<ul>\n<li><a href=\"#%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8\">命令补全</a></li>\n<li><a href=\"#%E5%88%9B%E5%BB%BA-deployment\">创建 deployment</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%BC%80%E6%94%BE%E5%85%AC%E7%BD%91%E8%AE%BF%E9%97%AE\">开放公网访问</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>","frontmatter":{"title":"搭建k8s集群","date":"2022-12-13"}}},"pageContext":{"slug":"/2022-12-13-build-k8s"}},"staticQueryHashes":["3649515864"],"slicesMap":{}}