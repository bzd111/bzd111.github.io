<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.1"/><style data-href="/styles.91d60bbab44133089581.css" data-identity="gatsby-global-css">*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*
! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com
*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}:host,html{-webkit-text-size-adjust:100%;font-feature-settings:normal;-webkit-tap-highlight-color:transparent;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-variation-settings:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{line-height:inherit}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}code,kbd,pre,samp{font-feature-settings:normal;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-variation-settings:normal}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-feature-settings:inherit;color:inherit;font-family:inherit;font-size:100%;font-variation-settings:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]:where(:not([hidden=until-found])){display:none}.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.25em}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){border-inline-start-color:var(--tw-prose-quote-borders);border-inline-start-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-inline-start:1em;quotes:"\201C""\201D""\2018""\2019"}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}.prose :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}.prose :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}.prose :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}.prose :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){display:block;margin-bottom:2em;margin-top:2em}.prose :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px 0 rgb(var(--tw-prose-kbd-shadows)/10%);color:var(--tw-prose-kbd);font-family:inherit;font-size:.875em;font-weight:500;padding-inline-end:.375em;padding-bottom:.1875em;padding-top:.1875em;padding-inline-start:.375em}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:"`"}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding-inline-end:1.1428571em;padding-bottom:.8571429em;padding-top:.8571429em;padding-inline-start:1.1428571em}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:transparent;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:none}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;width:100%}.prose :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}.prose :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-inline-start:.5714286em;vertical-align:bottom}.prose :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}.prose :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:baseline}.prose :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}.prose :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}.prose :where(th,td):not(:where([class~=not-prose],[class~=not-prose] *)){text-align:start}.prose :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:rgba(0,0,0,.5);--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}.prose :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-top:.5714286em;padding-inline-start:.5714286em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.prose-lg{font-size:1.125rem;line-height:1.7777778}.prose-lg :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.prose-lg :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.2222222em;line-height:1.4545455;margin-bottom:1.0909091em;margin-top:1.0909091em}.prose-lg :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.6666667em;margin-top:1.6666667em;padding-inline-start:1em}.prose-lg :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:2.6666667em;line-height:1;margin-bottom:.8333333em;margin-top:0}.prose-lg :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.6666667em;line-height:1.3333333;margin-bottom:1.0666667em;margin-top:1.8666667em}.prose-lg :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.3333333em;line-height:1.5;margin-bottom:.6666667em;margin-top:1.6666667em}.prose-lg :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){line-height:1.5555556;margin-bottom:.4444444em;margin-top:1.7777778em}.prose-lg :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose-lg :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;font-size:.8888889em;padding-inline-end:.4444444em;padding-bottom:.2222222em;padding-top:.2222222em;padding-inline-start:.4444444em}.prose-lg :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em}.prose-lg :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8666667em}.prose-lg :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em}.prose-lg :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.375rem;font-size:.8888889em;line-height:1.75;margin-bottom:2em;margin-top:2em;padding-inline-end:1.5em;padding-bottom:1em;padding-top:1em;padding-inline-start:1.5em}.prose-lg :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.prose-lg :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.prose-lg :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.6666667em;margin-top:.6666667em}.prose-lg :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.prose-lg :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.prose-lg :where(.prose-lg>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.prose-lg :where(.prose-lg>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(.prose-lg>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.prose-lg :where(.prose-lg>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(.prose-lg>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.prose-lg :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.prose-lg :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.prose-lg :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.6666667em;padding-inline-start:1.5555556em}.prose-lg :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:3.1111111em;margin-top:3.1111111em}.prose-lg :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5}.prose-lg :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-inline-start:.75em}.prose-lg :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose-lg :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose-lg :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-top:.75em;padding-inline-start:.75em}.prose-lg :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose-lg :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose-lg :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose-lg :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5;margin-top:1em}.prose-lg :where(.prose-lg>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(.prose-lg>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.fixed{position:fixed}.relative{position:relative}.left-4{left:1rem}.top-0{top:0}.top-32{top:8rem}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:.25rem}.mt-8{margin-top:2rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.w-12{width:3rem}.w-64{width:16rem}.w-full{width:100%}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-7xl{max-width:80rem}.max-w-none{max-width:none}.scroll-mt-32{scroll-margin-top:8rem}.list-disc{list-style-type:disc}.list-none{list-style-type:none}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-left:calc(1rem*(1 - var(--tw-space-x-reverse)));margin-right:calc(1rem*var(--tw-space-x-reverse))}.space-x-7>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-left:calc(1.75rem*(1 - var(--tw-space-x-reverse)));margin-right:calc(1.75rem*var(--tw-space-x-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(1rem*var(--tw-space-y-reverse));margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)))}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.border{border-width:1px}.border-t{border-top-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.object-cover{-o-object-fit:cover;object-fit:cover}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-2{padding-bottom:.5rem;padding-top:.5rem}.py-4{padding-bottom:1rem;padding-top:1rem}.py-8{padding-top:2rem}.pb-8,.py-8{padding-bottom:2rem}.pl-4{padding-left:1rem}.pt-20{padding-top:5rem}.text-left{text-align:left}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-lg{font-size:1.125rem}.text-lg,.text-xl{line-height:1.75rem}.text-xl{font-size:1.25rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow{--tw-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color)}.shadow,.shadow-lg{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition-colors{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-shadow{transition-duration:.15s;transition-property:box-shadow;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-300{transition-duration:.3s}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity,1))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.hover\:text-gray-900:hover{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.hover\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.hover\:shadow-lg:hover,.hover\:shadow-md:hover{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\:shadow-md:hover{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}@media (min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:block{display:block}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f8f9fa;border:1px solid #e2e8f0;border-radius:6px;margin:1em 0;padding:1em}code[class*=language-],pre[class*=language-]{color:#24292e;font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:14px;line-height:1.5;text-shadow:none}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#6a737d}.token.punctuation{color:#24292e}.token.boolean,.token.constant,.token.number,.token.property,.token.symbol,.token.tag{color:#005cc5}.token.attr-name,.token.builtin,.token.char,.token.selector,.token.string{color:#032f62}.language-css .token.string,.style .token.string,.token.atrule,.token.attr-value,.token.entity,.token.keyword,.token.operator,.token.url{color:#d73a49}.token.function{color:#6f42c1}.token.important,.token.regex,.token.variable{color:#e36209}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]{scroll-margin-top:5rem}:root{--border-radius:4px;--color-text:#333;--color-primary:#7026b9;--color-code-bg:#fff4db;--color-code:#8a6534;--font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";--font-mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--font-lg:18px;--font-md:16px;--font-sm:14px;--font-sx:12px;--line-height-loose:1.75;--line-height-normal:1.5;--line-height-dense:1.1;--space-1:4px;--space-2:8px;--space-3:16px;--space-4:24px;--space-5:32px;--space-6:64px;--size-content:54rem;--size-gutter:var(--space-5);--size-gap:var(--space-6)}html{-webkit-text-size-adjust:100%;box-sizing:border-box;font:sans-serif;font-size:var(--font-md);line-height:var(--line-height-normal);overflow-y:scroll}body{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;word-wrap:break-word;color:var(--color-text);font-family:sans-serif;font-family:var(--font-sans);font-weight:400;margin:0}a{background-color:transparent;color:var(--color-primary);font-weight:500;text-decoration:none;text-decoration:underline;text-decoration-thickness:1.5px;text-underline-offset:2px}a:active,a:hover{outline-width:0;text-decoration:none}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{letter-spacing:-.01em;line-height:var(--line-height-dense);margin:0 0 3rem;padding:0}h1>b{color:var(--color-primary)}img{border-style:none;max-width:100%}code,kbd,pre,samp{font-family:var(--font-mono);font-size:1em;line-height:inherit}hr{background:rgba(0,0,0,.2);border:none;box-sizing:content-box;height:1px;margin-bottom:calc(var(--space-4) - 1px);margin-left:0;margin-right:0;margin-top:0;overflow:visible;padding:0}*,:after,:before{box-sizing:inherit}dd,dl,fieldset,figure,hgroup,img,ol,p,ul{margin:0;margin-bottom:var(--space-4);padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin-left:var(--space-4)}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:var(--border-radius);font-size:.875rem;line-height:var(--line-height-normal);margin-bottom:var(--space-4);margin-left:0;margin-right:0;margin-top:0;overflow:auto;padding:var(--space-4)}b,dt,strong,th{font-weight:700}li{margin-bottom:calc(var(--space-4)/2)}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:calc(var(--space-4)/2);margin-left:var(--space-4);margin-top:calc(var(--space-4)/2)}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:calc(var(--space-4)/2)}p{max-width:680px}code,kbd,samp{font-size:.875rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}code,tt{background-color:var(--color-code-bg);border-radius:var(--border-radius);color:var(--color-code);font-family:var(--font-mono);padding-bottom:.25em;padding-top:.25em;word-break:normal}pre code{background:none}code:after,code:before,tt:after,tt:before{content:"\00a0";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:none}</style><style type="text/css">
    .toc-anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .toc-anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .toc-anchor svg,
    h2 .toc-anchor svg,
    h3 .toc-anchor svg,
    h4 .toc-anchor svg,
    h5 .toc-anchor svg,
    h6 .toc-anchor svg {
      visibility: hidden;
    }
    h1:hover .toc-anchor svg,
    h2:hover .toc-anchor svg,
    h3:hover .toc-anchor svg,
    h4:hover .toc-anchor svg,
    h5:hover .toc-anchor svg,
    h6:hover .toc-anchor svg,
    h1 .toc-anchor:focus svg,
    h2 .toc-anchor:focus svg,
    h3 .toc-anchor:focus svg,
    h4 .toc-anchor:focus svg,
    h5 .toc-anchor:focus svg,
    h6 .toc-anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="bg-white shadow-lg fixed w-full top-0 z-50"><div class="max-w-6xl mx-auto px-4"><div class="flex justify-center"><div class="flex space-x-7"><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/">首页</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/tags/">标签</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/about/">关于</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/links/">友链</a></div></div></div></nav><div class="text-center" style="margin:0 auto;max-width:var(--size-content);padding:var(--size-gutter)"><main class="pt-20"></main></div><div class="max-w-7xl mx-auto px-4 py-8 relative" style="padding-top:6rem;margin-top:-6rem"><div class="max-w-4xl mx-auto" style="scroll-margin-top:6rem"><h1 class="text-4xl font-bold mb-4">argo ci/cd初体验</h1><div class="prose prose-lg max-w-none"><div><h1 id="argo-cicd" style="position:relative;"><a href="#argo-cicd" aria-label="argo cicd permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>argo ci/cd</h1>
<p>从一个<a href="https://github.com/pipekit/argo-workflows-ci-example">demo</a>开始，由于一些网络问题，镜像拉取不下来，可以看我之前的 blog 解决。</p>
<h1 id="注意" style="position:relative;"><a href="#%E6%B3%A8%E6%84%8F" aria-label="注意 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注意</h1>
<p>项目里有一些应用是 kustomization 和 helm 安装的，由于网络原因，安装会失败。我使用下面的命令，生成了最终的 yaml。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kustomize build <span class="token builtin class-name">.</span> <span class="token operator">></span> output.yaml
helm template <span class="token builtin class-name">.</span> <span class="token operator">></span> output.yaml</code></pre></div>
<h1 id="开始" style="position:relative;"><a href="#%E5%BC%80%E5%A7%8B" aria-label="开始 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开始</h1>
<p>整个项目目录结构是这样。入口文件是 setup.sh。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">├── argo.yaml
├── assets
│   └── images
├── bootstrap
│   ├── applications
│   ├── applications<span class="token punctuation">-</span>rollouts
│   ├── app<span class="token punctuation">-</span>of<span class="token punctuation">-</span>apps
│   ├── app<span class="token punctuation">-</span>of<span class="token punctuation">-</span>apps<span class="token punctuation">-</span>rollouts
│   ├── argocd
│   ├── argo<span class="token punctuation">-</span>rollouts
│   ├── argo<span class="token punctuation">-</span>workflows
│   ├── final<span class="token punctuation">-</span>application
│   ├── ingress<span class="token punctuation">-</span>nginx
│   ├── k3d.conf
│   ├── minio
│   ├── nfs<span class="token punctuation">-</span>server<span class="token punctuation">-</span>provisioner
│   ├── output.yaml
│   └── workflow<span class="token punctuation">-</span>templates
├── CI
│   ├── Dockerfile
│   └── index.html
├── hera
│   └── nfs
├── LICENSE
├── output.yaml
├── README.md
├── renovate.json
├── rollouts<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>2.yml
├── rollouts<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>2.yml
├── rollouts<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>s3.yml
├── rollouts<span class="token punctuation">-</span>workflow.yml
├── setup.sh
├── workflow<span class="token punctuation">-</span>s3.yml
└── workflow.yml</code></pre></div>
<p>看一下 setup.sh 的内容。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>

k3d cluster delete workflows-ci <span class="token operator">||</span> <span class="token boolean">true</span>
k3d cluster create <span class="token parameter variable">--config</span> bootstrap/k3d.conf

<span class="token comment"># Prevent users from accidentally deploying to the wrong cluster.</span>
<span class="token assign-left variable">currentContext</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl config current-context<span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$currentContext</span>"</span> <span class="token operator">==</span> <span class="token string">"k3d-workflows-ci"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Starting deployment to cluster..."</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"The kubectl context is not what we expected. Exiting for safety. Perhaps the k3d cluster failed to create?"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment"># Deploy Argo CD, which in turn deploys everything else</span>
kubectl <span class="token parameter variable">-n</span> kube-system rollout status deployment/metrics-server
kubectl apply <span class="token parameter variable">-k</span> bootstrap/argocd
kubectl <span class="token parameter variable">-n</span> argocd rollout status statefulset/argocd-application-controller
kubectl <span class="token parameter variable">-n</span> argocd rollout status deployment/argocd-repo-server
kubectl <span class="token parameter variable">-n</span> argocd apply <span class="token parameter variable">-f</span> bootstrap/app-of-apps<span class="token string">"<span class="token variable">${1}</span>"</span>

<span class="token comment"># Create 'final-application' namespace for the final application</span>
kubectl create namespace final-application

<span class="token comment"># Wait for Argo CD to start syncing its new-found applications</span>
<span class="token function">sleep</span> <span class="token number">30</span>
kubectl <span class="token parameter variable">-n</span> nfs-server-provisioner rollout status statefulset/nfs-server-provisioner
kubectl <span class="token parameter variable">-n</span> ingress-nginx rollout status deployment/nginx-ingress-nginx-controller
kubectl <span class="token parameter variable">-n</span> ingress-nginx rollout status daemonset/svclb-nginx-ingress-nginx-controller
kubectl <span class="token parameter variable">-n</span> argo rollout status deployment/workflow-controller
kubectl <span class="token parameter variable">-n</span> argo rollout status deployment/argo-server
kubectl <span class="token parameter variable">-n</span> minio rollout status deployment/minio

<span class="token builtin class-name">echo</span> <span class="token string">"Complete. You should be able to navigate to https://localhost:8443/argo/workflows/argo in your browser now. (Remember to accept the self-signed SSL cert)."</span></code></pre></div>
<p>setup.sh 会部署一个 k3s 的集群，然后部署 kubectl apply -k bootstrap/argocd，会把 argocd 部署起来，</p>
<p>再通过<code class="language-text">kubectl -n argocd apply -f bootstrap/app-of-apps</code>部署一个 Application，</p>
<p>这个 Application 会 bootstrap/applications-rollouts 下的 6 个 Application 启动起来。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">❯ tree <span class="token parameter variable">-L</span> <span class="token number">2</span> bootstrap/applications-rollouts
bootstrap/applications-rollouts
├── argocd.yml
├── argo-rollouts.yml
├── argo-workflows-templates.yml
├── argo-workflows.yml
├── minio.yml
└── nginx.yml</code></pre></div>
<p>应用分别对应下面的文件的内容，就是定义了这些 Application。原来的仓库是有 nfs 的，我部署不成功，然后手动安装了<a href="https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/example/nfs-provisioner/README.md">nfs</a>，所以会比官方少一个。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">bootstrap/argocd
bootstrap/argo-rollouts
bootstrap/workflow-templates
bootstrap/argo-workflows
bootstrap/minio
bootstrap/ingress-nginx</code></pre></div>
<p>你也可以使用自己的集群，直接去执行然后下面两个命令。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-k</span> bootstrap/argocd
kubectl <span class="token parameter variable">-n</span> argocd apply <span class="token parameter variable">-f</span> bootstrap/app-of-apps</code></pre></div>
<p>通过 port-forward 转发就可以在浏览器看到页面了。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">k port-forward services/argocd-server <span class="token parameter variable">--address</span> <span class="token number">0.0</span>.0.0 <span class="token number">8443</span>:443
k port-forward services/argo-server <span class="token parameter variable">--address</span> <span class="token number">0.0</span>.0.0 <span class="token number">8843</span>:2746</code></pre></div>
<p>初始化完成应该可以看到这几个 application</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2494cd92ee40c750f8613a560b608232/9b641/argo_image.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 47.852760736196316%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/klEQVR42jVSiXLaMBT0//9Wpw0dDhNCICkGgm184VOW5TvblWg1s2Np9d5qtbK18V28Bj524R3bu4+V50Jz9t17ctxbcb32b7D51TWvoY+1F2DlZrC9HEs3x+KWYXl7wErLErmsUXcKVdfhmpbIqhIJ+apt0PQd3CJHmGeI8hwP7rVjD68sEBWCvQpl07FuRKl6WE2jkLG573t0w4SwkOjaFnkpIKTEPM2IhUBVS6I2mMYJSS1Qywal2ROsG9G0HSzJQkEMFOzHGQEFm6aBJDo6/p6/EbMhryrowxUPm+cZCW9VUExSVHPTNEH1A6yFvcdi+45fmzeUtH+NMqx2R7zYb/i53iFOc0QU+/16wJL4sdziyw+RNRK7zzNeNs+6w+mKWtFhnBYQTctFawRvyQNBnCLJK1MgCZ+iXvSgI4my1u5bcgL3JGNcgpwyGlklYelrCV5vMBkOCBm25io66LreXC8SFSrmWcn/GQ503TJjRfHnG+ivyVApTgjd2DHsUL8iMzG5jiP00A+gBU1WrNMjFlqwMXlrA3ooGrD+nL/w+Q/twN8hS+FcXRydC3E1L5nQ1fF8Nfz+00GaF8jUiIsb4IM1h9MFXhA9BdcHB/bHGZvjGfdHjnMQwz7qtWO4rzCBG2dmvv24YP1+guOGzLDE3rlB92+I48VDkBb4C18v7n9i8QJeAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/2494cd92ee40c750f8613a560b608232/a6d36/argo_image.png"
        srcset="/static/2494cd92ee40c750f8613a560b608232/222b7/argo_image.png 163w,
/static/2494cd92ee40c750f8613a560b608232/ff46a/argo_image.png 325w,
/static/2494cd92ee40c750f8613a560b608232/a6d36/argo_image.png 650w,
/static/2494cd92ee40c750f8613a560b608232/e548f/argo_image.png 975w,
/static/2494cd92ee40c750f8613a560b608232/3c492/argo_image.png 1300w,
/static/2494cd92ee40c750f8613a560b608232/9b641/argo_image.png 3588w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>也可以点卡片进去看到详情。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f0cc32814c1b053cd470825016965937/0a758/argo_image_1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABX0lEQVR42pWS2W6DMBRE+f+vq6omapMCWQzEu1kTqVGmY8NDH6rQIo2wDffYM77Z60eOg2jwnh/wtiuoHC/bHTYcb/clNvsCX/c7nj3T9QbpW4Txiqw2BjoEnOoG2jh0/YBxuuJsNIRSsC7gvgJ8PB5J8clG0qfbDdp5XAh03YB+4jz0qLSDtC0Mx74fVzSld3a8WAjtcZIWRa3xWamkOK+4XpmAPK6JvynLCYkFeaUTMI4PjYHp+nTSjrmUaZ2qZxVPlP36gcWN9XBtD+ValI3GWdGJcqh54n8B8wV41haGQNsOXFeMxRHeMQL/T+Bi/eJDshyGcc6W+eyFpNQ6sEwyS5YsoGreuCFUsW3i92Q5XZRjBOY5cN5Z4siCk3QJKmjZ0rK0c2bx1mW0rFcsx902pcD2IFIfKd/NlnmywCaPfRn/yZd2Sg5WLTd6tlHFrGQqqmjZE6a5wVqr/AR+AxrJf6jOvrIwAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/f0cc32814c1b053cd470825016965937/a6d36/argo_image_1.png"
        srcset="/static/f0cc32814c1b053cd470825016965937/222b7/argo_image_1.png 163w,
/static/f0cc32814c1b053cd470825016965937/ff46a/argo_image_1.png 325w,
/static/f0cc32814c1b053cd470825016965937/a6d36/argo_image_1.png 650w,
/static/f0cc32814c1b053cd470825016965937/e548f/argo_image_1.png 975w,
/static/f0cc32814c1b053cd470825016965937/3c492/argo_image_1.png 1300w,
/static/f0cc32814c1b053cd470825016965937/0a758/argo_image_1.png 3604w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c5b4e0279dd2505d427d63979232928c/75ac7/argo_image_2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.89570552147239%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABQklEQVR42p2SW3PCIBSE8///XR9aZ7ylagwBAgTIxdTq9gDxoZc41czsMCzh47CHbJEfsCsqvC63eFuRaHxZLKd5HnU+f+Ledxo/wLWFch0yXmsY5/BeMrBKQDcWXd/TosOWM3CpMNKG6/U6Cwxrl8sljll/GjHQBuM8mNSQxsF3J9huAFMGXDWQdLrxHZq2T/K/ZSc/23OFQhrsqhp5WWNzlFgfBaIfpbElf1VwrA5J60LMKtuUkiCCNslvqnSDth9iZTmrcTs4KMx//n9T9veCQEnZ+gkYvCPFoayHoEjyGdhdYMiv7Udo28Z5iGE9XTvE8jiQrmwp5ARMfqgsZ/OwWWDINGTYuBZ14yIkeKlK8RywDE+IoJwUvAM1paSGMGUfb0rIKjah8ahUAu4rRXBHvnmuQqYNfNvRg0/P5r9X/gK6YX/WOK4HrgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/c5b4e0279dd2505d427d63979232928c/a6d36/argo_image_2.png"
        srcset="/static/c5b4e0279dd2505d427d63979232928c/222b7/argo_image_2.png 163w,
/static/c5b4e0279dd2505d427d63979232928c/ff46a/argo_image_2.png 325w,
/static/c5b4e0279dd2505d427d63979232928c/a6d36/argo_image_2.png 650w,
/static/c5b4e0279dd2505d427d63979232928c/e548f/argo_image_2.png 975w,
/static/c5b4e0279dd2505d427d63979232928c/3c492/argo_image_2.png 1300w,
/static/c5b4e0279dd2505d427d63979232928c/75ac7/argo_image_2.png 3600w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9835a2e3a47fb69a19a1c62bc060362c/75ac7/argo_image_3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42qWS6W7CMBCE8/4v16qi5QghkMt24sQY52yB6dqhqD8ggtbSyLay/rK7s97L3McuYXhb+JgtA8xWAV4/lnhfbTD3Q7d/HY+YWm3XQygNVbfwuJSQWiPmAmWpYOoGXd8jLiXSokBFgcfTaRJ4Po+yy2v7Ae3wCVlpcKmgTIO6GyAPNZisUBCw0jU0/X1P0k3n9nvyIl5SJgqRKLHJCqzTHOskR5AW7m7lJ4LunCoxKPaGzmPMLXn2we/HtxQQcMtyHGx2pkXI7sd6U6ArkDLaZuICbCZjHwLakjepcLCS+vk0MGTSybbC9YtgW55T0xtnmv32MNAGLyOGVcyQ5hUZVl1LVmSKJFPCZzK0wMUuwyLK3LDaCRhd5zQ+xo1Q+PeSCXQZJevyOIvN/132Y0FZCWjz08P7wG924H784lMrwgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/9835a2e3a47fb69a19a1c62bc060362c/a6d36/argo_image_3.png"
        srcset="/static/9835a2e3a47fb69a19a1c62bc060362c/222b7/argo_image_3.png 163w,
/static/9835a2e3a47fb69a19a1c62bc060362c/ff46a/argo_image_3.png 325w,
/static/9835a2e3a47fb69a19a1c62bc060362c/a6d36/argo_image_3.png 650w,
/static/9835a2e3a47fb69a19a1c62bc060362c/e548f/argo_image_3.png 975w,
/static/9835a2e3a47fb69a19a1c62bc060362c/3c492/argo_image_3.png 1300w,
/static/9835a2e3a47fb69a19a1c62bc060362c/75ac7/argo_image_3.png 3600w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d56779037cee7083d7fb9f3844deec6c/a05a9/argo_image_4.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVR42q2S2W6DMBBF+f/Pq5TyAMFNICzebTAkCuJ2TKP2iSRVYuloZFu+nuUmu5zhcGqRsRKfWYEd8ZFmSDOGNP8iGK7zjHtrnM5ojYMJE5JGSnBjcKwbCKng+wFhnFBKgZJzKG0xPxBcluWXJJwvmAhBDzupYXzAMF4gXY9aaHDtoNwA2493cQNFIjm0ChXXOFIsaoH8xJFX3bpvlUMjLfbr2XMkexKJD2IsbjCisw6efjR9AGv+7h6RbF10VKqmsmO5rH5VkDJupIGyfu3lWwQ7soEnG2ga0suCsZ8tTT1mKIx/Uw8pQxdGKN8/LbadYeyhseStQCXTUBr544Qb/xaMPqy4XAUllR3PSq7Im3L1bPxgS/AbSkh/h6XqAFQAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/d56779037cee7083d7fb9f3844deec6c/a6d36/argo_image_4.png"
        srcset="/static/d56779037cee7083d7fb9f3844deec6c/222b7/argo_image_4.png 163w,
/static/d56779037cee7083d7fb9f3844deec6c/ff46a/argo_image_4.png 325w,
/static/d56779037cee7083d7fb9f3844deec6c/a6d36/argo_image_4.png 650w,
/static/d56779037cee7083d7fb9f3844deec6c/e548f/argo_image_4.png 975w,
/static/d56779037cee7083d7fb9f3844deec6c/3c492/argo_image_4.png 1300w,
/static/d56779037cee7083d7fb9f3844deec6c/a05a9/argo_image_4.png 3616w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/35cc04cdf951d744502d56f88b8dcc2d/2176f/argo_image_5.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.78527607361963%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGklEQVR42pWRC2+DMAyE+f8/b9O2rrwKg4SShPBIoEyUm3E3aarWao30CdtyTrkjeA5TZKLCPs3wGiZ4IZ52IddvUYpddMCynHHv+OmEo+1h/YRAKE1Ni6yUqLVBNzg4PyJTNfLjEdo0WM73Bdd1ZbYT+NOMkaiNRaUtbO/hphm6GyCU4ZnpHOzg0fSO8Fz/pnUj2mHkOsgqg0JZeo1BIhSiskZU1Ijpu/Vxqbg+SIWS9krVIi4uO38RXC5dLv+QSs2wOAmmNKsai2Gc0LmJ++QGwfVgE9plEvtcctBCtywgKZKGYlBtTzuPCh4E3j8k57jZTOilpW7Q0V/c8tx2/i14bTkW35Zth3H+5PAfsnyLvNZkd+AI7u19AUWtoXWqE76BAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/35cc04cdf951d744502d56f88b8dcc2d/a6d36/argo_image_5.png"
        srcset="/static/35cc04cdf951d744502d56f88b8dcc2d/222b7/argo_image_5.png 163w,
/static/35cc04cdf951d744502d56f88b8dcc2d/ff46a/argo_image_5.png 325w,
/static/35cc04cdf951d744502d56f88b8dcc2d/a6d36/argo_image_5.png 650w,
/static/35cc04cdf951d744502d56f88b8dcc2d/e548f/argo_image_5.png 975w,
/static/35cc04cdf951d744502d56f88b8dcc2d/3c492/argo_image_5.png 1300w,
/static/35cc04cdf951d744502d56f88b8dcc2d/2176f/argo_image_5.png 3622w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0370606aaddcab5ff077738387912ecf/91010/argo_image_6.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 55.21472392638037%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVR42oVSi26DMBDj//9u2rpSWqAUCK8kJDxLJ9W7g3bqOrZFspSn7fPFeQ8iRGmOwzHBxgsIPl62e7ztfGz3IV53B6jagMf1esXa4H1lWxR1A0dICWkMwlSgqCSMbTAOZ2S1RljkKCuFcRzx32BShjNME6bLBzQRlaqGbjr05wtsP0BIjbRUUKaF7QY0/fgvnCiXyJRBQg8DUcFPKxzSElGuaE8j1xbHTOKQlN+RrsNZSMoZPL8jrTS5btGNZ5wKEqPzI4kzQhJ4vPuImTDMFtxVAnIZc6lti35YCHndUNnDeUImzQ8DX4Ss5sU5dicxlyfoMpeYUwy262cCJjyRs5LOle0Wx1yZWEgfHc+EbpRhE8aobq3ng2R22MG2AzjnkCBIpKAGnShbl+642sClxnm0fip5yeUeOJeTUIalsXPn4kJjS5F49B89It2Twzl3EvEFR/WU4Rq485K+Uku5xeSAHwYsemtg+FdT1sBdzuhf5rL+9fEa4SfBgDbsuSU5+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/0370606aaddcab5ff077738387912ecf/a6d36/argo_image_6.png"
        srcset="/static/0370606aaddcab5ff077738387912ecf/222b7/argo_image_6.png 163w,
/static/0370606aaddcab5ff077738387912ecf/ff46a/argo_image_6.png 325w,
/static/0370606aaddcab5ff077738387912ecf/a6d36/argo_image_6.png 650w,
/static/0370606aaddcab5ff077738387912ecf/e548f/argo_image_6.png 975w,
/static/0370606aaddcab5ff077738387912ecf/3c492/argo_image_6.png 1300w,
/static/0370606aaddcab5ff077738387912ecf/91010/argo_image_6.png 3492w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bc23d2fb3ec2db415deacd902ef736e5/e2d4c/argo_image_7.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 59.50920245398773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABhklEQVR42pVSi27bMBDz///csBZN+rCdpLEty3rajptmeXA8JQW2Nh0yAcRBJ4lH3in78ZhjrTo8lks8PBd4eClxN3/BjHH2XGKeL3A4HiHreDzhdDrh85q272hDjzhtkSnj4PsBS6VQKw0Xe2ymCaEfsdKeccB+v09kh/0vHA67L4RS5Awgm7Y7bN93JB3RdBYdK/WbN4TxDToMMHGA9hGdH+Cjgwsafpy+IFyQrVqLqvOQWDYGed2hIF615B3WPCsuuaI2vGORV/pbZAVJ0uXGJEKJC6INkUo3sFS4UAaGauP4sT8Xv4bsWlIKLPlIIOQl99oFWh5SLJW5nfBDYWU9DHunfZ/ya+2gXMSrtIYFbifkZbEkw+g3U7Io+dp4qotoWeQvy5/sX7fcdJy4SwpbG1OuoWJH8pr5nOdzFniyATMO70/Sb3u4aDUsv1B3sSwQu6vL4zRMdf4VN/WwYXWxV7F3MoS1qOVfrVz8vymnv0a0JLQkMVQpKu5o9Z62f9Ji8Q/C36l1f2aV09ZXAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/bc23d2fb3ec2db415deacd902ef736e5/a6d36/argo_image_7.png"
        srcset="/static/bc23d2fb3ec2db415deacd902ef736e5/222b7/argo_image_7.png 163w,
/static/bc23d2fb3ec2db415deacd902ef736e5/ff46a/argo_image_7.png 325w,
/static/bc23d2fb3ec2db415deacd902ef736e5/a6d36/argo_image_7.png 650w,
/static/bc23d2fb3ec2db415deacd902ef736e5/e548f/argo_image_7.png 975w,
/static/bc23d2fb3ec2db415deacd902ef736e5/3c492/argo_image_7.png 1300w,
/static/bc23d2fb3ec2db415deacd902ef736e5/e2d4c/argo_image_7.png 3618w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/16a958a52039393bf42eae6e882b6987/ea7d0/argo_image_8.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 26.993865030674847%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmUlEQVR42qXM3QqCQBAF4H3/F4sggijCLlwrUMufXV1N0F07zboKVtJNFx9n5gwM2xw8rLZ7rHdH5KWCefbotCEa2lCaManTfe8Yd7faUdN2kHUDdrrGsLxLBD9MECYCUtWQ1QMFyQs1ZCpKpLJERrt1FwVu1PEofcOCOIN1Jq5MhnlJQPfJtH895Aulb4Vjzszv/KP7+fAfL0rydN/tYLeVAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/16a958a52039393bf42eae6e882b6987/a6d36/argo_image_8.png"
        srcset="/static/16a958a52039393bf42eae6e882b6987/222b7/argo_image_8.png 163w,
/static/16a958a52039393bf42eae6e882b6987/ff46a/argo_image_8.png 325w,
/static/16a958a52039393bf42eae6e882b6987/a6d36/argo_image_8.png 650w,
/static/16a958a52039393bf42eae6e882b6987/e548f/argo_image_8.png 975w,
/static/16a958a52039393bf42eae6e882b6987/3c492/argo_image_8.png 1300w,
/static/16a958a52039393bf42eae6e882b6987/ea7d0/argo_image_8.png 3620w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="手动触发" style="position:relative;"><a href="#%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91" aria-label="手动触发 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>手动触发</h2>
<p>使用<code class="language-text">kubectl -n argo create -f workflow.yml</code>创建流水线。</p>
<p>我们简单看下 workflow.yaml 的内容，引用的是 ci-workflow，然后指定了一些参数，包括 app_repo、git_branch、target_branch、container_tag、dockerfile、path。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> ci<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> argo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/workflow-template</span><span class="token punctuation">:</span> ci<span class="token punctuation">-</span>workflow
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app_repo
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"argo-workflows-ci-example"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git_branch
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"main"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> target_branch
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"main"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_tag
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"stable"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_image
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"192.168.1.94:443/my_test/hello-world"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerfile
        <span class="token key atrule">value</span><span class="token punctuation">:</span> Dockerfile
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> path
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"/CI"</span>
  <span class="token key atrule">workflowTemplateRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ci<span class="token punctuation">-</span>workflow</code></pre></div>
<p>再来看看 ci-workflow 是啥？文件位置：bootstrap/workflow-templates/nfs/ci-workflow.yml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkflowTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ci<span class="token punctuation">-</span>workflow
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      A basic CI leveraging Argo Workflows.

      The Workflow<span class="token punctuation">...</span>

      * pulls a repo from git. Specifically pulling a branch based on a pull request; * merges the target branch into it; * modifies the html that will be copied into the container to inject the unique name of the running workflow; * builds a container from a Dockerfile and pushes to a registry; * deploys an Argo CD application that uses the newly<span class="token punctuation">-</span>built container to deploy a static website.

      It does not pretend to be a definitive example<span class="token punctuation">,</span> but it aims to inspire. In order to make this a semi<span class="token punctuation">-</span>usable example<span class="token punctuation">,</span> we have cut a number of security corners. Please don't just blindly run this in production.
    <span class="token key atrule">workflows.argoproj.io/maintainer</span><span class="token punctuation">:</span> <span class="token string">"Pipekit Inc"</span>
    <span class="token key atrule">workflows.argoproj.io/maintainer_url</span><span class="token punctuation">:</span> <span class="token string">"http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git"</span>
    <span class="token key atrule">workflows.argoproj.io/version</span><span class="token punctuation">:</span> <span class="token string">">= 3.3.6"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># This is entirely optional. It allows us to use Prometheus to scrape the metrics from the argo Workflow Controller, and to measure the success of our CI.</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>
      <span class="token comment"># Writes a prometheus metric stating the length of time it took the workflow to complete. Grouped by workflow status and 'type'.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> exec_duration_gauge
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> name
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"ci-workflow"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"pull-request"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> status
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"{{status}}"</span>
        <span class="token key atrule">help</span><span class="token punctuation">:</span> <span class="token string">"Duration gauge by name"</span>
        <span class="token key atrule">gauge</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"{{workflow.duration}}"</span>
          <span class="token key atrule">realtime</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token comment"># If the workflow fails, we increase the Prometheus failure counter by 1.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> result_counter
        <span class="token key atrule">help</span><span class="token punctuation">:</span> <span class="token string">"Count of step execution by result status"</span>
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> status
            <span class="token key atrule">value</span><span class="token punctuation">:</span> Failed
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> name
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"ci-workflow"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"pull-request"</span>
        <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"{{status}} == Failed"</span>
        <span class="token key atrule">counter</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
      <span class="token comment"># If the workflow succeeds, we increase the Prometheus succeeded counter by 1.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> result_counter
        <span class="token key atrule">help</span><span class="token punctuation">:</span> <span class="token string">"Count of step execution by result status"</span>
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> status
            <span class="token key atrule">value</span><span class="token punctuation">:</span> Succeeded
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> name
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"ci-workflow"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"pull-request"</span>
        <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"{{status}} == Succeeded"</span>
        <span class="token key atrule">counter</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> main
  <span class="token comment"># We request an NFS share (called 'workdir') so that we can pull the code, and manipulate it across multiple nodes.</span>
  <span class="token comment"># By the nature of the share, we would be able to access it from multiple nodes at the same time, allowing for parallel nodes.</span>
  <span class="token comment"># We use nfs-server-provisioner for this, which uses disk on the Kubernetes node to provision the share. The PVCs are cleaned up when the workflow finishes.</span>
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> workdir
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>csi
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token comment"># The container build step copies the code from the NFS share to this ephemeral volume, and then runs the build.</span>
  <span class="token comment"># We do this a) because NFS shares are slow and b) to allow us to run another workflow step alongside the build if we wish.</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>cert
      <span class="token key atrule">secret</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretName</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>cert
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>config
      <span class="token key atrule">secret</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretName</span><span class="token punctuation">:</span> registry<span class="token punctuation">-</span>auth
        <span class="token key atrule">items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> .dockerconfigjson
            <span class="token key atrule">path</span><span class="token punctuation">:</span> config.json
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment"># You can set default parameters here if you prefer. If you simply don't inject them when calling this template, the defaults will come through.</span>
      <span class="token comment"># We default 'container_tag' to 'stable' here.</span>
  <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app_repo
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git_branch
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> target_branch
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_tag
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"stable"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_image
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerfile
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> path
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>
        <span class="token comment"># All the steps in this DAG are referencing external templates.</span>
        <span class="token comment"># This allows us to re-use those templates in other workflows, and also makes this CI workflow quite tidy.</span>
        <span class="token comment"># For reference we have also included a 'local' template (delete-application) to show that it's possible to mix-and-match local and external templates.</span>
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main
      <span class="token key atrule">dag</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
            <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
              <span class="token key atrule">template</span><span class="token punctuation">:</span> main
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
            <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
              <span class="token key atrule">template</span><span class="token punctuation">:</span> main
            <span class="token key atrule">depends</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
            <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
              <span class="token key atrule">template</span><span class="token punctuation">:</span> main
            <span class="token key atrule">depends</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
            <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
              <span class="token key atrule">template</span><span class="token punctuation">:</span> main
            <span class="token key atrule">depends</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> delete<span class="token punctuation">-</span>application
            <span class="token key atrule">template</span><span class="token punctuation">:</span> delete<span class="token punctuation">-</span>application
            <span class="token key atrule">depends</span><span class="token punctuation">:</span> (deploy<span class="token punctuation">-</span>application.Failed)
    <span class="token comment"># This only runs if deploy-application fails. This allows us to ensure that we have a tidy environment for the next Workflow run.</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> delete<span class="token punctuation">-</span>application
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">action</span><span class="token punctuation">:</span> delete
        <span class="token key atrule">manifest</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: final-application
            namespace: argocd</span></code></pre></div>
<p>注意：相比官方的文件，我增加了 docker-config、harbor-cert 两个 volumes，这个很重要，后面再讲。</p>
<p>可以看到 workflow 的定义有参数的定义，正好对应我们运行流水线时，传入的参数。</p>
<p>重点看一下 tasks 部署，应用了一些其他的 template。这些 template 也是在 bootstrap/workflow-templates/nfs 下。</p>
<p>通过 depends 的定义，可以看到流水线的执行过程，</p>
<p>git-checkout-pr → html-modifier → container-build → deploy-application</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
    <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
      <span class="token key atrule">template</span><span class="token punctuation">:</span> main
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
    <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
      <span class="token key atrule">template</span><span class="token punctuation">:</span> main
    <span class="token key atrule">depends</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
    <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
      <span class="token key atrule">template</span><span class="token punctuation">:</span> main
    <span class="token key atrule">depends</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
    <span class="token key atrule">templateRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
      <span class="token key atrule">template</span><span class="token punctuation">:</span> main
    <span class="token key atrule">depends</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> delete<span class="token punctuation">-</span>application
    <span class="token key atrule">template</span><span class="token punctuation">:</span> delete<span class="token punctuation">-</span>application
    <span class="token key atrule">depends</span><span class="token punctuation">:</span> (deploy<span class="token punctuation">-</span>application.Failed)</code></pre></div>
<h3 id="git-checkout-pr" style="position:relative;"><a href="#git-checkout-pr" aria-label="git checkout pr permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>git-checkout-pr</h3>
<p>由于我的服务器连不上 github，我 clone 了一个，放到自建的 gitlab，然后创建 token 下载。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkflowTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      Clones a git repository and then performs a git checkout of a branch defined in the workflow workflow.parameters. Then merges in a defined target branch.
    <span class="token key atrule">workflows.argoproj.io/maintainer</span><span class="token punctuation">:</span> <span class="token string">"Pipekit Inc"</span>
    <span class="token key atrule">workflows.argoproj.io/maintainer_url</span><span class="token punctuation">:</span> <span class="token string">"https://github.com/pipekit/argo-workflows-ci-example"</span>
    <span class="token key atrule">workflows.argoproj.io/version</span><span class="token punctuation">:</span> <span class="token string">">= 3.3.6"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> main
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main
      <span class="token key atrule">dag</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
            <span class="token key atrule">template</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>checkout<span class="token punctuation">-</span>pr
      <span class="token key atrule">container</span><span class="token punctuation">:</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine<span class="token punctuation">:</span>latest
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> sh
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
            apk --update add git
            cd /workdir
            echo "Start Clone of source branch"
            git clone http://gitlab-token:xxxx@192.168.80.36/xxxxx/{{workflow.parameters.app_repo}}.git
            cd {{workflow.parameters.app_repo}}
            ## These lines are a hack just for the example.
            git config --global --add safe.directory /workdir/{{workflow.parameters.app_repo}}
            git config --global user.email "sales@pipekit.io"
            git config --global user.name "Tim Collins"
            git checkout {{workflow.parameters.git_branch}}
            echo "Merge in target branch"
            git merge origin/{{workflow.parameters.target_branch}}
            echo "Complete."</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"workdir"</span>
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /workdir
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 250Mi
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 4m
      <span class="token comment">#20 minutes</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">1200</span></code></pre></div>
<h3 id="html-modifier" style="position:relative;"><a href="#html-modifier" aria-label="html modifier permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>html-modifier</h3>
<p>这个步骤是模拟修改、提交。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkflowTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      Performs a sed command to inject the current running Workflow name into a given file.
    <span class="token key atrule">workflows.argoproj.io/maintainer</span><span class="token punctuation">:</span> <span class="token string">"Pipekit Inc"</span>
    <span class="token key atrule">workflows.argoproj.io/maintainer_url</span><span class="token punctuation">:</span> <span class="token string">"https://github.com/pipekit/argo-workflows-ci-example"</span>
    <span class="token key atrule">workflows.argoproj.io/version</span><span class="token punctuation">:</span> <span class="token string">">= 3.3.6"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> main
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main
      <span class="token key atrule">dag</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
            <span class="token key atrule">template</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>modifier
      <span class="token key atrule">container</span><span class="token punctuation">:</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">:</span>latest
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> /bin/bash
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
            cd /workdir/{{workflow.parameters.app_repo}}/CI</span>

            if grep <span class="token punctuation">-</span>q CHANGEMEPLEASE index.html; then
              cat index.html <span class="token punctuation">|</span> sed <span class="token punctuation">-</span>E 's/CHANGEMEPLEASE/<span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.name<span class="token punctuation">}</span><span class="token punctuation">}</span> and it used nfs<span class="token punctuation">-</span>server<span class="token punctuation">-</span>provisioner for artifact passing./g' <span class="token punctuation">></span> tmp_index.html
              mv tmp_index.html index.html
            else
              echo "CHANGEMEPLEASE was not found in index.html. Exiting"
              exit 1
            fi

            cat index.html

        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> workdir
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /workdir
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
      <span class="token comment">#20 minutes</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">1200</span></code></pre></div>
<h3 id="container-build" style="position:relative;"><a href="#container-build" aria-label="container build permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>container-build</h3>
<p>当我再尝试 jenkins 打包镜像时，也遇到 buildkit:v0.18.2-rootless，打包失败的问题和上传镜像失败的问题。因为我的 harbor 的证书是自签的，才会遇到这个。如果你的都是标准的，不会遇到这些问题。</p>
<p>经过千辛万苦的尝试，最终还是解决了。通过增加 harbor-ca.crt 和 config.json，</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkflowTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      Uses Buildkit to build a container image within Kubernetes.
    <span class="token key atrule">workflows.argoproj.io/maintainer</span><span class="token punctuation">:</span> <span class="token string">"Pipekit Inc"</span>
    <span class="token key atrule">workflows.argoproj.io/maintainer_url</span><span class="token punctuation">:</span> <span class="token string">"https://github.com/pipekit/argo-workflows-ci-example"</span>
    <span class="token key atrule">workflows.argoproj.io/version</span><span class="token punctuation">:</span> <span class="token string">">= 3.3.6"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> main
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main
      <span class="token key atrule">dag</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
            <span class="token key atrule">template</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
      <span class="token key atrule">container</span><span class="token punctuation">:</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> moby/buildkit<span class="token punctuation">:</span>v0.18.2<span class="token punctuation">-</span>rootless
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> sh
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
            echo "Retrieving git clone..." &amp;&amp; cp -R /workdir/{{workflow.parameters.app_repo}} /container-build</span>

            mkdir <span class="token punctuation">-</span>p /home/user/.docker

            buildctl<span class="token punctuation">-</span>daemonless.sh build \
            <span class="token punctuation">-</span><span class="token punctuation">-</span>frontend \
            dockerfile.v0 \
            <span class="token punctuation">-</span><span class="token punctuation">-</span>local \
            context=/container<span class="token punctuation">-</span>build/<span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.app_repo<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.path<span class="token punctuation">}</span><span class="token punctuation">}</span> \
            <span class="token punctuation">-</span><span class="token punctuation">-</span>local \
            dockerfile=/container<span class="token punctuation">-</span>build/<span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.app_repo<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.path<span class="token punctuation">}</span><span class="token punctuation">}</span> \
            <span class="token punctuation">-</span><span class="token punctuation">-</span>opt filename=<span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.dockerfile<span class="token punctuation">}</span><span class="token punctuation">}</span> \
            <span class="token punctuation">-</span><span class="token punctuation">-</span>output \
            type=image<span class="token punctuation">,</span>name=<span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.container_image<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span>workflow.parameters.container_tag<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>push=true<span class="token punctuation">,</span>registry.insecure=true
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> BUILDKITD_FLAGS
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>oci<span class="token punctuation">-</span>worker<span class="token punctuation">-</span>no<span class="token punctuation">-</span>process<span class="token punctuation">-</span>sandbox
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container<span class="token punctuation">-</span>build
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /container<span class="token punctuation">-</span>build
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> workdir
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /workdir
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>config
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/user/.docker/config.json
            <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.json
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>cert
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs/harbor<span class="token punctuation">-</span>ca.crt
            <span class="token key atrule">subPath</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>ca.crt
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">seccompProfile</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> Unconfined
          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
          <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment">#20 minutes</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">1200</span></code></pre></div>
<p>harbor-ca.crt 创建</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment">## download ca</span>
openssl s_client <span class="token parameter variable">-showcerts</span> <span class="token parameter variable">-connect</span> <span class="token number">192.168</span>.1.94:443 <span class="token operator">&lt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-outform</span> PEM <span class="token operator">></span> harbor-ca.crt

kubectl create secret generic harbor-ca-cert --from-file<span class="token operator">=</span>harbor-ca.crt<span class="token operator">=</span>/etc/ssl/certs/harbor-ca.crt</code></pre></div>
<p>config.json 创建</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl create secret docker-registry registry-auth --docker-server<span class="token operator">=</span>https://192.168.1.94:443 --docker-username<span class="token operator">=</span>admin --docker-password<span class="token operator">=</span>Harbor12345</code></pre></div>
<h3 id="deploy-application" style="position:relative;"><a href="#deploy-application" aria-label="deploy application permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy-application</h3>
<p>最后创建了一个 argo 的 application，用于部署。通过 application 的 status.health.status，判断是否部署成功。部署失败，会删除这个应用，这个功能是在</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkflowTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">workflows.argoproj.io/description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      Leverages Argo Workflows' ability to interact directly with Kubernetes to deploy an Argo CD Application.
      It monitors the health status of the application and is only considered 'done' once the Argo CD
      Application reports itself as healthy.
    <span class="token key atrule">workflows.argoproj.io/maintainer</span><span class="token punctuation">:</span> <span class="token string">"Pipekit Inc"</span>
    <span class="token key atrule">workflows.argoproj.io/maintainer_url</span><span class="token punctuation">:</span> <span class="token string">"https://github.com/pipekit/argo-workflows-ci-example"</span>
    <span class="token key atrule">workflows.argoproj.io/version</span><span class="token punctuation">:</span> <span class="token string">">= 3.3.6"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> main
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main
      <span class="token key atrule">dag</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
            <span class="token key atrule">template</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>application
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">action</span><span class="token punctuation">:</span> create
        <span class="token key atrule">successCondition</span><span class="token punctuation">:</span> status.health.status == Healthy
        <span class="token key atrule">failureCondition</span><span class="token punctuation">:</span> status.health.status == Degraded
        <span class="token key atrule">manifest</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: final-application
            finalizers:
              - resources-finalizer.argocd.argoproj.io
            namespace: argocd
          spec:
            destination:
              namespace: final-application
              server: 'https://kubernetes.default.svc'
            project: default
            source:
              path: bootstrap/final-application
              repoURL: 'http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git'
              targetRevision: HEAD
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - PrunePropagationPolicy=background
                - PruneLast=true
                - CreateNamespace=true</span></code></pre></div>
<h3 id="delete-application" style="position:relative;"><a href="#delete-application" aria-label="delete application permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>delete-application</h3>
<p>是在 ci-workflow.yml 里定义的。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">    - name: delete-application
      resource:
        action: delete
        manifest: <span class="token operator">|</span>
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: final-application
            namespace: argocd</code></pre></div>
<p>一切顺利的话，可以看到下面的执行的流水线和详细的执行过程。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/70c57dc4451d7f13bf59c9b52e2e1696/7bbaa/argo_image_9.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 24.539877300613497%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVR42p2QXQ6CMBCEe/97GH0wxkQBz2IAQa2ipSA/EpXCuBRFosYHm3yZ3ezstCkbDEdY+hyrDUdd1yhV1XErFanS+k7fp71EdrmCjSdTRGkOEcU4ZQVEnEImGdVnRKRSk2tPnL40yYu2p/mzb2Bz00JzFN0Q0qK9PcDlR3hBCD+QnX6jP/N2Auu9AJsZhg6sqjbQoTCXhg4Xuv6tnz5mWos2kP5P0tPtR+C/3AGnl3Ztp9Cl8gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/70c57dc4451d7f13bf59c9b52e2e1696/a6d36/argo_image_9.png"
        srcset="/static/70c57dc4451d7f13bf59c9b52e2e1696/222b7/argo_image_9.png 163w,
/static/70c57dc4451d7f13bf59c9b52e2e1696/ff46a/argo_image_9.png 325w,
/static/70c57dc4451d7f13bf59c9b52e2e1696/a6d36/argo_image_9.png 650w,
/static/70c57dc4451d7f13bf59c9b52e2e1696/e548f/argo_image_9.png 975w,
/static/70c57dc4451d7f13bf59c9b52e2e1696/3c492/argo_image_9.png 1300w,
/static/70c57dc4451d7f13bf59c9b52e2e1696/7bbaa/argo_image_9.png 4082w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e168629731dabaca262c5354e68ad114/79da4/argo_image_10.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABgElEQVR42nWS2W7CQAxF8/9f1NfSly5qoRVL9qVk3yAFErLe2oGqBCUjXXmizJzxtS2IuoXFWsYnaSVrWEoavkQVHysJ86WE/eGEpmlR1g2qG5V1jaKsUFQ1coopnYuzAwQv3sOJUrjxDi5FP9lDc0IoWx9zw4LqBDDdCMaNdCeCfb3jJBlsuuNR5LuCzoe8GBxvZfkJXg0Dsh1cIFfxXrVDpD8n8Oq6DvkpR5EXOFPWwj2IpTGQHnk3LSjONLBpGjRtiyMDy7K3PgrkSwx6VGVsbI++hw5UKkmaHVFTRgzkevKq6IEJYAyRQE+qgs12HJgQsM+QLB/ZblWRRixrbgjzanemKZRpOLD8DzygJEjTdjiXF9go8K9JL4aON13v4do9sK8hZUjjQwn2jeFVT1nmsZlJGywsg5qT9FkP/0cIaEQs28W345M8mLSPdtk4UCfgs6xCuhuZ4VjFkMwtRGNL0YZM8qPddFO4yzzU+gSQy2DSrHJ5rCDB+tvHw1zELw5TMbVgpOveAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/e168629731dabaca262c5354e68ad114/a6d36/argo_image_10.png"
        srcset="/static/e168629731dabaca262c5354e68ad114/222b7/argo_image_10.png 163w,
/static/e168629731dabaca262c5354e68ad114/ff46a/argo_image_10.png 325w,
/static/e168629731dabaca262c5354e68ad114/a6d36/argo_image_10.png 650w,
/static/e168629731dabaca262c5354e68ad114/e548f/argo_image_10.png 975w,
/static/e168629731dabaca262c5354e68ad114/3c492/argo_image_10.png 1300w,
/static/e168629731dabaca262c5354e68ad114/79da4/argo_image_10.png 3946w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>发生错误，可以点开该节点，看到详细的报错信息。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d5757fd7cf032011966c90330494f293/d20e4/argo_image_11.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkUlEQVR42n2T6Y6CQBCEef+32TfY/bPrXooXyo1yyOXFISoDtT0T3ZiIklRSA5NvuqsHaTgz0J+qGCoaxqqJCUkmP5hq6E/m+CH1yb8PJvCjFGfW4HA8CeWHI+mEojoh2WUI1ztIHm1arBK4YQqXvB9voC1DzBcBPnUfihNAJT9b+NDdEJYfw/Ai+MkW8ZYgpGCzx4pgHCqZQQLrIu5NP4G9SoV+7QAGvXMu6+s+w4ux3hcAWrQtUJYlsizHqWaQrBvgrWzSt21D9yPhb79x4CYrwBgDI2J5qFBRBA156RGMg94MDaoXdgJ5hXVdE7TBmSq7Pg+AKaZugFdDfQrk/bZNiyIvUBQlatbRshnEIrMv28KHZVKm8d2BV2DbNMRssdtnQozWHUAaAkGUuU4ZOgJuPmmZ51ZVR5Qk1pWhyM9LII/oXjpLAq5F1ffAHPW5FhVyKA27eyg8P81bYTqS4bgRrJvr8g+kDtJdjizPceDViSkfBbz72tCEraXbmd9VXrQWf5es6BjPDfSGCl56Mv4AfjsxDD191jkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/d5757fd7cf032011966c90330494f293/a6d36/argo_image_11.png"
        srcset="/static/d5757fd7cf032011966c90330494f293/222b7/argo_image_11.png 163w,
/static/d5757fd7cf032011966c90330494f293/ff46a/argo_image_11.png 325w,
/static/d5757fd7cf032011966c90330494f293/a6d36/argo_image_11.png 650w,
/static/d5757fd7cf032011966c90330494f293/e548f/argo_image_11.png 975w,
/static/d5757fd7cf032011966c90330494f293/3c492/argo_image_11.png 1300w,
/static/d5757fd7cf032011966c90330494f293/d20e4/argo_image_11.png 3906w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>workflow template 的定义</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/64717c22149c85640d1617d51ab1e8eb/2170d/argo_image_12.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 54.601226993865026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdUlEQVR42oVSTU/DMAzN//8TaAeGRtlgQ0LaBXHgB3BCGtoBtJUNWMvWNs13jZ02hZYhKj3ZdeyXZ8fsZDCAp9UGHh4X8J6k4CoAbSwY646if6Zt/Z8L5cGGowg4Osk+g226h4wL2OccDkXp/Z84NGd5KVukWQEZ2gI5KIdNZ9fgv6rCBAFaW5BKA0dfad2CYgphUY3DNgIMKiZbIRTWsmg88XxUkOLtWhuQUkEppI8FCIxJpXzLRBqgMN9fQr4ywE5HF7D55LCM3+Blu8N5WF/MhfCK+oR0bp1rQQLIOleTs7NoAnGaw3JNhAneZluFvl0koyLyyRKhawgI2hhvq0AYXc4gTr4Jg8ISFQZ1nZn1FZqewuH5GF7T4hdhwUuvNDxEwL+Eo8lVp2V6tbKZIc2MFIZiQ/jjUQgCc9n0Zg7rJDvSsqwJ0Td+mW1ruwrrf4drR6RsfnsHq49DQ7jzgycy7nfSdF6a0F8bitEOZlzC/eIZvgCvYVAl52R98AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/64717c22149c85640d1617d51ab1e8eb/a6d36/argo_image_12.png"
        srcset="/static/64717c22149c85640d1617d51ab1e8eb/222b7/argo_image_12.png 163w,
/static/64717c22149c85640d1617d51ab1e8eb/ff46a/argo_image_12.png 325w,
/static/64717c22149c85640d1617d51ab1e8eb/a6d36/argo_image_12.png 650w,
/static/64717c22149c85640d1617d51ab1e8eb/e548f/argo_image_12.png 975w,
/static/64717c22149c85640d1617d51ab1e8eb/3c492/argo_image_12.png 1300w,
/static/64717c22149c85640d1617d51ab1e8eb/2170d/argo_image_12.png 4092w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>最终结果，final-application 是一个 argo appliction，所以也能在页面上看到</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/26e7fb90997b2c0e72e3a02d5083f81c/bf9d2/argo_image_13.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 39.263803680981596%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABN0lEQVR42n1QiW6DMAzl//9uWkc1GmBQCDkhHKXrob45YWzdVBXpYTs+np+jzS5HVnLEZN+SDJskxcs2IT9FzJa38+WCZ9/pfIZse5jhgKjRBrJzKHkDbVsM44R5PqI0CqWUsLbD9Xp9OvB2u/0gmj9P8FDUKEyHllim4wm6H1FJE95sP6EbZ8Ih5Bf/L9w3okJYcOOwly1YpZBUEjvCR6MhbI+GkNYaKeVYrZBx8sn62keI8sbglZWIi4o2GaHdiJyaKtPCTYfA6mNFN+oo77cshEFGQ3MiyvlCsiLyxcleBNaaNl2LOUlV3UBbOipUdHSHnobZfsAH1eykBdMdmGqR+Z51oP/5LTNugqRVVi40at2iItzHhdDhBFuy7xTHdBrW/Bv4EPXS+Hu35XbpShgkq6DmXvIXK2RXbHFLB2AAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/26e7fb90997b2c0e72e3a02d5083f81c/a6d36/argo_image_13.png"
        srcset="/static/26e7fb90997b2c0e72e3a02d5083f81c/222b7/argo_image_13.png 163w,
/static/26e7fb90997b2c0e72e3a02d5083f81c/ff46a/argo_image_13.png 325w,
/static/26e7fb90997b2c0e72e3a02d5083f81c/a6d36/argo_image_13.png 650w,
/static/26e7fb90997b2c0e72e3a02d5083f81c/e548f/argo_image_13.png 975w,
/static/26e7fb90997b2c0e72e3a02d5083f81c/3c492/argo_image_13.png 1300w,
/static/26e7fb90997b2c0e72e3a02d5083f81c/bf9d2/argo_image_13.png 3602w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="代码触发" style="position:relative;"><a href="#%E4%BB%A3%E7%A0%81%E8%A7%A6%E5%8F%91" aria-label="代码触发 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码触发</h2>
<p>项目在 hera 文件下提供了 python 代码调用的方式，<code class="language-text">python hera/nfs/workflow.py</code>， 入口函数是在 workflow.py 里。</p>
<p>制定了参数和引用的 workflow，引用的 workflow 是 ci_workflow.py 里的 ci_workflow</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> ci_workflow <span class="token keyword">import</span> ci_workflow

<span class="token keyword">with</span> Workflow<span class="token punctuation">(</span>
    generate_name<span class="token operator">=</span><span class="token string">"hera-ci-workflow-"</span><span class="token punctuation">,</span>
    namespace<span class="token operator">=</span><span class="token string">"argo"</span><span class="token punctuation">,</span>
    labels<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'argoworkflows.argoproj.io/workflow-template'</span><span class="token punctuation">:</span> <span class="token string">'hera-ci-workflow'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    arguments<span class="token operator">=</span><span class="token punctuation">[</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"app_repo"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"argo-workflows-ci-example"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"git_branch"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"target_branch"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container_tag"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"stable"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container_image"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"k3d-registry.localhost:5000/hello-world"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"dockerfile"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"Dockerfile"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"path"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">"/CI"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    workflow_template_ref<span class="token operator">=</span>ci_workflow
<span class="token punctuation">)</span> <span class="token keyword">as</span> workflow<span class="token punctuation">:</span>
    workflow<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>workflow<span class="token punctuation">.</span>get_workflow_link<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># get a link for monitoring</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Waiting for workflow to complete"</span><span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<p>再来看看 ci_workflow.py。从其他 4 个 py 文件里，引入了 5 个 workflowtemplate，和上面 yaml 的定义过程是一样的。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> git_checkout_pr <span class="token keyword">import</span> git_checkout_pr
<span class="token keyword">from</span> html_modifier <span class="token keyword">import</span> html_modifier
<span class="token keyword">from</span> container_build <span class="token keyword">import</span> container_build
<span class="token keyword">from</span> deploy_application <span class="token keyword">import</span> deploy_application<span class="token punctuation">,</span> deploy_application_manifest

<span class="token keyword">with</span> WorkflowTemplate<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">"hera-ci-workflow"</span><span class="token punctuation">,</span>
    entrypoint<span class="token operator">=</span><span class="token string">"main"</span><span class="token punctuation">,</span>
    volume_claim_templates<span class="token operator">=</span><span class="token punctuation">[</span>
        m<span class="token punctuation">.</span>PersistentVolumeClaim<span class="token punctuation">(</span>
            metadata<span class="token operator">=</span>m<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"workdir"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            spec<span class="token operator">=</span>m<span class="token punctuation">.</span>PersistentVolumeClaimSpec<span class="token punctuation">(</span>
                access_modes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'ReadWriteMany'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                storage_class_name<span class="token operator">=</span><span class="token string">'nfs'</span><span class="token punctuation">,</span>
                resources<span class="token operator">=</span>m<span class="token punctuation">.</span>ResourceRequirements<span class="token punctuation">(</span>
                    requests<span class="token operator">=</span><span class="token punctuation">{</span>
                        <span class="token string">"storage"</span><span class="token punctuation">:</span> m<span class="token punctuation">.</span>Quantity<span class="token punctuation">(</span>__root__<span class="token operator">=</span><span class="token string">"1Gi"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment"># The container build step copies the code from the NFS share to this ephemeral volume, and then runs the build.</span>
        <span class="token comment"># We do this a) because NFS shares are slow and b) to allow us to run another workflow step alongside the build if we wish.</span>
    volumes<span class="token operator">=</span><span class="token punctuation">[</span>EmptyDirVolume<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container-build"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    arguments<span class="token operator">=</span><span class="token punctuation">[</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"app_repo"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"git_branch"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"target_branch"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container_tag"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container_image"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"dockerfile"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Parameter<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"path"</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    annotations<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'workflows.argoproj.io/description'</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">'''A basic CI leveraging Argo Workflows.

The Workflow...

* pulls a repo from git. Specifically pulling a branch based on a pull request;
* merges the target branch into it;
* modifies the html that will be copied into the container to inject the unique name of the running workflow;
* builds a container from a Dockerfile and pushes to a registry;
* deploys an Argo CD application that uses the newly-built container to deploy a static website.

It does not pretend to be a definitive example, but it aims to inspire. In order to make this a semi-usable example, we have cut a number of security corners. Please don't just blindly run this in production.
'''</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> ci_workflow<span class="token punctuation">:</span>
    delete_application_resource <span class="token operator">=</span> Resource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"delete-application"</span><span class="token punctuation">,</span>
                  action<span class="token operator">=</span><span class="token string">"delete"</span><span class="token punctuation">,</span>
                  manifest<span class="token operator">=</span>deploy_application_manifest
                  <span class="token punctuation">)</span>
    <span class="token keyword">with</span> DAG<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"main"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> main<span class="token punctuation">:</span>
        git_checkout_pr_task <span class="token operator">=</span> git_checkout_pr<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"git-checkout-pr"</span><span class="token punctuation">)</span>
        html_modifier_task <span class="token operator">=</span> html_modifier<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"html-modifier"</span><span class="token punctuation">)</span>
        container_build_task <span class="token operator">=</span> container_build<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container-build"</span><span class="token punctuation">)</span>
        deploy_application_task <span class="token operator">=</span> deploy_application<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"deploy-application"</span><span class="token punctuation">)</span>
        delete_application_task <span class="token operator">=</span> delete_application_resource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"delete-application"</span><span class="token punctuation">,</span> depends<span class="token operator">=</span><span class="token string">"deploy-application.Failed"</span><span class="token punctuation">)</span>
        git_checkout_pr_task <span class="token operator">>></span> html_modifier_task <span class="token operator">>></span> container_build_task <span class="token operator">>></span> deploy_application_task

ci_workflow<span class="token punctuation">.</span>to_file<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    ci_workflow<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> AlreadyExists<span class="token punctuation">:</span>
    ci_workflow<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<p>重点看一下，流程的定义，使用 DAG 定义的有向无环图。<code class="language-text">git_checkout_pr_task >> html_modifier_task >> container_build_task >> deploy_application_task</code>，hera 通过重载<a href="https://github.com/argoproj-labs/hera/blob/f3c7a0198760160d8f758dba7e145ae3c519f7b8/src/hera/workflows/task.py#L106">rshift</a> 实现了类似 pipeline 的调用。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">with</span> DAG<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"main"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> main<span class="token punctuation">:</span>
        git_checkout_pr_task <span class="token operator">=</span> git_checkout_pr<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"git-checkout-pr"</span><span class="token punctuation">)</span>
        html_modifier_task <span class="token operator">=</span> html_modifier<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"html-modifier"</span><span class="token punctuation">)</span>
        container_build_task <span class="token operator">=</span> container_build<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container-build"</span><span class="token punctuation">)</span>
        deploy_application_task <span class="token operator">=</span> deploy_application<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"deploy-application"</span><span class="token punctuation">)</span>
        delete_application_task <span class="token operator">=</span> delete_application_resource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"delete-application"</span><span class="token punctuation">,</span> depends<span class="token operator">=</span><span class="token string">"deploy-application.Failed"</span><span class="token punctuation">)</span>
        git_checkout_pr_task <span class="token operator">>></span> html_modifier_task <span class="token operator">>></span> container_build_task <span class="token operator">>></span> deploy_application_task</code></pre></div>
<h3 id="git_checkout_pr" style="position:relative;"><a href="#git_checkout_pr" aria-label="git_checkout_pr permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>git_checkout_pr</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">git_checkout_script <span class="token operator">=</span> <span class="token triple-quoted-string string">'''apk --update add git

cd /workdir
echo "Start Clone of source branch"
git clone https://github.com/pipekit/{{workflow.parameters.app_repo}}.git
cd {{workflow.parameters.app_repo}}

## These lines are a hack just for the example.
git config --global --add safe.directory /workdir/{{workflow.parameters.app_repo}}
git config --global user.email "sales@pipekit.io"
git config --global user.name "Tim Collins"

git checkout {{workflow.parameters.git_branch}}

echo "Merge in target branch"
git merge origin/{{workflow.parameters.target_branch}}

echo "Complete."
'''</span>

git_checkout_pr <span class="token operator">=</span> Container<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"git-checkout-pr"</span><span class="token punctuation">,</span>
               image<span class="token operator">=</span><span class="token string">"alpine:latest"</span><span class="token punctuation">,</span>
               command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> git_checkout_script<span class="token punctuation">]</span><span class="token punctuation">,</span>
               volume_mounts<span class="token operator">=</span><span class="token punctuation">[</span>
                   m<span class="token punctuation">.</span>VolumeMount<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"workdir"</span><span class="token punctuation">,</span>
                                 mount_path<span class="token operator">=</span><span class="token string">"/workdir"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               resources<span class="token operator">=</span>Resources<span class="token punctuation">(</span>memory_request<span class="token operator">=</span><span class="token string">"250Mi"</span><span class="token punctuation">,</span> cpu_request<span class="token operator">=</span><span class="token string">"4m"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               active_deadline_seconds<span class="token operator">=</span><span class="token number">1200</span><span class="token punctuation">)</span>
</code></pre></div>
<h3 id="html_modifier" style="position:relative;"><a href="#html_modifier" aria-label="html_modifier permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>html_modifier</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">html_modifier_script <span class="token operator">=</span> <span class="token triple-quoted-string string">'''cd /workdir/{{workflow.parameters.app_repo}}/CI

if grep -q CHANGEMEPLEASE index.html; then
  cat index.html | sed -E 's/CHANGEMEPLEASE/{{workflow.name}} and it used nfs-server-provisioner for artifact passing./g' > tmp_index.html
  mv tmp_index.html index.html
else
  echo "CHANGEMEPLEASE was not found in index.html. Exiting"
  exit 1
fi

cat index.html
'''</span>

html_modifier <span class="token operator">=</span> Container<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"html-modifier"</span><span class="token punctuation">,</span>
                               image<span class="token operator">=</span><span class="token string">"ubuntu:latest"</span><span class="token punctuation">,</span>
                               command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> html_modifier_script<span class="token punctuation">]</span><span class="token punctuation">,</span>
                               volume_mounts<span class="token operator">=</span><span class="token punctuation">[</span>
                                   m<span class="token punctuation">.</span>VolumeMount<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"workdir"</span><span class="token punctuation">,</span>
                                                 mount_path<span class="token operator">=</span><span class="token string">"/workdir"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               resources<span class="token operator">=</span>Resources<span class="token punctuation">(</span>memory_request<span class="token operator">=</span><span class="token string">"256Mi"</span><span class="token punctuation">,</span> cpu_request<span class="token operator">=</span><span class="token string">"100m"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               active_deadline_seconds<span class="token operator">=</span><span class="token number">1200</span><span class="token punctuation">)</span>
</code></pre></div>
<h3 id="container_build" style="position:relative;"><a href="#container_build" aria-label="container_build permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>container_build</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">container_build_script <span class="token operator">=</span> <span class="token triple-quoted-string string">'''echo "Retrieving git clone..." &amp;&amp; cp -R /workdir/{{workflow.parameters.app_repo}} /container-build &amp;&amp; \
buildctl-daemonless.sh build \
--frontend \
dockerfile.v0 \
--local \
context=/container-build/{{workflow.parameters.app_repo}}{{workflow.parameters.path}} \
--local \
dockerfile=/container-build/{{workflow.parameters.app_repo}}{{workflow.parameters.path}} \
--opt filename={{workflow.parameters.dockerfile}} \
--output \
type=image,name={{workflow.parameters.container_image}}:{{workflow.parameters.container_tag}},push=true,registry.insecure=true
'''</span>

<span class="token comment"># Uses Buildkit to build a container image within Kubernetes.</span>
container_build <span class="token operator">=</span> Container<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container-build"</span><span class="token punctuation">,</span>
                            image<span class="token operator">=</span><span class="token string">"moby/buildkit:v0.12.3-rootless"</span><span class="token punctuation">,</span>
                            command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> container_build_script<span class="token punctuation">]</span><span class="token punctuation">,</span>
                            env<span class="token operator">=</span><span class="token punctuation">[</span>
                                Env<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"BUILDKITD_FLAGS"</span><span class="token punctuation">,</span>
                                    value<span class="token operator">=</span><span class="token string">"--oci-worker-no-process-sandbox"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            volume_mounts<span class="token operator">=</span><span class="token punctuation">[</span>
                                m<span class="token punctuation">.</span>VolumeMount<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"container-build"</span><span class="token punctuation">,</span>
                                              mount_path<span class="token operator">=</span><span class="token string">"/container-build"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                m<span class="token punctuation">.</span>VolumeMount<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"workdir"</span><span class="token punctuation">,</span>
                                              mount_path<span class="token operator">=</span><span class="token string">"/workdir"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            resources<span class="token operator">=</span>Resources<span class="token punctuation">(</span>memory_request<span class="token operator">=</span><span class="token string">"1Gi"</span><span class="token punctuation">,</span> cpu_request<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            security_context<span class="token operator">=</span>m<span class="token punctuation">.</span>SecurityContext<span class="token punctuation">(</span>seccomp_profile<span class="token operator">=</span>m<span class="token punctuation">.</span>SeccompProfile<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"Unconfined"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                               run_as_user<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
                                                               run_as_group<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            active_deadline_seconds<span class="token operator">=</span><span class="token number">1200</span><span class="token punctuation">)</span>
</code></pre></div>
<h3 id="deploy_application" style="position:relative;"><a href="#deploy_application" aria-label="deploy_application permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy_application</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">deploy_application_manifest <span class="token operator">=</span> <span class="token triple-quoted-string string">'''apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: final-application
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  namespace: argocd
spec:
  destination:
    namespace: final-application
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    path: bootstrap/final-application
    repoURL: 'http://192.168.80.36/zhangcheng/argo-workflows-ci-example.git'
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - PrunePropagationPolicy=background
      - PruneLast=true
      - CreateNamespace=true
'''</span>

deploy_application <span class="token operator">=</span> Resource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"deploy-application"</span><span class="token punctuation">,</span>
                              action<span class="token operator">=</span><span class="token string">"create"</span><span class="token punctuation">,</span>
                              success_condition<span class="token operator">=</span><span class="token string">"status.health.status == Healthy"</span><span class="token punctuation">,</span>
                              failure_condition<span class="token operator">=</span><span class="token string">"status.health.status == Degraded"</span><span class="token punctuation">,</span>
                              manifest<span class="token operator">=</span>deploy_application_manifest
                              <span class="token punctuation">)</span>
</code></pre></div>
<h3 id="delete_application_resource" style="position:relative;"><a href="#delete_application_resource" aria-label="delete_application_resource permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>delete_application_resource</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">  delete_application_resource <span class="token operator">=</span> Resource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"delete-application"</span><span class="token punctuation">,</span>
                action<span class="token operator">=</span><span class="token string">"delete"</span><span class="token punctuation">,</span>
                manifest<span class="token operator">=</span>deploy_application_manifest
                <span class="token punctuation">)</span>
</code></pre></div></div></div></div><div class="max-w-4xl mx-auto mt-8"><div class="giscus"></div></div><div class="hidden lg:block fixed left-4 top-32 w-64"><div class="bg-white p-4 rounded-lg shadow-lg" style="max-height:calc(100vh - 12rem);overflow-y:auto"><h3 class="font-bold mb-2 text-left">目录: </h3><div class="text-left"><ul>
<li>
<p><a href="#argo-cicd">argo ci/cd</a></p>
</li>
<li>
<p><a href="#%E6%B3%A8%E6%84%8F">注意</a></p>
</li>
<li>
<p><a href="#%E5%BC%80%E5%A7%8B">开始</a></p>
<ul>
<li>
<p><a href="#%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91">手动触发</a></p>
<ul>
<li><a href="#git-checkout-pr">git-checkout-pr</a></li>
<li><a href="#html-modifier">html-modifier</a></li>
<li><a href="#container-build">container-build</a></li>
<li><a href="#deploy-application">deploy-application</a></li>
<li><a href="#delete-application">delete-application</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%BB%A3%E7%A0%81%E8%A7%A6%E5%8F%91">代码触发</a></p>
<ul>
<li><a href="#git_checkout_pr">git_checkout_pr</a></li>
<li><a href="#html_modifier">html_modifier</a></li>
<li><a href="#container_build">container_build</a></li>
<li><a href="#deploy_application">deploy_application</a></li>
<li><a href="#delete_application_resource">delete_application_resource</a></li>
</ul>
</li>
</ul>
</li>
</ul></div></div></div></div><footer class="text-center py-4 mt-8 border-t">© 2025 · Built with Gatsby</footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2025-02-13-argo-ci-cd/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-ec515adc39aa7430d310.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-051f7e1a395ea4ec2b2a.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-093de8076e2cf835e1d3.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-c34369a01a85b628d9ac.js\"],\"component---src-pages-links-js\":[\"/component---src-pages-links-js-7666f811b66803f137c5.js\"],\"component---src-pages-tags-js\":[\"/component---src-pages-tags-js-512d381bd81244b1af9c.js\"],\"component---src-pages-using-ssr-js\":[\"/component---src-pages-using-ssr-js-005fd2817f4487ca3dc9.js\"],\"component---src-templates-blog-list-js\":[\"/component---src-templates-blog-list-js-5fadf6a59ac6c5cfa4ee.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-9498a20d0ef2eefd61ce.js\"],\"component---src-templates-tags-js\":[\"/component---src-templates-tags-js-13eab85942606ca6630c.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="7d877e823468a4de5503";</script><script src="/webpack-runtime-7789ddc4cd9085cabb24.js" async></script><script src="/framework-6a525285796fb83f2864.js" async></script><script src="/app-ec515adc39aa7430d310.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>