<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.1"/><style data-href="/styles.91d60bbab44133089581.css" data-identity="gatsby-global-css">*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*
! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com
*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}:host,html{-webkit-text-size-adjust:100%;font-feature-settings:normal;-webkit-tap-highlight-color:transparent;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-variation-settings:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{line-height:inherit}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}code,kbd,pre,samp{font-feature-settings:normal;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-variation-settings:normal}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-feature-settings:inherit;color:inherit;font-family:inherit;font-size:100%;font-variation-settings:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]:where(:not([hidden=until-found])){display:none}.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.25em}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){border-inline-start-color:var(--tw-prose-quote-borders);border-inline-start-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-inline-start:1em;quotes:"\201C""\201D""\2018""\2019"}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}.prose :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}.prose :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}.prose :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}.prose :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){display:block;margin-bottom:2em;margin-top:2em}.prose :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px 0 rgb(var(--tw-prose-kbd-shadows)/10%);color:var(--tw-prose-kbd);font-family:inherit;font-size:.875em;font-weight:500;padding-inline-end:.375em;padding-bottom:.1875em;padding-top:.1875em;padding-inline-start:.375em}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:"`"}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding-inline-end:1.1428571em;padding-bottom:.8571429em;padding-top:.8571429em;padding-inline-start:1.1428571em}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:transparent;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:none}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;width:100%}.prose :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}.prose :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-inline-start:.5714286em;vertical-align:bottom}.prose :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}.prose :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:baseline}.prose :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}.prose :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}.prose :where(th,td):not(:where([class~=not-prose],[class~=not-prose] *)){text-align:start}.prose :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:rgba(0,0,0,.5);--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}.prose :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-top:.5714286em;padding-inline-start:.5714286em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.prose-lg{font-size:1.125rem;line-height:1.7777778}.prose-lg :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.prose-lg :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.2222222em;line-height:1.4545455;margin-bottom:1.0909091em;margin-top:1.0909091em}.prose-lg :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.6666667em;margin-top:1.6666667em;padding-inline-start:1em}.prose-lg :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:2.6666667em;line-height:1;margin-bottom:.8333333em;margin-top:0}.prose-lg :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.6666667em;line-height:1.3333333;margin-bottom:1.0666667em;margin-top:1.8666667em}.prose-lg :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.3333333em;line-height:1.5;margin-bottom:.6666667em;margin-top:1.6666667em}.prose-lg :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){line-height:1.5555556;margin-bottom:.4444444em;margin-top:1.7777778em}.prose-lg :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose-lg :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;font-size:.8888889em;padding-inline-end:.4444444em;padding-bottom:.2222222em;padding-top:.2222222em;padding-inline-start:.4444444em}.prose-lg :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em}.prose-lg :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8666667em}.prose-lg :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em}.prose-lg :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.375rem;font-size:.8888889em;line-height:1.75;margin-bottom:2em;margin-top:2em;padding-inline-end:1.5em;padding-bottom:1em;padding-top:1em;padding-inline-start:1.5em}.prose-lg :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.prose-lg :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.prose-lg :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.6666667em;margin-top:.6666667em}.prose-lg :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.prose-lg :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.prose-lg :where(.prose-lg>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.prose-lg :where(.prose-lg>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(.prose-lg>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.prose-lg :where(.prose-lg>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(.prose-lg>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.prose-lg :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.prose-lg :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.prose-lg :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.prose-lg :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.6666667em;padding-inline-start:1.5555556em}.prose-lg :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:3.1111111em;margin-top:3.1111111em}.prose-lg :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5}.prose-lg :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-inline-start:.75em}.prose-lg :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose-lg :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose-lg :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-top:.75em;padding-inline-start:.75em}.prose-lg :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose-lg :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose-lg :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.prose-lg :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose-lg :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5;margin-top:1em}.prose-lg :where(.prose-lg>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose-lg :where(.prose-lg>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.fixed{position:fixed}.relative{position:relative}.left-4{left:1rem}.top-0{top:0}.top-32{top:8rem}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:.25rem}.mt-8{margin-top:2rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.w-12{width:3rem}.w-64{width:16rem}.w-full{width:100%}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-7xl{max-width:80rem}.max-w-none{max-width:none}.scroll-mt-32{scroll-margin-top:8rem}.list-disc{list-style-type:disc}.list-none{list-style-type:none}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-left:calc(1rem*(1 - var(--tw-space-x-reverse)));margin-right:calc(1rem*var(--tw-space-x-reverse))}.space-x-7>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-left:calc(1.75rem*(1 - var(--tw-space-x-reverse)));margin-right:calc(1.75rem*var(--tw-space-x-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(1rem*var(--tw-space-y-reverse));margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)))}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.border{border-width:1px}.border-t{border-top-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.object-cover{-o-object-fit:cover;object-fit:cover}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-2{padding-bottom:.5rem;padding-top:.5rem}.py-4{padding-bottom:1rem;padding-top:1rem}.py-8{padding-top:2rem}.pb-8,.py-8{padding-bottom:2rem}.pl-4{padding-left:1rem}.pt-20{padding-top:5rem}.text-left{text-align:left}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-lg{font-size:1.125rem}.text-lg,.text-xl{line-height:1.75rem}.text-xl{font-size:1.25rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow{--tw-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color)}.shadow,.shadow-lg{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition-colors{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-shadow{transition-duration:.15s;transition-property:box-shadow;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-300{transition-duration:.3s}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity,1))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.hover\:text-gray-900:hover{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.hover\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.hover\:shadow-lg:hover,.hover\:shadow-md:hover{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\:shadow-md:hover{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}@media (min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:block{display:block}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f8f9fa;border:1px solid #e2e8f0;border-radius:6px;margin:1em 0;padding:1em}code[class*=language-],pre[class*=language-]{color:#24292e;font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:14px;line-height:1.5;text-shadow:none}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#6a737d}.token.punctuation{color:#24292e}.token.boolean,.token.constant,.token.number,.token.property,.token.symbol,.token.tag{color:#005cc5}.token.attr-name,.token.builtin,.token.char,.token.selector,.token.string{color:#032f62}.language-css .token.string,.style .token.string,.token.atrule,.token.attr-value,.token.entity,.token.keyword,.token.operator,.token.url{color:#d73a49}.token.function{color:#6f42c1}.token.important,.token.regex,.token.variable{color:#e36209}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]{scroll-margin-top:5rem}:root{--border-radius:4px;--color-text:#333;--color-primary:#7026b9;--color-code-bg:#fff4db;--color-code:#8a6534;--font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";--font-mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--font-lg:18px;--font-md:16px;--font-sm:14px;--font-sx:12px;--line-height-loose:1.75;--line-height-normal:1.5;--line-height-dense:1.1;--space-1:4px;--space-2:8px;--space-3:16px;--space-4:24px;--space-5:32px;--space-6:64px;--size-content:54rem;--size-gutter:var(--space-5);--size-gap:var(--space-6)}html{-webkit-text-size-adjust:100%;box-sizing:border-box;font:sans-serif;font-size:var(--font-md);line-height:var(--line-height-normal);overflow-y:scroll}body{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;word-wrap:break-word;color:var(--color-text);font-family:sans-serif;font-family:var(--font-sans);font-weight:400;margin:0}a{background-color:transparent;color:var(--color-primary);font-weight:500;text-decoration:none;text-decoration:underline;text-decoration-thickness:1.5px;text-underline-offset:2px}a:active,a:hover{outline-width:0;text-decoration:none}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{letter-spacing:-.01em;line-height:var(--line-height-dense);margin:0 0 3rem;padding:0}h1>b{color:var(--color-primary)}img{border-style:none;max-width:100%}code,kbd,pre,samp{font-family:var(--font-mono);font-size:1em;line-height:inherit}hr{background:rgba(0,0,0,.2);border:none;box-sizing:content-box;height:1px;margin-bottom:calc(var(--space-4) - 1px);margin-left:0;margin-right:0;margin-top:0;overflow:visible;padding:0}*,:after,:before{box-sizing:inherit}dd,dl,fieldset,figure,hgroup,img,ol,p,ul{margin:0;margin-bottom:var(--space-4);padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin-left:var(--space-4)}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:var(--border-radius);font-size:.875rem;line-height:var(--line-height-normal);margin-bottom:var(--space-4);margin-left:0;margin-right:0;margin-top:0;overflow:auto;padding:var(--space-4)}b,dt,strong,th{font-weight:700}li{margin-bottom:calc(var(--space-4)/2)}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:calc(var(--space-4)/2);margin-left:var(--space-4);margin-top:calc(var(--space-4)/2)}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:calc(var(--space-4)/2)}p{max-width:680px}code,kbd,samp{font-size:.875rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}code,tt{background-color:var(--color-code-bg);border-radius:var(--border-radius);color:var(--color-code);font-family:var(--font-mono);padding-bottom:.25em;padding-top:.25em;word-break:normal}pre code{background:none}code:after,code:before,tt:after,tt:before{content:"\00a0";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:none}</style><style type="text/css">
    .toc-anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .toc-anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .toc-anchor svg,
    h2 .toc-anchor svg,
    h3 .toc-anchor svg,
    h4 .toc-anchor svg,
    h5 .toc-anchor svg,
    h6 .toc-anchor svg {
      visibility: hidden;
    }
    h1:hover .toc-anchor svg,
    h2:hover .toc-anchor svg,
    h3:hover .toc-anchor svg,
    h4:hover .toc-anchor svg,
    h5:hover .toc-anchor svg,
    h6:hover .toc-anchor svg,
    h1 .toc-anchor:focus svg,
    h2 .toc-anchor:focus svg,
    h3 .toc-anchor:focus svg,
    h4 .toc-anchor:focus svg,
    h5 .toc-anchor:focus svg,
    h6 .toc-anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="bg-white shadow-lg fixed w-full top-0 z-50"><div class="max-w-6xl mx-auto px-4"><div class="flex justify-center"><div class="flex space-x-7"><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/">首页</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/tags/">标签</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/about/">关于</a><a class="flex items-center py-4 px-2 text-gray-700 hover:text-gray-900" href="/links/">友链</a></div></div></div></nav><div class="text-center" style="margin:0 auto;max-width:var(--size-content);padding:var(--size-gutter)"><main class="pt-20"></main></div><div class="max-w-7xl mx-auto px-4 py-8 relative" style="padding-top:6rem;margin-top:-6rem"><div class="max-w-4xl mx-auto" style="scroll-margin-top:6rem"><h1 class="text-4xl font-bold mb-4">otlp学习笔记</h1><div class="prose prose-lg max-w-none"><div><h1 id="otlp" style="position:relative;"><a href="#otlp" aria-label="otlp permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OTLP</h1>
<ul>
<li><a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/metrics/api.md#meterprovider">MeterProvider</a> is the entry point of the API. It provides access to Meters
<ul>
<li>API MeterProvider only provides ability to create a Meter</li>
<li>SDK MeterProvider accepts configuration for Resource association, metric processing, and exporters</li>
</ul>
</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/metrics/api.md#meter">Meter</a> is responsible for creating Instruments</li>
</ul>
<p><a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/metrics/api.md#instrument">Instrument</a> is responsible for reporting <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/metrics/api.md#measurement">Measurements</a></p>
<h1 id="eu-2023" style="position:relative;"><a href="#eu-2023" aria-label="eu 2023 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EU 2023</h1>
<p>使用的基础设施</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">observability<span class="token punctuation">-</span>backend           grafana<span class="token punctuation">-</span>65888b98d<span class="token punctuation">-</span>lvdv8                                      1/1     Running     0               25d
observability<span class="token punctuation">-</span>backend           loki<span class="token punctuation">-</span>0                                                       1/1     Running     0               25d
observability<span class="token punctuation">-</span>backend           mimir<span class="token punctuation">-</span>0                                                      1/1     Running     0               25d
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>9d57bfcfc<span class="token punctuation">-</span>ngrkd                               1/1     Running     0               19m
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>0                                     1/1     Running     3 (3m44s ago)   4m2s
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>1                                     1/1     Running     0               4m2s
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>2                                     1/1     Running     2 (3m45s ago)   4m2s
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>targetallocator<span class="token punctuation">-</span>668cbf96bc<span class="token punctuation">-</span>26dhc                1/1     Running     0               4m2s
observability<span class="token punctuation">-</span>backend           otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>targetallocator<span class="token punctuation">-</span>668cbf96bc<span class="token punctuation">-</span>vc4rn                1/1     Running     0               4m2s
observability<span class="token punctuation">-</span>backend           tempo<span class="token punctuation">-</span>694776547f<span class="token punctuation">-</span>99rr8                                       1/1     Running     0               25d</code></pre></div>
<p>使用 opentelemetry-operator.yaml 0.74 版本</p>
<p>安装完出现两个crd</p>
<p>It manages two <code class="language-text">CustomResourceDefinition</code>s (CRDs):</p>
<ul>
<li><code class="language-text">opentelemetrycollectors.opentelemetry.io</code>, short name <code class="language-text">otelcol</code></li>
<li><code class="language-text">instrumentations.opentelemetry.io</code>, short name <code class="language-text">otelinst</code></li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">❯ k get crd <span class="token operator">|</span> <span class="token function">grep</span> opentelemetry
instrumentations.opentelemetry.io                     <span class="token number">2025</span>-01-17T07:45:30Z
opentelemetrycollectors.opentelemetry.io              <span class="token number">2025</span>-01-17T07:45:31Z</code></pre></div>
<h2 id="otelcol" style="position:relative;"><a href="#otelcol" aria-label="otelcol permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>otelcol</h2>
<p>部署下面的yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.74.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment <span class="token comment"># statefulset, daemonset, sidecar</span>
  <span class="token key atrule">autoscaler</span><span class="token punctuation">:</span>
    <span class="token key atrule">targetCPUUtilization</span><span class="token punctuation">:</span> <span class="token number">90</span>
    <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token punctuation">...</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span> <span class="token comment"># contains OpenTelemetry collector configuration</span>
    <span class="token key atrule">receivers</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp</span><span class="token punctuation">:</span>
        <span class="token key atrule">protocols</span><span class="token punctuation">:</span>
          <span class="token key atrule">grpc</span><span class="token punctuation">:</span>
          <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">logging</span><span class="token punctuation">:</span>

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>logging<span class="token punctuation">]</span></code></pre></div>
<p>会出现一个svc</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">❯ kubectl get svc otel<span class="token punctuation">-</span>collector <span class="token punctuation">-</span>n observability<span class="token punctuation">-</span>backend
NAME             TYPE        CLUSTER<span class="token punctuation">-</span>IP     EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)                       AGE
otel<span class="token punctuation">-</span>collector   ClusterIP   10.233.2.244   &lt;none<span class="token punctuation">></span>        4317/TCP<span class="token punctuation">,</span>4318/TCP<span class="token punctuation">,</span>55681/TCP   8m20s</code></pre></div>
<p>增加如下内容</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">    <span class="token key atrule">receivers</span><span class="token punctuation">:</span>
      <span class="token key atrule">jaeger</span><span class="token punctuation">:</span>
        <span class="token key atrule">protocols</span><span class="token punctuation">:</span>
          <span class="token key atrule">grpc</span><span class="token punctuation">:</span>
          <span class="token key atrule">thrift_binary</span><span class="token punctuation">:</span>
          <span class="token key atrule">thrift_compact</span><span class="token punctuation">:</span>
          <span class="token key atrule">thrift_http</span><span class="token punctuation">:</span>
        
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">,</span> jaeger<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>memory_limiter<span class="token punctuation">,</span> batch<span class="token punctuation">]</span></code></pre></div>
<p>会出现两个svc</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">❯ kubectl get svc <span class="token punctuation">|</span>grep otel<span class="token punctuation">-</span>collector
otel<span class="token punctuation">-</span>collector              ClusterIP   10.233.2.244    &lt;none<span class="token punctuation">></span>        14250/TCP<span class="token punctuation">,</span>6832/UDP<span class="token punctuation">,</span>6831/UDP<span class="token punctuation">,</span>14268/TCP<span class="token punctuation">,</span>4317/TCP<span class="token punctuation">,</span>4318/TCP<span class="token punctuation">,</span>55681/TCP   10m
otel<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>headless     ClusterIP   None            &lt;none<span class="token punctuation">></span>        14250/TCP<span class="token punctuation">,</span>6832/UDP<span class="token punctuation">,</span>6831/UDP<span class="token punctuation">,</span>14268/TCP<span class="token punctuation">,</span>4317/TCP<span class="token punctuation">,</span>4318/TCP<span class="token punctuation">,</span>55681/TCP   10m
otel<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>monitoring   ClusterIP   10.233.31.250   &lt;none<span class="token punctuation">></span>        8888/TCP                                                            10m</code></pre></div>
<h2 id="otelinst" style="position:relative;"><a href="#otelinst" aria-label="otelinst permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>otelinst</h2>
<p>The operator use pod mutating webhook to inject auto-instrumentation libraries into starting pods. The webhook adds an init container that copies auto-instrumentation libraries into a volume that is mounted as well to the application container and it configures runtime (e.g. in JVM via <code class="language-text">JAVA_TOOL_OPTIONS</code>) to load the libraries.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Instrumentation
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>instrumentation
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">exporter</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
  <span class="token key atrule">propagators</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> tracecontext
    <span class="token punctuation">-</span> baggage
    <span class="token punctuation">-</span> b3
  <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> parentbased_traceidratio
    <span class="token key atrule">argument</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">resource</span><span class="token punctuation">:</span>
    <span class="token key atrule">addK8sUIDAttributes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">python</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># Required if endpoint is set to 4317.</span>
      <span class="token comment"># Python autoinstrumentation uses http/proto by default</span>
      <span class="token comment"># so data must be sent to 4318 instead of 4317.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_ENDPOINT
        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4318</span>
  <span class="token key atrule">java</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_LOGS_EXPORTER
        <span class="token key atrule">value</span><span class="token punctuation">:</span> otlp</code></pre></div>
<p>增加注解</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># js</span>
kubectl patch deployment frontend-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-sdk":"true"}}}} }'</span>
<span class="token comment"># python</span>
kubectl patch deployment backend1-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-python":"true"}}}} }'</span>
<span class="token comment"># java</span>
kubectl patch deployment backend2-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-java":"true"}}}} }'</span></code></pre></div>
<p>完整的调用关系</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">flowchart</span> LR
    <span class="token keyword">subgraph</span> namespace<span class="token operator">:</span> observability-backend
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> collector
            OC<span class="token text string">{OTel Collector}</span>
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> mimir
            OC <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">metrics</span><span class="token arrow operator">--></span></span>Mimir
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> loki
            OC <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">logs</span><span class="token arrow operator">--></span></span>Loki
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> tempo
            OC <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">traces</span><span class="token arrow operator">--></span></span>Tempo
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> grafana
            grafana<span class="token arrow operator">-.-></span>Mimir
            grafana<span class="token arrow operator">-.-></span>Loki
            grafana<span class="token arrow operator">-.-></span>Tempo
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token keyword">subgraph</span> namespace<span class="token operator">:</span> app
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> loadgen
            LG<span class="token text string">((loadgen))</span>
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> frontend
            LG <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">http</span><span class="token arrow operator">--></span></span> F<span class="token text string">((frontend))</span> <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">metrics,traces</span><span class="token arrow operator">--></span></span> OC
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> backend1
            F <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">http</span><span class="token arrow operator">--></span></span> B1<span class="token text string">((backend1))</span> <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">metrics,traces</span><span class="token arrow operator">--></span></span> OC
        <span class="token keyword">end</span>
        <span class="token keyword">subgraph</span> pod<span class="token operator">:</span> backend2
            F <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">http</span><span class="token arrow operator">--></span></span> B2<span class="token text string">((backend2))</span> <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">logs,metrics,traces</span><span class="token arrow operator">--></span></span> OC
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
</code></pre></div>
<p>前端触发一下，能在grafana里看到，</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/aac6f4e644e8f525a1ea53f071f16696/e6283/otlp_image.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 55.21472392638037%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB80lEQVR42mVTi27bMAz0/3/eCqxrEzSJ45dsWbb18Nu5HZWmGDABBCyYPN4dqcS7Abo1cM7Ch/AT1jkMjHkK+H3pUNQWITj4cUT4jsHaGM9vj1/nDsnIS6Nb9MOAaZoxzzMmxr7vkPN4PGIENum6Hk2jma9hrcO6rjHvOI4Y+74RkImtMRinCdu2xR/b9gR7nQdjYEPDPGnc9X3MP9hoZ/7KOqmZlxXJuixQSrF7h56JwuTF6t8jjMpCoSxrgluqmeC9wzJPmMZAa0YIuWSeF/rlY4J1Icqd5jV2E0kScjdsWBQV8qyEbgylt2ibCkaVMA0JybeuBXDGPctRVYpFfWQpAxGfRI7IOsiwVi1Ofy74Oqc4n268GzJ1zLesraG1icwTYXZLU2R5QY+6aLzzngya6OfrdKbH5/sF97RARdki31GZdwLaRX/F50QkXm8p8qL48dH7EBm+AJ9TnnD6SAlYRR/LoqavnkNyHOoAVbesMU+GaXqnPy/A4T/AhT7arsX14xMVc0fu7sr99JYTL67Q13eUpzfo+xcSR8rX240+ZmjbNq6QTFSp+nsXH9j2A16XsJc32OwU7Rg5WZnq0BloVUGVOXp+J7ImWc6hyOpQrvggL0XABVDkHgclc0X8YCIreRmS4+RVyavhgxjop/MBfwHEcUoEdoS4zgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/aac6f4e644e8f525a1ea53f071f16696/a6d36/otlp_image.png"
        srcset="/static/aac6f4e644e8f525a1ea53f071f16696/222b7/otlp_image.png 163w,
/static/aac6f4e644e8f525a1ea53f071f16696/ff46a/otlp_image.png 325w,
/static/aac6f4e644e8f525a1ea53f071f16696/a6d36/otlp_image.png 650w,
/static/aac6f4e644e8f525a1ea53f071f16696/e548f/otlp_image.png 975w,
/static/aac6f4e644e8f525a1ea53f071f16696/3c492/otlp_image.png 1300w,
/static/aac6f4e644e8f525a1ea53f071f16696/e6283/otlp_image.png 4096w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>同时我们也看看注入的内容</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_ENDPOINT
      <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4318</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PYTHONPATH
      <span class="token key atrule">value</span><span class="token punctuation">:</span> /otel<span class="token punctuation">-</span>auto<span class="token punctuation">-</span>instrumentation/opentelemetry/instrumentation/auto_instrumentation<span class="token punctuation">:</span>/otel<span class="token punctuation">-</span>auto<span class="token punctuation">-</span>instrumentation
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_TRACES_EXPORTER
      <span class="token key atrule">value</span><span class="token punctuation">:</span> otlp
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_TRACES_PROTOCOL
      <span class="token key atrule">value</span><span class="token punctuation">:</span> http/protobuf
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_METRICS_EXPORTER
      <span class="token key atrule">value</span><span class="token punctuation">:</span> otlp
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_METRICS_PROTOCOL
      <span class="token key atrule">value</span><span class="token punctuation">:</span> http/protobuf
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_SERVICE_NAME
      <span class="token key atrule">value</span><span class="token punctuation">:</span> backend1<span class="token punctuation">-</span>deployment
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_RESOURCE_ATTRIBUTES_POD_NAME
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_RESOURCE_ATTRIBUTES_NODE_NAME
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_PROPAGATORS
      <span class="token key atrule">value</span><span class="token punctuation">:</span> tracecontext<span class="token punctuation">,</span>baggage<span class="token punctuation">,</span>b3
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_TRACES_SAMPLER
      <span class="token key atrule">value</span><span class="token punctuation">:</span> parentbased_traceidratio
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_TRACES_SAMPLER_ARG
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_RESOURCE_ATTRIBUTES
      <span class="token key atrule">value</span><span class="token punctuation">:</span> k8s.container.name=backend1<span class="token punctuation">,</span>k8s.deployment.name=backend1<span class="token punctuation">-</span>deployment<span class="token punctuation">,</span>k8s.namespace.name=tutorial<span class="token punctuation">-</span>application<span class="token punctuation">,</span>k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME)<span class="token punctuation">,</span>k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME)<span class="token punctuation">,</span>k8s.replicaset.name=backend1<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>759d95c666</code></pre></div>
<h3 id="resource-attributes" style="position:relative;"><a href="#resource-attributes" aria-label="resource attributes permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Resource attributes</strong></h3>
<p>资源属性</p>
<p>There are several ways how essential Kubernetes resource attributes (<code class="language-text">Namespace</code>, <code class="language-text">Deployment</code>, <code class="language-text">ReplicaSet</code>, <code class="language-text">Pod</code> name and UIDs) can be collected:</p>
<ul>
<li>The <code class="language-text">Instrumentation</code> CR - operator injects the attributes to the application container via <code class="language-text">OTEL_RESOURCE_ATTRIBUTES</code> env var. The OpenTelemetry SDK used in the auto-instrumentation reads the variable.</li>
<li>The <code class="language-text">OpenTelemetryCollector</code> CR - the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/k8sattributesprocessor">k8sattributesprocessor</a> enriches spans with attributes in the collector</li>
<li>The <code class="language-text">OpenTelemetryCollector</code> CR - in the <code class="language-text">sidecar</code> mode use <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor">resourcedetectionprocessor</a>. The operator sets <code class="language-text">OTEL_RESOURCE_ATTRIBUTES</code> with Kubernetes resource attributes and the variable can be consumed by <code class="language-text">env</code> detector see <a href="https://opentelemetry.io/blog/2022/k8s-metadata/#using-resource-detector-processor">the blog post</a> for more details.</li>
</ul>
<p>修改otelinst，然后重启服务。</p>
<p>Let’s enable collection of Kubernetes UID attributes. Update the <code class="language-text">Instrumentation</code> CR:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl edit instrumentations.opentelemetry.io my-instrumentation -n tutorial-application
spec:
  resource:
    addK8sUIDAttributes: true</code></pre></div>
<p>The resource attributes are injected to the application container, to apply the change on already running applications a restart is required:</p>
<p><code class="language-text">kubectl rollout restart deployment -n tutorial-application -l app=backend1
kubectl rollout restart deployment -n tutorial-application -l app=backend2
kubectl rollout restart deployment -n tutorial-application -l app=frontend</code></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8c9fb34506e70773cd6f16adee5107bc/0e0c4/otlp_image_1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 76.07361963190185%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZElEQVR42nVU2Y6bQBD0/39TlETZhzwlK2WT2LuLzQLm8gDDYY4ZwJVqjCxttLZU6vYc1dXHsGm7Fv7Rx8vrC7bbLdI0xeUyQ35xFuHrj094ePxyw7efn/H96QHH1EesIhR5iXmeeeeCmdi0bYvXZxd/f+/w59cOLzsHcXRCXTULdFGi1NUNmcq5nyLwQzxvHTw9PnOtQBKfkCYKm3EcEbwl8A4R/EO8+K/OHgfXxWhHRr8sCqbpir7vURQaYRjB8wPkRY6mOS9rWusroe/GcJ3jAiEsqwphFKHrOwzDAGvtYoXMGHNdozXrnrVmsX0/fEQYM6pGnCSY5mstG15MmwYFy6O7Djmt+Pn5jIwQX8k+8R9hSD9CTcKG8i0VjV2/BAhPJ6ZUouB6mufIioJ+iY7pdiTsGbRlsPeE+xDe/ggdhlCskaZKU9fQJPC4lmcZShK1JYlYlr6qYUloGHBay/KO8E0IaYs4QaoUFAkMD0pKDv+HJAqoUK8pi7Usi6kb2MHcJ6yZnqRWksAw7UZqREUl6yUYzLUJdrWGe9bcI2TKOTuccMDPvDxP00LmUmHCACmxWK5lLIflfSnLfcJFoUItSnhA9huqFIITLypC/JikBc9YBrxLKE3xRWFwRBgEUGzKKGPC9B02ZU/lB0J8j3uVpMpgg0zEh4Tr2FQqg2bKvUSmCumyYl1LWr3iTIV9fe204ZmJSm+E3iG8EcoTbNuOr6Rf5kqKXtGX7iYMEBMnDrBeh7wiJHU5f+baRt5prkp4boCD84ZjEK5fD2JecVnf8/Kmp8XKf3mK0TFFx+GXj4zgH37Ob7xMSZnPAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/8c9fb34506e70773cd6f16adee5107bc/a6d36/otlp_image_1.png"
        srcset="/static/8c9fb34506e70773cd6f16adee5107bc/222b7/otlp_image_1.png 163w,
/static/8c9fb34506e70773cd6f16adee5107bc/ff46a/otlp_image_1.png 325w,
/static/8c9fb34506e70773cd6f16adee5107bc/a6d36/otlp_image_1.png 650w,
/static/8c9fb34506e70773cd6f16adee5107bc/e548f/otlp_image_1.png 975w,
/static/8c9fb34506e70773cd6f16adee5107bc/3c492/otlp_image_1.png 1300w,
/static/8c9fb34506e70773cd6f16adee5107bc/0e0c4/otlp_image_1.png 1884w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="sampling" style="position:relative;"><a href="#sampling" aria-label="sampling permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Sampling</strong></h3>
<p>采样控制</p>
<p>Sampling in OpenTelemetry SDK and auto-instrumentations is configured via <code class="language-text">OTEL_TRACES_SAMPLER</code> and <code class="language-text">OTEL_TRACES_SAMPLER_ARG</code> environment variables. In our demo these environment variables are configured in the <code class="language-text">Instrumentation</code> CR.</p>
<p>Let’s change the sampling rate (argument) to sample 25% of requests:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl edit instrumentations.opentelemetry.io my-instrumentation -n tutorial-application
# add
spec:
  sampler:
    type: parentbased_traceidratio
    argument: "0.25"</code></pre></div>
<h3 id="pii-and-data-manipulation" style="position:relative;"><a href="#pii-and-data-manipulation" aria-label="pii and data manipulation permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>PII and data manipulation</strong></h3>
<p>The collector can add, change and/or remove data that is flowing through it (spans, attributes etc.). This is useful to extract new attributes that can be later used for querying. Second use-case for data manipulation is to handle personally identifiable information (PII).</p>
<p>The following collector processors can be used for data manipulation:</p>
<ul>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/attributesprocessor">attributesprocessor</a> removes attributes.</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor">filterprocessor</a> removes spans and attributes. It supports regex.</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/redactionprocessor">redactionprocessor</a> deletes span attributes that don’t match a list of allowed span attributes.</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/transformprocessor">transformprocessor</a> modifies telemetry based on configuration using the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/ottl">OpenTelemetry Transformation Language</a>.</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl edit opentelemetrycollectors.opentelemetry.io otel -n observability-backend
# add
  processors:
    attributes:
      actions:
      - key: "http.target"pattern: ^.*\?player=(?P&lt;player>.*)
        action: extract
          
    service:
      pipelines:
        traces:
          processors: [memory_limiter, attributes, batch]</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b16bd1d10603dd4a8c1465e6b71b465d/7d055/otlp_image_2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 55.21472392638037%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB3klEQVR42k2TiY6jMBBE+f+/292RVqNNyMWQEPCNuUlNtSGrQWo1we7n6monU9pAqQYhBLQxInYd2rZN0XV9+vZxdmgah9OhwNetgvc+7SuUQmkMDGu7vscwDMgEVD1rGGPR7x/HccTr9YI8W37BaAL/bUCtFazzeFjHsHC7kF6AcprhQtePWNc1Ad6w9yO/jHLICSyLCpaq2tihZm0gaJwmTAwRkkUuBLY3jJuyt8J5nrEsC9+3zaIwP5QEPqEJ9KwxVDZPsm/FzBj5njlHf+iFhJGTuXEiUGCiWPLCrKsHLp+feBYForeYhw4To4+BawWa81+oIhegp8mBQ2nhGaJumpek8B0TT/ePC1z+C+7rmA7uhh6x71JHkXMIRsMxsoZTLu8PtmGh2JYoVMbB0Z9lVzjMQKhu8Kc/8PczDEXYZNO4HyrdvNJgsqZpcDqfIVmxbfHT0gbL6f0cSqiu8LkAT1wjMFAZVU7SQRrKnMRkdQJeIFl8lGtkCBPjt4mvWLErfAPFdxuSyrhfNfFdarPq+cTxmKOu6wQVTwWmlP5/hRa2E+ihP/6GLzegDVvLEsl3qmzbiEwrg+v1lgBK6yRbJm9+tEweQn1HKA5o6zIVdvQr8trIn0GyWCR2fQNq/ExK5dcsiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/b16bd1d10603dd4a8c1465e6b71b465d/a6d36/otlp_image_2.png"
        srcset="/static/b16bd1d10603dd4a8c1465e6b71b465d/222b7/otlp_image_2.png 163w,
/static/b16bd1d10603dd4a8c1465e6b71b465d/ff46a/otlp_image_2.png 325w,
/static/b16bd1d10603dd4a8c1465e6b71b465d/a6d36/otlp_image_2.png 650w,
/static/b16bd1d10603dd4a8c1465e6b71b465d/e548f/otlp_image_2.png 975w,
/static/b16bd1d10603dd4a8c1465e6b71b465d/3c492/otlp_image_2.png 1300w,
/static/b16bd1d10603dd4a8c1465e6b71b465d/7d055/otlp_image_2.png 3992w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="metrics" style="position:relative;"><a href="#metrics" aria-label="metrics permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Metrics</strong></h2>
<p><strong>Prometheus Target Discovery</strong></p>
<p><strong>Service and Pod Monitors</strong></p>
<p>If you have services already generating metrics for prometheus, the collector can collect those using the prometheus receiver, which scrapes metric endpoints provided in a scrape_config like the one below:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  - job_name: 'otel-collector'scrape_interval: 10s
    static_configs:
      - targets: [ '0.0.0.0:8888' ]</code></pre></div>
<p>This solution works but requires writing out all known targets. When services being deployed are added or changed, it will require updating this configuration. An alternative to this is to set up Prometheus <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/design.md#servicemonitor">Service and Pod Monitors</a>. This allows for discovering metric endpoint dynamically and without needing to modify the collector configuration and restart all collectors.</p>
<p>In order to apply a pod or service monitor, the CRDs need to be installed:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml

kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
``</code></pre></div>
<p><strong>Target Allocator</strong></p>
<p>A service called the <a href="https://github.com/open-telemetry/opentelemetry-operator/blob/main/cmd/otel-allocator/README.md">Target Allocator</a> can use the prometheus service and pod monitor to discover targets. The target allocator discovers the targets and then distributes both discovered and configured targets among available collectors. It must be deployed alongside a Statefulset of collectors.</p>
<p>部署 target allocator</p>
<p>backend/03-collector-prom-cr.yaml</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c307097efcaf88e6e6f96f637780d7d0/70c12/otlp_image_3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 25.766871165644172%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/UlEQVR42lWQC4+CQAyE+f9/zuRQ8XG8QZdF3qggB991uWhyTZrNdNrZaa1jcCCrFHEco7WmKAratqXve5qmYRiGFdd1jVKKsiypqmqtmTD90zTxDsv3fNqm4/V6MY7jSs7zzLIsnyYjbD5IkmRN0/eOLMs+2MxYYRwRRhGX65Vvz13f++PxT7DtulUwEjHDd4ILcfp4Pv+wcB9B98vmvN0SHU84mw2Bc6DNNHmcUKQpjTioLjKkc7zdTvqO1FLTYuIu63p7Bx2GMP1gLFiBbROdT8SSgbPn4rqUSYryfXIZqtVVUnG/3UiFS12PUe65yBaIwywI6PMcOTYz8AvtfXoc7MgdygAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/c307097efcaf88e6e6f96f637780d7d0/a6d36/otlp_image_3.png"
        srcset="/static/c307097efcaf88e6e6f96f637780d7d0/222b7/otlp_image_3.png 163w,
/static/c307097efcaf88e6e6f96f637780d7d0/ff46a/otlp_image_3.png 325w,
/static/c307097efcaf88e6e6f96f637780d7d0/a6d36/otlp_image_3.png 650w,
/static/c307097efcaf88e6e6f96f637780d7d0/e548f/otlp_image_3.png 975w,
/static/c307097efcaf88e6e6f96f637780d7d0/3c492/otlp_image_3.png 1300w,
/static/c307097efcaf88e6e6f96f637780d7d0/70c12/otlp_image_3.png 2110w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>给服务增加service monitor
backend/04-servicemonitors.yaml</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/18c3b1359f6e2941248b1766903a66e3/71c1d/otlp_image_4.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 14.723926380368097%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAjklEQVR42n1O7QrDIAz0/Z9vWqWdLYxWRTtFaBGkvZHA9nOBkFzCfQi9PbC9X9j3HTlnpJTgnIPWmnHvHf+q1orrun5YzM8Fs11YkMRCCDjPE+u6IsbI91IKm1B773nSr7UGay3/qe77htBGwxiDYRiglIKUEsdxYJomvo3jyDsRyZAEyYSSUzLiUIiv4Afre+IMuLSjBgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/18c3b1359f6e2941248b1766903a66e3/a6d36/otlp_image_4.png"
        srcset="/static/18c3b1359f6e2941248b1766903a66e3/222b7/otlp_image_4.png 163w,
/static/18c3b1359f6e2941248b1766903a66e3/ff46a/otlp_image_4.png 325w,
/static/18c3b1359f6e2941248b1766903a66e3/a6d36/otlp_image_4.png 650w,
/static/18c3b1359f6e2941248b1766903a66e3/e548f/otlp_image_4.png 975w,
/static/18c3b1359f6e2941248b1766903a66e3/3c492/otlp_image_4.png 1300w,
/static/18c3b1359f6e2941248b1766903a66e3/71c1d/otlp_image_4.png 1536w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="logs" style="position:relative;"><a href="#logs" aria-label="logs permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Logs</strong></h2>
<p><strong>FileLog receiver</strong></p>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/filelogreceiver">Filelog</a> receiver is one of the various Receivers available on <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib">OpenTelemetry Collector Contrib</a>.</p>
<p>In order to demonstrate the logs instrumentation, we have to get the OpenTelemetry Instance running as a Daemonset:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">  <span class="token key atrule">filelog</span><span class="token punctuation">:</span>
    <span class="token key atrule">include</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/pods/<span class="token important">*/*/*.log</span>
    <span class="token comment">#Each operator fulfills a single responsibility, </span>
    <span class="token comment">#such as reading lines from a file, or parsing JSON </span>
    <span class="token comment">#from a field. Operators are then chained together</span>
    <span class="token comment">#in a pipeline to achieve a desired result.</span>
    <span class="token key atrule">operators</span><span class="token punctuation">:</span>
      <span class="token comment"># Parse CRI-O format</span>
      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> regex_parser
        <span class="token key atrule">id</span><span class="token punctuation">:</span> parser<span class="token punctuation">-</span>crio
        <span class="token key atrule">regex</span><span class="token punctuation">:</span> '^(<span class="token punctuation">?</span>P&lt;time<span class="token punctuation">></span><span class="token punctuation">[</span>^ Z<span class="token punctuation">]</span>+) (<span class="token punctuation">?</span>P&lt;stream<span class="token punctuation">></span>stdout<span class="token punctuation">|</span>stderr) (<span class="token punctuation">?</span>P&lt;logtag<span class="token punctuation">></span><span class="token punctuation">[</span>^ <span class="token punctuation">]</span><span class="token important">*)</span> <span class="token punctuation">?</span><span class="token key atrule">(?P&lt;log>.*)$'output</span><span class="token punctuation">:</span> extract_metadata_from_filepath
        <span class="token key atrule">timestamp</span><span class="token punctuation">:</span>
          <span class="token key atrule">parse_from</span><span class="token punctuation">:</span> attributes.time
          <span class="token key atrule">layout_type</span><span class="token punctuation">:</span> gotime
          <span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">'2006-01-02T15:04:05.999999999Z07:00'</span></code></pre></div>
<p>In order to demonstrate the logs instrumentation, we have to get the OpenTelemetry Instance running as a Daemonset:</p>
<p><img src="https://github.com/pavolloffay/kubecon-eu-2023-opentelemetry-kubernetes-tutorial/raw/main/images/filelog-flow.png" alt="https://github.com/pavolloffay/kubecon-eu-2023-opentelemetry-kubernetes-tutorial/raw/main/images/filelog-flow.png"></p>
<p><strong>OpenTelemetry Collector running as DaemonSet</strong></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/pavolloffay/kubecon-eu-2023-opentelemetry-kubernetes-tutorial/main/backend/05-collector-daemonset.yaml</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e62782d4df8c27bdad749af27c23cb50/92bb4/otlp_image_5.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.809815950920246%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABUklEQVR42mVRaXeCMBDk//84W2sRK4dyyA0WOSPCdDa2/dDmvXnZbJLZ2VnDCY7oxg5D36MnpmnCPM/4u5ZlQZ5lGIYBSZLo/Xq9Is9zrOuKpmkwjiMM23aZLPDJhKAjqbrf/xFKkYyEUtA6HHTcdh0ej4e+v8QxbrcbDGe3Q+x5KKMI1SVGcj6jYCz7OowaGKm67VCEIRSLWi+vSE5n9FWNlaqgFHI/QC+EnrnHh2nibbPBybZ1fNw/cwsfrlQrmPmxjFOoroe53SINI/QkXyYFPBbU0QWqbWG4/Oi8m/CsA/zjUceiULEae39CCGmFKJxIsmfxzPfR0L+cubYqUVBhxzvDO51wZnsxjZbYcV2k3/5UdY2axv94K2dF1ZZlISNZS0VFWephFkXx9NB1HHj0UOCwZZsIg0BPL6LSmGbLAORxVVW/hGmaaiKZviw5S4EvYIgPXrjuH5YAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/e62782d4df8c27bdad749af27c23cb50/a6d36/otlp_image_5.png"
        srcset="/static/e62782d4df8c27bdad749af27c23cb50/222b7/otlp_image_5.png 163w,
/static/e62782d4df8c27bdad749af27c23cb50/ff46a/otlp_image_5.png 325w,
/static/e62782d4df8c27bdad749af27c23cb50/a6d36/otlp_image_5.png 650w,
/static/e62782d4df8c27bdad749af27c23cb50/e548f/otlp_image_5.png 975w,
/static/e62782d4df8c27bdad749af27c23cb50/3c492/otlp_image_5.png 1300w,
/static/e62782d4df8c27bdad749af27c23cb50/92bb4/otlp_image_5.png 1824w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>页面上可以看到日志了</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/fcc26b5d46fe085099a9a99709480466/91945/otlp_image_6.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 42.331288343558285%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMElEQVR42jVS7ZKEIAzz/V/yFFE+VdxbHd3bmVxT5EcG2tI0Abrz/cLrVbELzvPEdV2C+1kvbKUgL4vu788H903csr/r+uA4DnTHcaKUHSllhBgxO4cQApZlRc4Z67rBOa/7nBc9x5VY1lXqgm3T/O/7ja7I9JQTpnnGNFU47xUtNmaE9wHjaGHtpLUow0OImqeAwRh12FFqzEEKQuAqGZU2tXaaYMaxDuBQARWrIxKGSsxhZd/Rfb9fhBT10Dw7RYypkokaxlxJ0GLWaTmmpGSNUBWSkNOtWGPSCJRElNEG1fWD0QG0TqhK6fFitYrw6PuhKfyTglPCdo/NLptJOpBQGjlstFbPURVJ54f8p+/1cVQhX0vlx3rJ1VLWHL8Lm/na7SGYY7xtRcE4yXl+m3+ulFfT8mFhIQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/fcc26b5d46fe085099a9a99709480466/a6d36/otlp_image_6.png"
        srcset="/static/fcc26b5d46fe085099a9a99709480466/222b7/otlp_image_6.png 163w,
/static/fcc26b5d46fe085099a9a99709480466/ff46a/otlp_image_6.png 325w,
/static/fcc26b5d46fe085099a9a99709480466/a6d36/otlp_image_6.png 650w,
/static/fcc26b5d46fe085099a9a99709480466/e548f/otlp_image_6.png 975w,
/static/fcc26b5d46fe085099a9a99709480466/3c492/otlp_image_6.png 1300w,
/static/fcc26b5d46fe085099a9a99709480466/91945/otlp_image_6.png 2944w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="roadmap" style="position:relative;"><a href="#roadmap" aria-label="roadmap permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Roadmap</h2>
<p><strong>OpenTelemetry Operator Roadmap</strong></p>
<p><strong>Golang auto-instrumentation.</strong></p>
<ul>
<li>Adding OpenTelemetry instrumentation to Go applications without having to modify their source code.</li>
</ul>
<p><strong>OpAMP Bridge.</strong></p>
<ul>
<li>Open Agent Management Protocol (OpAMP) is a network protocol for remote management of large fleets of data collection Agents. The complete specification can be found <a href="https://github.com/open-telemetry/opamp-spec/blob/main/specification.md">here</a>.</li>
</ul>
<p><strong>Simplifying the Operator CRDs.</strong></p>
<ul>
<li>In order to get the OpenTelemetryCollector easier to be deployed, we are experimenting an opinionated CRDs, which will have the cofig file declared as parameters.</li>
</ul>
<p><strong>Configuration reload when collector running as Sidecar.</strong></p>
<ul>
<li>When the OpenTelemetryCollector instance is running a sidecar will get reloaded if the config parameter changes</li>
</ul>
<h1 id="na-2023" style="position:relative;"><a href="#na-2023" aria-label="na 2023 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NA 2023</h1>
<p>基础设施</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c2cb265f1626ab6f2f6e249acfd0e2bb/c2d9c/otlp_image_7.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 18.404907975460123%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAu0lEQVR42k2PjQ5EMBCE+/5vJ0FJEKlzNIh/h5Y5u+Jy0zQ7nbZft0LPb/zrvMbPn7c3xmBZFtjjuP1ngbEGx7WmnOa+77DWQqiXwrZtmKaJZ9/3XIdhwLquDCzLEmEYMqwoCgRBgKZpMM8z0jRFlmUYx5EzIWWAOI7hOA5c14Xv+0iSBJ7nMZxUVRW01uwJIKWEUoohBH1U1zVEFEV8KM9zrgSnjLqijC50XcdQEmX0IHVKe/TdR23b4gvGGy+Bbibu7QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/c2cb265f1626ab6f2f6e249acfd0e2bb/a6d36/otlp_image_7.png"
        srcset="/static/c2cb265f1626ab6f2f6e249acfd0e2bb/222b7/otlp_image_7.png 163w,
/static/c2cb265f1626ab6f2f6e249acfd0e2bb/ff46a/otlp_image_7.png 325w,
/static/c2cb265f1626ab6f2f6e249acfd0e2bb/a6d36/otlp_image_7.png 650w,
/static/c2cb265f1626ab6f2f6e249acfd0e2bb/e548f/otlp_image_7.png 975w,
/static/c2cb265f1626ab6f2f6e249acfd0e2bb/3c492/otlp_image_7.png 1300w,
/static/c2cb265f1626ab6f2f6e249acfd0e2bb/c2d9c/otlp_image_7.png 1326w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>使用的是v0.88.0版本的opentelemetry-operator，0.74版本不支持go</p>
<h2 id="auto-instrumentation" style="position:relative;"><a href="#auto-instrumentation" aria-label="auto instrumentation permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Auto-instrumentation</strong></h2>
<p>By today the OpenTelemetry Operator offers two <code class="language-text">CustomResouceDefinitions</code>.</p>
<ol>
<li>The <code class="language-text">v1alpha1.Instrumentation</code> can be used to configure applications that are configured with the OpenTelemetry-SDK and injection of auto-instrumentation libraries. Currently Apache HTTPD, DotNet, Go, Java, Nginx, NodeJS and Python are supported. <a href="https://github.com/open-telemetry/opentelemetry-operator/blob/v0.88.0/README.md#opentelemetry-auto-instrumentation-injection">Readme</a></li>
<li>The <code class="language-text">v1alpha1.OpenTelemetryCollector</code> simplifies the operation of the OpenTelemetry Collector on Kubernetes. There are different deployment modes available, breaking config changes are migrated automatically, provides integration with Prometheus (including operating on Prometheus Operator CRs) and simplifies sidecar injection.</li>
</ol>
<p>apply 这个yaml，</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Instrumentation
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>instrumentation
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">exporter</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//jaeger<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_METRICS_PROTOCOL
      <span class="token key atrule">value</span><span class="token punctuation">:</span> http/protobuf
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
      <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/v1/metrics
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_METRICS_EXPORTER
      <span class="token key atrule">value</span><span class="token punctuation">:</span> otlp
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_LOGS_EXPORTER
      <span class="token key atrule">value</span><span class="token punctuation">:</span> none
  <span class="token key atrule">propagators</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> tracecontext
    <span class="token punctuation">-</span> baggage
    <span class="token punctuation">-</span> b3
  <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> parentbased_traceidratio
    <span class="token key atrule">argument</span><span class="token punctuation">:</span> <span class="token string">"1"</span></code></pre></div>
<p>patch一下deployment</p>
<p>kubectl patch deployment backend2-deployment -n tutorial-application -p ’{“spec”: {“template”:{“metadata”:{“annotations”:{”<a href="http://instrumentation.opentelemetry.io/inject-java%22:%22true">instrumentation.opentelemetry.io/inject-java”:“true</a>”}}}} }’</p>
<p>本地转发</p>
<p>kubectl port-forward -n observability-backend svc/prometheus 8080:80</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d839c34e9aa3f11f20f2e305023460f3/fb51c/otlp_image_8.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.78527607361963%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAklEQVR42o1SXUsDMRDMj1ektKXaKxUEX/wr/gmxfZBTH/UErya7+Zjupo13yl01MOwkOySzTMz1zS0W1RqT2QLnsyUuBGdTqfOl7Ktc51erP1BhernCZH0H87mz+LIWMUb4EBAESECQfUiZ/mvtKOK+Bkz98oqn+hnWOrRti7f3Bk3zgYfHjWCbz5gZRDQK55xoCDEQTCbiJsXUIXW+lCuy5sh/I6ZDj4hh9AUV62GIYRClp3UIpaeTGLWrF3JgOO9AYnsIp3rkjxpy6pB/jDi2TmlKz3svF4pNdamjW6mFq/3vMLgLoB9Q4UXLwo3O309LL9WX+mEUjIWSkn65CMsJe13+qykSYiLZAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/d839c34e9aa3f11f20f2e305023460f3/a6d36/otlp_image_8.png"
        srcset="/static/d839c34e9aa3f11f20f2e305023460f3/222b7/otlp_image_8.png 163w,
/static/d839c34e9aa3f11f20f2e305023460f3/ff46a/otlp_image_8.png 325w,
/static/d839c34e9aa3f11f20f2e305023460f3/a6d36/otlp_image_8.png 650w,
/static/d839c34e9aa3f11f20f2e305023460f3/e548f/otlp_image_8.png 975w,
/static/d839c34e9aa3f11f20f2e305023460f3/3c492/otlp_image_8.png 1300w,
/static/d839c34e9aa3f11f20f2e305023460f3/fb51c/otlp_image_8.png 3816w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>kubectl port-forward -n observability-backend svc/jaeger-query 16686:16686</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/83860065d85622bedc12641f894b48fc/7ed3f/otlp_image_9.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 45.39877300613497%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSElEQVR42p2Sb3KCMBDFuf8RWgH1BF7CE/i10xmsI4qBAElIrKOvb/ljqR/LzI8lu5uXl4QoWa/xvt0iZkyTBOlyiTRNES8WSOJ4gPk3juNpTBYcS99ut8M+y7DZbLBarRBdbzfcr1fMn8cD/36iS1Gg1Bqu6+Cc6+n43YUAKznGwAV98EPOM5LvILkA53+RcdS27SDCJj82F0pBNw1aa9CYFoZ1Ee8XYF2i5rzGWtRjrNhvmI/quu4dBXEShlUOFPw4HvGZ5+SEo65RWIezsU+UExwUxUpGQU+ClknBGNOLKuZOpcaXKnEoFCoKaArOsdPRED86Lukyavhys6IISuFcaTotKVz1E/x4JBNT/0TLRWTrUTdrljMwjJeqQn5RyM4F9txyS+f+RWDOH4fDb/J4cid9sW6Q8/ZPdCmXEl4czpFaf0HW4gdvuaVYgjJQMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/83860065d85622bedc12641f894b48fc/a6d36/otlp_image_9.png"
        srcset="/static/83860065d85622bedc12641f894b48fc/222b7/otlp_image_9.png 163w,
/static/83860065d85622bedc12641f894b48fc/ff46a/otlp_image_9.png 325w,
/static/83860065d85622bedc12641f894b48fc/a6d36/otlp_image_9.png 650w,
/static/83860065d85622bedc12641f894b48fc/e548f/otlp_image_9.png 975w,
/static/83860065d85622bedc12641f894b48fc/3c492/otlp_image_9.png 1300w,
/static/83860065d85622bedc12641f894b48fc/7ed3f/otlp_image_9.png 3830w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>可以在granfa、jaeger分别看到metric、traces</p>
<h2 id="collector-overview" style="position:relative;"><a href="#collector-overview" aria-label="collector overview permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Collector Overview</strong></h2>
<p><img src="https://github.com/pavolloffay/kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial/raw/main/images/otel-collector.png" alt="https://github.com/pavolloffay/kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial/raw/main/images/otel-collector.png"></p>
<p>The OpenTelemetry Collector can be divided into a few major components.</p>
<ul>
<li><strong>Receivers</strong>: Collect data from a specific source, like an application or infrastructure, and convert it into <a href="https://pkg.go.dev/go.opentelemetry.io/collector/consumer/pdata#section-documentation">pData (pipeline data)</a>. This component can be active (e.g. Prometheus) or passive (OTLP).</li>
<li><strong>Processors</strong>: Manipulates the data collected by receivers in some way. For example, a processor might filter out irrelevant data, or add metadata to help with analysis. Examples include the batch or metric renaming processor.</li>
<li><strong>Exporters</strong>: Send data to an external system for storage or analysis. Examples of exporters are Prometheus, Loki or the OTLP exporter.</li>
<li><strong>Extensions</strong>: Add additional functionality to OpenTelemetry collector that is not strictly related to the telemetry data, like configuring a bearer token or offering a Jaeger remote sampling endpoint.</li>
<li><strong>Connectors</strong>: Is both an exporter and receiver. It consumes data as an exporter in one pipeline and emits data as a receiver in another pipeline.</li>
</ul>
<p>The components are composed into <strong>pipelines</strong>, that are separated by signal type (metrics, traces, logs). Each datapoint is then goes through the chain consisting receiver(s) -> processor(s) -> exporter(s). For more details, check the <a href="https://opentelemetry.io/docs/collector/">offical documentation</a>.</p>
<p>apply yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>basic
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.88.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
    processors:
      batch:</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
<h2 id="collecting-prometheus-metrics" style="position:relative;"><a href="#collecting-prometheus-metrics" aria-label="collecting prometheus metrics permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Collecting Prometheus Metrics</strong></h2>
<p>介绍了两种方法。</p>
<h3 id="1-configure-prometheus-target-discovery" style="position:relative;"><a href="#1-configure-prometheus-target-discovery" aria-label="1 configure prometheus target discovery permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>1. Configure Prometheus Target Discovery</strong></h3>
<p>使用传统的<strong>Prometheus Configuration</strong>的方式。</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR<span class="token punctuation">;</span>
  svc<span class="token text string">(Service)</span>
  <span class="token keyword">subgraph</span> OpenTelemetry Collector
    pr<span class="token text string">(Prometheus Receiver)</span>
    pros<span class="token text string">(Processors)</span>
    prw<span class="token text string">(Prometheus Remote Write Exporter)</span>
  <span class="token keyword">end</span>
  prom<span class="token text string">(Prometheus Server)</span>

  pr <span class="token arrow operator">--></span><span class="token label property">| /metrics |</span> svc<span class="token punctuation">;</span>
  pr <span class="token arrow operator">--></span> pros<span class="token punctuation">;</span>
  pros <span class="token arrow operator">--></span> prw<span class="token punctuation">;</span>
  prw <span class="token arrow operator">--></span> <span class="token label property">|push |</span>prom<span class="token punctuation">;</span>
</code></pre></div>
<p>otelcol配置</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>collector
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> statefulset
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      prometheus:
        config:
          scrape_configs:
          - job_name: 'otel-collector'
            scrape_interval: 10s
            static_configs:
            - targets: [ '0.0.0.0:8888' ]
            metric_relabel_configs:
            - action: labeldrop
              regex: (id|name)
            - action: labelmap
              regex: label_(.+)
              replacement: $$1
      exporters:
        logging:
          loglevel: debug
        prometheus:
          endpoint: 0.0.0.0:8989
          metric_expiration: 10m
        prometheusremotewrite:
          endpoint: http://prometheus.observability-backend.svc.cluster.local:80/api/v1/write
    service:
      pipelines:
        metrics:
          exporters:
          - prometheusremotewrite
          - logging
          processors: []
          receivers:
          - prometheus</span></code></pre></div>
<h3 id="2-scaling-metrics-pipeline-with-the-target-allocator" style="position:relative;"><a href="#2-scaling-metrics-pipeline-with-the-target-allocator" aria-label="2 scaling metrics pipeline with the target allocator permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>2. Scaling metrics pipeline with the target allocator</strong></h3>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
  <span class="token keyword">participant</span> Target Allocator
  <span class="token keyword">participant</span> Metrics Targets
  <span class="token keyword">participant</span> OTel Collectors
  Target Allocator <span class="token arrow operator">->></span>Metrics Targets<span class="token operator">:</span> 1. Discover Metrics targets
  Target Allocator <span class="token arrow operator">->></span>OTel Collectors<span class="token operator">:</span> 2. Discover available Collectors
  Target Allocator <span class="token arrow operator">->></span>Target Allocator<span class="token operator">:</span> 3. Assign Metrics targets
  OTel Collectors <span class="token arrow operator">->></span>Target Allocator<span class="token operator">:</span> 4. Query TA for Metrics targets to scrape
  OTel Collectors <span class="token arrow operator">->></span>Metrics Targets<span class="token operator">:</span> 5. Scrape Metrics target
</code></pre></div>
<p>target allocator需要搭配service monitor/pod monitor使用</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">flowchart</span> RL
  pm<span class="token text string">(PodMonitor)</span>
  sm<span class="token text string">(ServiceMonitor)</span>
  ta<span class="token text string">(Target Allocator)</span>
  oc1<span class="token text string">(OTel Collector)</span>
  oc2<span class="token text string">(OTel Collector)</span>
  oc3<span class="token text string">(OTel Collector)</span>
  ta <span class="token arrow operator">--></span> pm
  ta <span class="token arrow operator">--></span> sm
  oc1 <span class="token arrow operator">--></span> ta
  oc2 <span class="token arrow operator">--></span> ta
  oc3 <span class="token arrow operator">--></span> ta
  sm ~~~<span class="token label property">|"1. Discover Prometheus Operator CRs"|</span> sm
  ta ~~~<span class="token label property">|"2. Add job to TA scrape configuration"|</span> ta
  oc3 ~~~<span class="token label property">|"3. Add job to OTel Collector scrape configuration"|</span> oc3
</code></pre></div>
<p>部署有target allocator的otelcol</p>
<ul>
<li>
<p>otelcol yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.88.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> statefulset
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">targetAllocator</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">allocationStrategy</span><span class="token punctuation">:</span> <span class="token string">"consistent-hashing"</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>operator/target<span class="token punctuation">-</span>allocator<span class="token punctuation">:</span>0.88.0
    <span class="token key atrule">prometheusCR</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      prometheus:
        config:
          scrape_configs:
          - job_name: 'otel-collector'
            scrape_interval: 20s
            static_configs:
            - targets: [ '0.0.0.0:8888' ]
        target_allocator:
          endpoint: http://otel-prom-app-metrics-targetallocator:80
          interval: 30s
          collector_id: ${POD_NAME}
          http_sd_config:
            refresh_interval: 60s</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory_limiter</span><span class="token punctuation">:</span>
        <span class="token key atrule">check_interval</span><span class="token punctuation">:</span> 1s
        <span class="token key atrule">limit_percentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">spike_limit_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">logging</span><span class="token punctuation">:</span>
        <span class="token key atrule">loglevel</span><span class="token punctuation">:</span> debug
      <span class="token key atrule">prometheusremotewrite</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">"http://prometheus.observability-backend.svc.cluster.local:80/api/v1/write"</span>
        <span class="token key atrule">resource_to_telemetry_conversion</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">telemetry</span><span class="token punctuation">:</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">level</span><span class="token punctuation">:</span> debug
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>prometheus<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>memory_limiter<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>logging<span class="token punctuation">,</span> prometheusremotewrite<span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> nodes/proxy
      <span class="token punctuation">-</span> nodes/metrics
      <span class="token punctuation">-</span> services
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> pods
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"monitoring.coreos.com"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> servicemonitors
      <span class="token punctuation">-</span> podmonitors
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> extensions
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingresses
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> networking.k8s.io
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingresses
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"discovery.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> endpointslices
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span> <span class="token string">"/metrics/cadvisor"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token comment"># quirk of the Operator</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>targetallocator
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> backend1
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application</code></pre></div>
</li>
</ul>
<p>部署service monitor</p>
<ul>
<li>
<p>service_monitor.yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> backend1<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> backend1
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> tutorial<span class="token punctuation">-</span>application
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics/
      <span class="token key atrule">port</span><span class="token punctuation">:</span> http
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 20s
      <span class="token key atrule">scrapeTimeout</span><span class="token punctuation">:</span> 10s
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>cr<span class="token punctuation">-</span>targetallocator
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics
      <span class="token key atrule">port</span><span class="token punctuation">:</span> targetallocation
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 20s
      <span class="token key atrule">scrapeTimeout</span><span class="token punctuation">:</span> 10s
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> observability<span class="token punctuation">-</span>backend
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>prom<span class="token punctuation">-</span>app<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>targetallocator</code></pre></div>
</li>
</ul>
<p>部署完成可以看到，如下pod</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cbe8d4bbe2a722525fe067c01d37dc67/c6162/otlp_image_10.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.12883435582822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABOklEQVR42oVR2W6EMBDj/79vFyGWK5whQAhnYYF1Z6JSqU+NZCmZOB574qQygekNtNZQtYJIU+z7juu8cB4njvcb53liHEd8Ph/8txw/9hCIF8LshXZoEDyfiMMILxEjlylqbjRNyJXCfBxYrwsLNeA9Y6Hz+oMvgqM3hbqTVqw1DXpVQ3cajemghw5vIm3U2cwz1QwUoR0GbFwnx7yXHXEpwbAscIq8hEgEiqKAlNLGuojM4HXH5MgLiVZliSLPfyPOVLvIsel7e+fEcYwbQggEQYCqqrBt2x/BgZws5KCkR8w7KC7Plmu8ehLsyKnjeR5c14Xv+wjDEE+aYUofM9Hc+KMYvG+axrrJyd3j8bBvmM+1W5BTWId8EUURkiRBlmVo29Z2U/QRLMRkFl7X1brnN8y5a/dI2OE3+sgToI23mCwAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/cbe8d4bbe2a722525fe067c01d37dc67/a6d36/otlp_image_10.png"
        srcset="/static/cbe8d4bbe2a722525fe067c01d37dc67/222b7/otlp_image_10.png 163w,
/static/cbe8d4bbe2a722525fe067c01d37dc67/ff46a/otlp_image_10.png 325w,
/static/cbe8d4bbe2a722525fe067c01d37dc67/a6d36/otlp_image_10.png 650w,
/static/cbe8d4bbe2a722525fe067c01d37dc67/e548f/otlp_image_10.png 975w,
/static/cbe8d4bbe2a722525fe067c01d37dc67/3c492/otlp_image_10.png 1300w,
/static/cbe8d4bbe2a722525fe067c01d37dc67/c6162/otlp_image_10.png 2166w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>可以在granafa里看到</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ca23d202d5783014c8d90e87f227c7d1/8750a/otlp_image_11.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 37.423312883435585%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABFklEQVR42m1RW07EMAzs/Q/EF4dgCwUtX7ACUXZLH0vjxEmawba2qDwsTZ06djIzqYgI3nsDkUfOGSknBA6IMSIvC5xzBt0b3ya4YUL6aMGnFueXZ3jJ2hvJoQrM+B0xM1xw1mRRCsplr7m+wvFxj9Q08LsbhHpnmU8d8jTJgSH8OVDHs7CMctkiDBXKjiji0O0xvT/B39Xwza2ghrt/ALdHxL5DxTKkzSuUldZSTLa2wwQpJfTDCDczPmlAf34FiQ1EM5xI5cjwLAxZhopI0kHN6qP6qmuNtCTxNHz/l7KYgvWiYjX7Wq3y/0jehovyIGE0H7exWvGzVlAZXXnREBjKdpWeNMsABQ/nZ5SLghVr37amDL8Af4UiNW4knEYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/ca23d202d5783014c8d90e87f227c7d1/a6d36/otlp_image_11.png"
        srcset="/static/ca23d202d5783014c8d90e87f227c7d1/222b7/otlp_image_11.png 163w,
/static/ca23d202d5783014c8d90e87f227c7d1/ff46a/otlp_image_11.png 325w,
/static/ca23d202d5783014c8d90e87f227c7d1/a6d36/otlp_image_11.png 650w,
/static/ca23d202d5783014c8d90e87f227c7d1/e548f/otlp_image_11.png 975w,
/static/ca23d202d5783014c8d90e87f227c7d1/3c492/otlp_image_11.png 1300w,
/static/ca23d202d5783014c8d90e87f227c7d1/8750a/otlp_image_11.png 3690w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="collecting-kubernetes-infrastracture-metrics" style="position:relative;"><a href="#collecting-kubernetes-infrastracture-metrics" aria-label="collecting kubernetes infrastracture metrics permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Collecting Kubernetes infrastracture metrics</strong></h2>
<p>使用了kubeletstats和hostmetrics的receivers，收集k8s的指标。</p>
<ul>
<li>
<p>otle yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>agent
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.88.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> daemonset
  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> K8S_NODE_NAME
    <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
      <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_RESOURCE_ATTRIBUTES
    <span class="token key atrule">value</span><span class="token punctuation">:</span> k8s.node.name=$(K8S_NODE_NAME)
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hostfs
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /hostfs
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">mountPropagation</span><span class="token punctuation">:</span> HostToContainer
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hostfs
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      kubeletstats:
        collection_interval: 20s
        auth_type: "serviceAccount"
        endpoint: "${env:K8S_NODE_NAME}:10250"
        extra_metadata_labels:
        - k8s.volume.type
        insecure_skip_verify: true
        metric_groups:
        - container
        - pod
        - volume
        - node
      hostmetrics:
        collection_interval: 10s
        root_path: /hostfs
        scrapers:
          cpu:
            metrics:
              system.cpu.utilization:
                enabled: true
          disk: null
          filesystem:
            exclude_fs_types:
              fs_types:
              - autofs
              - binfmt_misc
              - bpf
              - cgroup2
              - configfs
              - debugfs
              - devpts
              - devtmpfs
              - fusectl
              - hugetlbfs
              - iso9660
              - mqueue
              - nsfs
              - overlay
              - proc
              - procfs
              - pstore
              - rpc_pipefs
              - securityfs
              - selinuxfs
              - squashfs
              - sysfs
              - tracefs
              match_type: strict
            exclude_mount_points:
              match_type: regexp
              mount_points:
              - /dev/*
              - /proc/*
              - /sys/*
              - /run/k3s/containerd/*
              - /run/containerd/runc/*
              - /var/lib/docker/*
              - /var/lib/kubelet/*
              - /snap/*
          load: null
          memory:
            metrics:
              system.memory.utilization:
                enabled: true
          network: null</span>
    
    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory_limiter</span><span class="token punctuation">:</span>
        <span class="token key atrule">check_interval</span><span class="token punctuation">:</span> 1s
        <span class="token key atrule">limit_percentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">spike_limit_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">k8sattributes</span><span class="token punctuation">:</span>
        <span class="token key atrule">auth_type</span><span class="token punctuation">:</span> <span class="token string">'serviceAccount'</span>
        <span class="token key atrule">extract</span><span class="token punctuation">:</span>
          <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> k8s.namespace.name
            <span class="token punctuation">-</span> k8s.pod.name
            <span class="token punctuation">-</span> k8s.pod.start_time
            <span class="token punctuation">-</span> k8s.pod.uid
            <span class="token punctuation">-</span> k8s.deployment.name
            <span class="token punctuation">-</span> k8s.node.name
      <span class="token key atrule">resourcedetection/env</span><span class="token punctuation">:</span>
        <span class="token key atrule">detectors</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> env

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">logging</span><span class="token punctuation">:</span>
        <span class="token key atrule">loglevel</span><span class="token punctuation">:</span> debug
      <span class="token key atrule">prometheusremotewrite</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">"http://prometheus.observability-backend.svc.cluster.local:80/api/v1/write"</span>
        <span class="token key atrule">resource_to_telemetry_conversion</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>kubeletstats<span class="token punctuation">,</span> hostmetrics<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>k8sattributes<span class="token punctuation">,</span> resourcedetection/env<span class="token punctuation">,</span> memory_limiter<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>logging<span class="token punctuation">,</span> prometheusremotewrite<span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.88.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> statefulset
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
  <span class="token key atrule">targetAllocator</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>targetallocator
    <span class="token key atrule">allocationStrategy</span><span class="token punctuation">:</span> <span class="token string">"consistent-hashing"</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>operator/target<span class="token punctuation">-</span>allocator<span class="token punctuation">:</span>0.88.0
    <span class="token key atrule">prometheusCR</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> K8S_NODE_NAME
    <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
      <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_RESOURCE_ATTRIBUTES
    <span class="token key atrule">value</span><span class="token punctuation">:</span> k8s.node.name=$(K8S_NODE_NAME)
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hostfs
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /hostfs
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">mountPropagation</span><span class="token punctuation">:</span> HostToContainer
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hostfs
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      k8s_cluster:
        auth_type: serviceAccount
        node_conditions_to_report:
          - Ready
          - MemoryPressure
        allocatable_types_to_report:
          - cpu
          - memory
      prometheus:
        config:
          scrape_configs:
          - job_name: apiserver
            authorization:
              credentials_file: "/var/run/secrets/kubernetes.io/serviceaccount/token"
              type: Bearer
            honor_labels: true
            honor_timestamps: true
            kubernetes_sd_configs:
            - follow_redirects: true
              kubeconfig_file: ''
              role: endpoints
            metrics_path: "/metrics"
            follow_redirects: true
            relabel_configs:
            - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
              separator: ;
              regex: default;kubernetes;https
              replacement: $$1
              action: keep
            scheme: https
            scrape_interval: 20s
            scrape_timeout: 10s
            tls_config:
              ca_file: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
              insecure_skip_verify: true
          - job_name: kubernetes-nodes
            honor_timestamps: true
            scrape_interval: 20s
            scrape_timeout: 10s
            metrics_path: /metrics
            scheme: https
            authorization:
              type: Bearer
              credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            follow_redirects: true
            relabel_configs:
            - separator: ;
              regex: __meta_kubernetes_node_label_(.+)
              replacement: $$1
              action: labelmap
            - separator: ;
              regex: (.*)
              target_label: __address__
              replacement: kubernetes.default.svc:443
              action: replace
            kubernetes_sd_configs:
            - role: node
              kubeconfig_file: ""
              follow_redirects: true
          - job_name: kubernetes-nodes-cadvisor
            honor_timestamps: true
            scrape_interval: 20s
            scrape_timeout: 10s
            metrics_path: /metrics
            scheme: https
            authorization:
              type: Bearer
              credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            follow_redirects: true
            relabel_configs:
            - separator: ;
              regex: __meta_kubernetes_node_label_(.+)
              replacement: $$1
              action: labelmap
            - separator: ;
              regex: (.*)
              target_label: __address__
              replacement: kubernetes.default.svc:443
              action: replace
            kubernetes_sd_configs:
            - role: node
              kubeconfig_file: ""
              follow_redirects: true
          - job_name: kubernetes-service-endpoints
            honor_labels: true
            honor_timestamps: true
            scrape_interval: 20s
            scrape_timeout: 10s
            metrics_path: /metrics
            scheme: http
            follow_redirects: true
            relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_service_label_(.+)
                - source_labels: [__meta_kubernetes_namespace]
                  action: replace
                  target_label: namespace
                - source_labels: [__meta_kubernetes_service_name]
                  action: replace
                  target_label: service
            kubernetes_sd_configs:
            - role: pod
              kubeconfig_file: ""
              follow_redirects: true
          - job_name: kubernetes-pods
            honor_labels: true
            honor_timestamps: true
            scrape_interval: 1m
            scrape_timeout: 20s
            metrics_path: /metrics
            scheme: http
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            follow_redirects: true
            relabel_configs:
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: pod
            kubernetes_sd_configs:
            - role: pod
              kubeconfig_file: ""
              follow_redirects: true
        target_allocator:
          endpoint: http://otel-k8s-cluster-metrics-targetallocator:80
          interval: 30s
          collector_id: ${POD_NAME}
          http_sd_config:
            refresh_interval: 60s</span>
    
    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory_limiter</span><span class="token punctuation">:</span>
        <span class="token key atrule">check_interval</span><span class="token punctuation">:</span> 1s
        <span class="token key atrule">limit_percentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">spike_limit_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">resourcedetection/env</span><span class="token punctuation">:</span>
        <span class="token key atrule">detectors</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> env

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">logging</span><span class="token punctuation">:</span>
        <span class="token key atrule">loglevel</span><span class="token punctuation">:</span> debug
      <span class="token key atrule">prometheusremotewrite</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">"http://prometheus.observability-backend.svc.cluster.local:80/api/v1/write"</span>
        <span class="token key atrule">resource_to_telemetry_conversion</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>prometheus<span class="token punctuation">,</span> k8s_cluster<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>resourcedetection/env<span class="token punctuation">,</span> memory_limiter<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>logging<span class="token punctuation">,</span> prometheusremotewrite<span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">''</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> events
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> namespaces/status
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> nodes/proxy
      <span class="token punctuation">-</span> nodes/spec
      <span class="token punctuation">-</span> nodes/stats
      <span class="token punctuation">-</span> nodes/metrics
      <span class="token punctuation">-</span> services
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> replicationcontrollers
      <span class="token punctuation">-</span> replicationcontrollers/status
      <span class="token punctuation">-</span> resourcequotas
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> pods/status
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> apps
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> daemonsets
      <span class="token punctuation">-</span> deployments
      <span class="token punctuation">-</span> replicasets
      <span class="token punctuation">-</span> statefulsets
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token string">"monitoring.coreos.com"</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> servicemonitors
      <span class="token punctuation">-</span> podmonitors
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> extensions
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingresses
      <span class="token punctuation">-</span> daemonsets
      <span class="token punctuation">-</span> deployments
      <span class="token punctuation">-</span> replicasets
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> networking.k8s.io
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingresses
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token string">"discovery.k8s.io"</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> endpointslices
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> batch
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> jobs
      <span class="token punctuation">-</span> cronjobs
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> autoscaling
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> horizontalpodautoscalers
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span> <span class="token string">"/metrics/cadvisor"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token comment"># quirk of the Operator</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>targetallocator
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>collector
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>targetallocator
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
</code></pre></div>
</li>
</ul>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/78d51a3c9581a86d3f159f25c24295c1/2cb21/otlp_image_12.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 39.263803680981596%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcUlEQVR42nVS147DMAzL///e4dqMZjSruaZp9mgWjzRwj2eAkCzLEinbyssE67ZiXhYsxHEc+G+N44i+79G2rfHbrkM/DDjPEx19Wevy9Q3XtuFcr8bGUYS2rg1WNjj33UCrrioT9xwHoe9jYJFj3bCvK26MyVqx6+LueUhuNwP5oc0LTIi5j3h+TDPwWdG/XhhZMAtD5Gy8dD2w7dh5rthG9lYUBIjud0RMCIkkTRHwUHacJiNRUrTkD5QYJwmKx8PsO0J5aZZh4xgsT1LJwnUEMmOD6+UCj7G2aVCR1SPP8aZcYWCBgHLvbD6xwMFxrJ8PQjFkMytjgYQJMaVmfoAsCI3MikXG9xvNzw8qsulYuHk+jeSclwuqWvg44NwkWSPYxVCdPBaz+SDqErCBQ6Y1L06UIomStpOJrKC8hLLneTajODgSw3DbYMnxyVCyZTXLjPN4kVFZlniSVVEU5pv8IY5jpJyxvpkpyK+mmJr+ApWZWWsjLh99AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/78d51a3c9581a86d3f159f25c24295c1/a6d36/otlp_image_12.png"
        srcset="/static/78d51a3c9581a86d3f159f25c24295c1/222b7/otlp_image_12.png 163w,
/static/78d51a3c9581a86d3f159f25c24295c1/ff46a/otlp_image_12.png 325w,
/static/78d51a3c9581a86d3f159f25c24295c1/a6d36/otlp_image_12.png 650w,
/static/78d51a3c9581a86d3f159f25c24295c1/e548f/otlp_image_12.png 975w,
/static/78d51a3c9581a86d3f159f25c24295c1/3c492/otlp_image_12.png 1300w,
/static/78d51a3c9581a86d3f159f25c24295c1/2cb21/otlp_image_12.png 2174w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="kubelet-stats-receiver" style="position:relative;"><a href="#kubelet-stats-receiver" aria-label="kubelet stats receiver permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Kubelet Stats Receiver</strong></h3>
<p>see <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/kubeletstatsreceiver">Kubeletstats Receiver</a>.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7844845bbc6278fae9240084281c2a1d/ec09f/otlp_image_13.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.079754601226995%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeUlEQVR42l1RS3LbMAzVzXKGXqFHyK4n6A2672W66jJN0unUqaQ4tiXXlkgQBAmSyqPsZKbFYCAQH+Hhodlsnu7uH+8fHn5vnvrn567vu67rX7ZX/3/t2q5r2xZZaEPkJITJTNacU04xxpQzOfYimupT38R7cY6rlxIMUo2ITH4621NwJ53OZVnSad5/+vz3y9dlWXJB4CoxRSv2/VlKaUjoaI8c2UTrh7EsJfz609582H28zSzlUrXUr4+8M9t/m9mN53Gch4PZO2PcPAdV8+07/fgZSw4hxDcBRvHyHoHTYBP2nHMuuSCOrZAoK+CUEuqjxnXNxMxEVElZBcG6c9CA1tq9lIsDpsAIgHn2yF6xw64FZRXMa1YsXqKwcIhBk1bOQTP6kzpMYyvBa52PdEAlsEQNsI0lOgzDNM1kyRhjLTGmhQBA+C97T84RdlN14i1yqrKqx6lwZ6C/EAindmJI1gr+cvZpTseTjkf/sqeuj9td3O2rPQyvLS078fXjJAEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/7844845bbc6278fae9240084281c2a1d/a6d36/otlp_image_13.png"
        srcset="/static/7844845bbc6278fae9240084281c2a1d/222b7/otlp_image_13.png 163w,
/static/7844845bbc6278fae9240084281c2a1d/ff46a/otlp_image_13.png 325w,
/static/7844845bbc6278fae9240084281c2a1d/a6d36/otlp_image_13.png 650w,
/static/7844845bbc6278fae9240084281c2a1d/e548f/otlp_image_13.png 975w,
/static/7844845bbc6278fae9240084281c2a1d/3c492/otlp_image_13.png 1300w,
/static/7844845bbc6278fae9240084281c2a1d/ec09f/otlp_image_13.png 1916w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="kubernetes-cluster-receiver" style="position:relative;"><a href="#kubernetes-cluster-receiver" aria-label="kubernetes cluster receiver permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Kubernetes Cluster Receiver</strong></h3>
<p>see <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sclusterreceiver">Kubernetes Cluster Receiver</a>.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">   <span class="token key atrule">k8s_cluster</span><span class="token punctuation">:</span> 
     <span class="token key atrule">auth_type</span><span class="token punctuation">:</span> serviceAccount 
     <span class="token key atrule">node_conditions_to_report</span><span class="token punctuation">:</span> 
       <span class="token punctuation">-</span> Ready 
       <span class="token punctuation">-</span> MemoryPressure 
     <span class="token key atrule">allocatable_types_to_report</span><span class="token punctuation">:</span> 
       <span class="token punctuation">-</span> cpu 
       <span class="token punctuation">-</span> memory </code></pre></div>
<h3 id="host-metrics-receiver" style="position:relative;"><a href="#host-metrics-receiver" aria-label="host metrics receiver permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Host Metrics Receiver</strong></h3>
<table>
<thead>
<tr>
<th>Scraper</th>
<th>Supported OSs</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>All except Mac</td>
<td>CPU utilization metrics</td>
</tr>
<tr>
<td>disk</td>
<td>All except Mac</td>
<td>Disk I/O metrics</td>
</tr>
<tr>
<td>load</td>
<td>All</td>
<td>CPU load metrics</td>
</tr>
<tr>
<td>filesystem</td>
<td>All</td>
<td>File System utilization metrics</td>
</tr>
<tr>
<td>memory</td>
<td>All</td>
<td>Memory utilization metrics</td>
</tr>
<tr>
<td>network</td>
<td>All</td>
<td>Network interface I/O metrics &#x26; TCP connection metrics</td>
</tr>
<tr>
<td>paging</td>
<td>All</td>
<td>Paging/Swap space utilization and I/O metrics</td>
</tr>
<tr>
<td>processes</td>
<td>Linux, Mac</td>
<td>Process count metrics</td>
</tr>
<tr>
<td>process</td>
<td>Linux, Windows, Mac</td>
<td>Per process CPU, Memory, and Disk I/O metrics</td>
</tr>
</tbody>
</table>
<p>There is some overlap with the <a href="https://github.com/pavolloffay/kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial/blob/main/06-collecting-k8s-infra-metrics.md#kubeletstats-receiver">Kubeletstats Receiver</a> so if you decide to use both, it may be worth it to disable these duplicate metrics.</p>
<p>In order to correctly scrape node metrics, make sure to mount the <code class="language-text">hostfs</code> volume if you want to collect the actual node’s metrics. You can inspect the <a href="https://github.com/pavolloffay/kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial/blob/main/(backend/06-collector-k8s-cluster-metrics.yaml)">configuration</a> to see how the <code class="language-text">hostfs</code> volume is mounted. Configuration for <code class="language-text">hostmetrics</code>, in simplest form, looks as follows:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">receivers</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostmetrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">root_path</span><span class="token punctuation">:</span> /hostfs
    <span class="token key atrule">collection_interval</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">scrapers</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span>
      <span class="token key atrule">load</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span>
      <span class="token key atrule">disk</span><span class="token punctuation">:</span>
      <span class="token key atrule">filesystem</span><span class="token punctuation">:</span>
      network<span class="token punctuation">:</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e64e0f003c55317623405db056a9f50f/ec09f/otlp_image_14.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.46625766871166%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXUlEQVR42nVRWU7DMBD1/c+CxDHgAkjwAWob0ibxvu82Y6Uti4T1Ys2byWzPCBPChbDW+RD+wDmntL5DKiWVlPAppY0BD4ox9n9Ozvln8h175kgOIbTWSi211lJKq22cPq4Ywq2h+t3/ShHGmDEWxpDeWGu9z3kUSjmD04LXwwYR1gJ70LFRhN9gAgRV5vV8WiaIwpwlZyrYtE7GasiHWbji8zbH6FMuKSUi6BkDHSWQT45b7oLzems52uSopj5A5bWXJLwgikA06K2X7KLnRkCbaLYUA5roSXpJPdVGREIvahGWYYeVIF3ax5eHiR9NsYbTKMTz8YkazAJ3WnhC0CIv1FBisHHaMDmzC7Ns1au1uvj0Qd8hyh33zhqh3pZXoJveAoipDYI9W+87Su/1Zg8Kwg3l+1AfaN2f4UpTyshJ2vChkROgw03BODZy6PSzpggStZJ39Fq+7ZJTCF8fnj3zWzJpoQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/e64e0f003c55317623405db056a9f50f/a6d36/otlp_image_14.png"
        srcset="/static/e64e0f003c55317623405db056a9f50f/222b7/otlp_image_14.png 163w,
/static/e64e0f003c55317623405db056a9f50f/ff46a/otlp_image_14.png 325w,
/static/e64e0f003c55317623405db056a9f50f/a6d36/otlp_image_14.png 650w,
/static/e64e0f003c55317623405db056a9f50f/e548f/otlp_image_14.png 975w,
/static/e64e0f003c55317623405db056a9f50f/3c492/otlp_image_14.png 1300w,
/static/e64e0f003c55317623405db056a9f50f/ec09f/otlp_image_14.png 1916w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="prometheus-receiver" style="position:relative;"><a href="#prometheus-receiver" aria-label="prometheus receiver permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Prometheus Receiver</strong></h3>
<p>Kubernetes components emit metrics in Prometheus format and it has built-in support for hundreds of useful metrics that help understand the health of containers, pods, nodes, services, and internal system components, such as <code class="language-text">kube-controller-manager</code>, <code class="language-text">kube-proxy</code>, <code class="language-text">kube-apiserver</code>, <code class="language-text">kube-scheduler</code>, and <code class="language-text">kubelet</code>. Most of the metrics for the key components come embedded with the Kubelet. For specific metrics related to these components, deployments of exporters like <code class="language-text">kube-state-metrics</code>, <code class="language-text">node-exporter</code>, and <code class="language-text">Blackbox Exporter</code> are required.</p>
<p>set up the OpenTelemetry collector to scrape these embedded metrics. The Prometheus upstream repository provides a helpful reference for configuring scraping, which you can find <a href="https://raw.githubusercontent.com/prometheus/prometheus/main/documentation/examples/prometheus-kubernetes.yml">here</a>. It contains the necessary configurations for discovering pods and services in your Kubernetes cluster. Our Prometheus receiver scrape configuration includes the following defined scrape jobs:</p>
<ol>
<li><strong>kubernetes-apiservers:</strong> This job pulls in metrics from the API servers.</li>
<li><strong>kubernetes-nodes:</strong> It collects metrics specific to Kubernetes nodes.</li>
<li><strong>kubernetes-pods:</strong> All pods with annotations for scraping and port specifications are scraped.</li>
<li><strong>kubernetes-service-endpoints:</strong> All service endpoints with annotations for scraping and port specifications are scraped.</li>
<li><strong>kubernetes-cadvisor:</strong> This job captures metrics from cAdvisor, providing container metrics.</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/4b1903cbcd62a40b6849979099973b6a/bb052/otlp_image_15.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 51.533742331288344%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB60lEQVR42m1STWtUMRR9P1JduBuFQunCRZlSW6m0foygddPNbHTp3o9FFYpDC5VZCMWFGxWVKnVe530kL9/Je8ebzKBtNXC4Iffm5N5zkk2KEpNpjrwskRdTFFWBkpXgkqMWNSpRpSikglIzNFKiZjUYY+CNgJznJJ1nw6Mh7h5uYvDuDmELm6M1bOyt4P7BLWwfbmFnPMDT9zv0SA3vPdo2oBFEKgSU1gRLpDLlIrLbBxtY2L2OpdcL6L26it7LK+i9uIxrzy9hsL+OZ0dPMBw/hPEa/18duq5Lu7ZtkT0eP8LK22Wsj/pY3buB/psl9HcXKS7iwf4a4SbujZb/EMbL8WLsxvmAOddfQmUUXHAJxhnSpwEXHNo0MMFCE1HMxeJIFhFCgNYGWjQIgqFVDVrSPFiNzFr37xStRWdzIEhCgy5oImnPTDlrS/w6xsmHMfi3T6g+f4QiQzNjbXo9iu2SsBSNhOIVnGRwisFblUYMVJPGdQ6euqynBU6+H6Omn1Lmp8npzBgaybtUJKUG5xyMsxRnrs40s/Swi0RUGy9y3qQvI5RODVMJAjWTxeTFFVqPQk3Pie2cP+dsXA3p/PX0C3I+wc/qBxhNk2ljzkjTzQkDJBUno7xJZsXuLtbFc9bQBycTmYxGavwGWLHooIt0O6gAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/4b1903cbcd62a40b6849979099973b6a/a6d36/otlp_image_15.png"
        srcset="/static/4b1903cbcd62a40b6849979099973b6a/222b7/otlp_image_15.png 163w,
/static/4b1903cbcd62a40b6849979099973b6a/ff46a/otlp_image_15.png 325w,
/static/4b1903cbcd62a40b6849979099973b6a/a6d36/otlp_image_15.png 650w,
/static/4b1903cbcd62a40b6849979099973b6a/e548f/otlp_image_15.png 975w,
/static/4b1903cbcd62a40b6849979099973b6a/3c492/otlp_image_15.png 1300w,
/static/4b1903cbcd62a40b6849979099973b6a/bb052/otlp_image_15.png 3722w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="correlation" style="position:relative;"><a href="#correlation" aria-label="correlation permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Correlation</strong></h2>
<p>相关信息，比如k8s信息，主机信息。</p>
<h3 id="collecting-kubernetes-resource-attributes" style="position:relative;"><a href="#collecting-kubernetes-resource-attributes" aria-label="collecting kubernetes resource attributes permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Collecting Kubernetes resource attributes</strong></h3>
<p>The Kubernetes resource attributes can be added to metrics in a couple of different ways:</p>
<ol>
<li>in OpenTelemetry SDK / <code class="language-text">OTEL_RESOURCE_ATTRIBUTES</code> environment variable</li>
<li>in collector <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/k8sattributesprocessor">k8sattributesprocessor</a></li>
</ol>
<p>The <a href="https://github.com/open-telemetry/semantic-conventions/blob/main/docs/resource/k8s.md">Kubernetes resource attributes</a> are prefixed with <code class="language-text">k8s</code>: <code class="language-text">k8s.pod.name</code>, <code class="language-text">k8s.pod.uid</code> etc.</p>
<p>The Kubernetes resource attributes can be added to metrics in a couple of different ways:</p>
<ol>
<li>in OpenTelemetry SDK / <code class="language-text">OTEL_RESOURCE_ATTRIBUTES</code> environment variable</li>
<li>in collector <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/k8sattributesprocessor">k8sattributesprocessor</a>(need rbac)</li>
</ol>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token literal-property property">processors</span><span class="token operator">:</span>
    <span class="token literal-property property">k8sattributes</span><span class="token operator">:</span>
      <span class="token literal-property property">passthrough</span><span class="token operator">:</span> <span class="token boolean">false</span> # when <span class="token boolean">true</span> only pod <span class="token constant">IP</span> addresses are added<span class="token punctuation">,</span> that can be used later <span class="token keyword">for</span> attributes association
      <span class="token literal-property property">extract</span><span class="token operator">:</span>
        <span class="token literal-property property">annotations</span><span class="token operator">:</span>
          <span class="token operator">-</span> tag_name<span class="token operator">:</span> tutorial # extracts value <span class="token keyword">of</span> annotation from pods <span class="token keyword">with</span> key <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">annotation-one</span><span class="token template-punctuation string">`</span></span> and inserts it <span class="token keyword">as</span> a tag <span class="token keyword">with</span> key <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a1</span><span class="token template-punctuation string">`</span></span>
            <span class="token literal-property property">key</span><span class="token operator">:</span> kubecon<span class="token operator">-</span>tutorial
            <span class="token literal-property property">from</span><span class="token operator">:</span> namespace</code></pre></div>
<ul>
<li>
<p>yaml详情</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>collector
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"namespaces"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"replicasets"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"replicasets"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>collector
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>collector
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>collector
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.87.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
          http:</span>

    <span class="token key atrule">connectors</span><span class="token punctuation">:</span>
      <span class="token key atrule">spanmetrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">exemplars</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory_limiter</span><span class="token punctuation">:</span>
        <span class="token key atrule">check_interval</span><span class="token punctuation">:</span> 1s
        <span class="token key atrule">limit_percentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">spike_limit_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">k8sattributes</span><span class="token punctuation">:</span>
        <span class="token key atrule">passthrough</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">extract</span><span class="token punctuation">:</span>
          <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">tag_name</span><span class="token punctuation">:</span> tutorial <span class="token comment"># extracts value of annotation from pods with key `annotation-one` and inserts it as a tag with key `a1`</span>
            <span class="token key atrule">key</span><span class="token punctuation">:</span> kubecon<span class="token punctuation">-</span>tutorial
            <span class="token key atrule">from</span><span class="token punctuation">:</span> namespace

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed
      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">,</span> spanmetrics<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>memory_limiter<span class="token punctuation">,</span> k8sattributes<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">,</span> otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>memory_limiter<span class="token punctuation">,</span> k8sattributes<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">,</span> spanmetrics<span class="token punctuation">]</span></code></pre></div>
</li>
</ul>
<p>apply yaml之后可以看到</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1bc8e8ce645884513a0db3fb7f99ec9f/0a17b/otlp_image_16.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 51.533742331288344%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABq0lEQVR42m2SCW+jMBSE+f9/b6WqjZomQABjsDnMfc3OM81udlWkJ/DB55l5DoytUBqD1jn0w4BpmjCMI/q+x8R363pcYoc814gfMbJUIb5nuLzdfF0vIbKHRsrSuUFQNw0ylaNtW4wE7PuObdvw+shcxwPefn0gChOkicLXZ4TbNYY1NcrCIFcFqqoWYAuBjlQmQIH9D9y2nWonXD+oMCnQcH8/08kyY1oXuGnENM/eWWCrCro4N21Usn/XcRx/ats3D/x8jwjU3FujoCPTdeg5Py8LZgI7joOmdT6vvmd+8+IX5bRlWbGsZ40cS7YCTB+Mx7VougE1AbJ3lX+47gSYawPFDG3doCgts3QoLSMYRhz7gXXd0LAxf4EaHRs488CSAEebDZvpWJ1Ylu7dw9Dblm+JwFiLgcCzIYe3Mr5YbiVD/pzUNSquCWj6duaBURSjKErkWrNTFewPwGeGaZKj4rpcsaw+sxR1zxwDgYRhRLsltD5bfyocfgSKwq5z/lYoKs1ZViKQnAWoqPDrdv/Hcmmsb9IT6F6AKi38nZU5RYUJDy85lisjwN8bxvz0HAFEbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/1bc8e8ce645884513a0db3fb7f99ec9f/a6d36/otlp_image_16.png"
        srcset="/static/1bc8e8ce645884513a0db3fb7f99ec9f/222b7/otlp_image_16.png 163w,
/static/1bc8e8ce645884513a0db3fb7f99ec9f/ff46a/otlp_image_16.png 325w,
/static/1bc8e8ce645884513a0db3fb7f99ec9f/a6d36/otlp_image_16.png 650w,
/static/1bc8e8ce645884513a0db3fb7f99ec9f/e548f/otlp_image_16.png 975w,
/static/1bc8e8ce645884513a0db3fb7f99ec9f/3c492/otlp_image_16.png 1300w,
/static/1bc8e8ce645884513a0db3fb7f99ec9f/0a17b/otlp_image_16.png 3720w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d16b8c722541aa6800ee397a681572a7/71d63/otlp_image_17.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.920245398773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJ0lEQVR42n2R23KDMAxE/f9/1+f2qc1wsQEbG3wh4I3kUJpmSJg5Y1srraRBOGswGANnR0zzDDsFhBjf4kMoub/EGPD5PeLjS0NwQBuNXo8wo8PsA9w0FWJKL01ZO3S+R48YZghPhj+XC9pOQ1vqSEajdbDO/ZviFY4pA/DbQyRyb6WEJCytHWgd7z2dEWlZCssD6YRDIy/BY7NBSgvWdcW2bdjydj8ZipWC65V4iO+kvZ4HiLS+uFJizhmvvpzvRWkhwzWf6PmABxLcOW8rKzvbE/lEyyfaoyGLT13Pp81v78WQ9x60pp+i0LYSVVUTFaq6Rt00Jd51fdH4rlT391aq0DRt0TT5iJl+u9EGXd+XRCnlYa667oALSw4xDAPlclzt570Jx281IwjWmLkx8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/d16b8c722541aa6800ee397a681572a7/a6d36/otlp_image_17.png"
        srcset="/static/d16b8c722541aa6800ee397a681572a7/222b7/otlp_image_17.png 163w,
/static/d16b8c722541aa6800ee397a681572a7/ff46a/otlp_image_17.png 325w,
/static/d16b8c722541aa6800ee397a681572a7/a6d36/otlp_image_17.png 650w,
/static/d16b8c722541aa6800ee397a681572a7/e548f/otlp_image_17.png 975w,
/static/d16b8c722541aa6800ee397a681572a7/3c492/otlp_image_17.png 1300w,
/static/d16b8c722541aa6800ee397a681572a7/71d63/otlp_image_17.png 3818w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="resource-detection-processor" style="position:relative;"><a href="#resource-detection-processor" aria-label="resource detection processor permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Resource Detection Processor</strong></h3>
<p>The <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor">resourcedetectionprocessor</a> can be used to detect the resource information from the host. Several detectors are supported:</p>
<ul>
<li><code class="language-text">env</code>: read attributes from <code class="language-text">OTEL_RESOURCE_ATTRIBUTES</code></li>
<li><code class="language-text">system</code>: <code class="language-text">host.name</code>, <code class="language-text">host.arch</code>, <code class="language-text">host.id</code>, <code class="language-text">host.cpu.model.name</code>, <code class="language-text">host.cpu.vendor.id</code></li>
<li><code class="language-text">docker</code>: <code class="language-text">host.name</code>, <code class="language-text">os.type</code></li>
<li><code class="language-text">heroku</code>: <code class="language-text">heroku.app.id</code>, <code class="language-text">heroku.release.commit</code>, <code class="language-text">service.name</code></li>
<li><code class="language-text">gcp</code>: <code class="language-text">cloud.provider</code> (<code class="language-text">gcp</code>), <code class="language-text">cloud.platform</code> (<code class="language-text">gcp_app_engine</code>), <code class="language-text">cloud.region</code> (<code class="language-text">us-central1</code>), <code class="language-text">cloud.availability_zone</code> (<code class="language-text">us-central1-c</code>), <code class="language-text">gcp.gce.instance.hostname</code></li>
<li><code class="language-text">openshift</code>: <code class="language-text">cloud.provider</code>, <code class="language-text">cloud.platform</code>, <code class="language-text">cloud.region</code>, <code class="language-text">k8s.cluster.name</code></li>
</ul>
<h3 id="exemplars" style="position:relative;"><a href="#exemplars" aria-label="exemplars permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Exemplars</strong></h3>
<p><a href="https://opentelemetry.io/docs/specs/otel/metrics/sdk/#exemplar">Exemplars</a> allow correlation between aggregated metric data and the original API calls where measurements are recorded. Exemplars work for trace-metric correlation across any metric, not just those that can also be derived from Spans.</p>
<h3 id="collector-spanmetrics-connector" style="position:relative;"><a href="#collector-spanmetrics-connector" aria-label="collector spanmetrics connector permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Collector: Spanmetrics Connector</strong></h3>
<p>The <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/spanmetricsconnector">spanmetrics</a> connector aggregates Request, Error and Duration (R.E.D) OpenTelemetry metrics from span data. It supports exemplars.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">connectors</span><span class="token punctuation">:</span>
  <span class="token key atrule">spanmetrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">exemplars</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
    <span class="token key atrule">traces</span><span class="token punctuation">:</span>
      <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
      <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>spanmetrics<span class="token punctuation">]</span>
    <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
      <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>spanmetrics<span class="token punctuation">]</span>
      <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a1d07edcd6c1bb71212cb055364cd086/c2d13/otlp_image_18.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 52.14723926380368%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRklEQVR42n1Ri27DIAzk/z9x69SWpAtNAJs3oWm2Syp1qqbtdLIA+czZFjEG532IIaRU55pLLnusc7mMPFnng2fHuZa5zSBySq3zXD8nLyAelLoa0uyhDymmkh8scyHmUesQY2vtvt4fWO7LjpsotUzGsPd+/xzRhZDrQ1+00ddxIDLE1ntkuRS9c7zRO5ELylPKCZZam2Fp9wd7MNnGSfXdSanLufs4yveTPBzlYTuf37rLSbRbW9f1awfy4TDnDDsxxbLXlVKGEJ85T6ALcVsWfOgDEY3MZAxZyxiYMSM7i4n0fW+tdu6FzBMkApNQapDdWXZynPSgRksuxjQASqEx3jpE5e6Vks0gym41wGXaAKU2hCsefQg/w6/1NwU6tLAMx8RYg3POGIuXWiuzwyDj3xTYEVna9ETYHaLZ1HYX8z/iVPI3zEM4WV+NefUAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/a1d07edcd6c1bb71212cb055364cd086/a6d36/otlp_image_18.png"
        srcset="/static/a1d07edcd6c1bb71212cb055364cd086/222b7/otlp_image_18.png 163w,
/static/a1d07edcd6c1bb71212cb055364cd086/ff46a/otlp_image_18.png 325w,
/static/a1d07edcd6c1bb71212cb055364cd086/a6d36/otlp_image_18.png 650w,
/static/a1d07edcd6c1bb71212cb055364cd086/e548f/otlp_image_18.png 975w,
/static/a1d07edcd6c1bb71212cb055364cd086/3c492/otlp_image_18.png 1300w,
/static/a1d07edcd6c1bb71212cb055364cd086/c2d13/otlp_image_18.png 2560w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="baggage" style="position:relative;"><a href="#baggage" aria-label="baggage permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Baggage</strong></h3>
<p><a href="https://opentelemetry.io/docs/concepts/signals/baggage/">Baggage</a> is contextual information that is passed between spans. It is a key-value store that resides alongside span context in a trace, making values available to any span created within that trace.</p>
<p>The baggage is propagated via W3C <code class="language-text">baggage</code> <a href="https://w3c.github.io/baggage/">header</a>.</p>
<p>Example of setting baggage with <code class="language-text">sessionId</code> key.</p>
<p>`const baggage =
otelapi.propagation.getBaggage(otelApi.context.active()) ||
otelapi.propagation.createBaggage()</p>
<p>baggage.setEntry(“sessionId”, { value: “session-id-value” })
otelapi.propagation.setBaggage(otelapi.context.active(), baggage)`</p>
<h1 id="eu-2024" style="position:relative;"><a href="#eu-2024" aria-label="eu 2024 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EU-2024</h1>
<p>还是熟悉的配方，apply cert-manager和opentelemetry-operator</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.yaml

kubectl apply <span class="token parameter variable">-f</span> https://github.com/open-telemetry/opentelemetry-operator/releases/download/v0.94.0/opentelemetry-operator.yaml</code></pre></div>
<p>使用jaeger、prometheus，部署在observability-backend</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">observability-backend           jaeger-cb9c786c6-rl9hz
observability-backend           prometheus-79d4df4bd9-nfgjq</code></pre></div>
<p>使用的测试应用还是之前的frontend、backend1、backend2、loadgen(自动测试的)</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    loadgen<span class="token arrow operator">->></span>frontend<span class="token operator">:</span> /?player1=bob<span class="token operator">&amp;</span>player2=alice
    frontend<span class="token arrow operator">->></span>backend1<span class="token operator">:</span> /rolldice?player=bob
    frontend<span class="token arrow operator">->></span>backend2<span class="token operator">:</span> /rolldice?player=alice
    backend1<span class="token arrow operator">-->></span>frontend<span class="token operator">:</span> 3
    frontend<span class="token arrow operator">-->></span>loadgen<span class="token operator">:</span> bob rolls<span class="token operator">:</span> 3
    backend2<span class="token arrow operator">-->></span>frontend<span class="token operator">:</span> 6
    frontend<span class="token arrow operator">-->></span>loadgen<span class="token operator">:</span> alice rolls<span class="token operator">:</span> 6
    frontend<span class="token arrow operator">-->></span>loadgen<span class="token operator">:</span> alice wins
</code></pre></div>
<h2 id="auto-instrumentation-1" style="position:relative;"><a href="#auto-instrumentation-1" aria-label="auto instrumentation 1 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auto-instrumentation</h2>
<ul>
<li>
<p>部署<code class="language-text">03-collector.yaml</code></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
</li>
<li>
<p>部署<code class="language-text">instrumentation.yaml</code></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Instrumentation
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>instrumentation
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">exporter</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
  <span class="token key atrule">propagators</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> tracecontext
    <span class="token punctuation">-</span> baggage
    <span class="token punctuation">-</span> b3
  <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> parentbased_traceidratio
    <span class="token key atrule">argument</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">resource</span><span class="token punctuation">:</span>
    <span class="token key atrule">addK8sUIDAttributes</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">python</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># Required if endpoint is set to 4317.</span>
      <span class="token comment"># Python autoinstrumentation uses http/proto by default</span>
      <span class="token comment"># so data must be sent to 4318 instead of 4317.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_ENDPOINT
        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4318</span>
  <span class="token key atrule">java</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_LOGS_EXPORTER
        <span class="token key atrule">value</span><span class="token punctuation">:</span> otlp
</code></pre></div>
</li>
</ul>
<p>需要patch annotations</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl patch deployment frontend-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-sdk":"true"}}}} }'</span>
kubectl patch deployment backend1-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-python":"true"}}}} }'</span>
kubectl patch deployment backend2-deployment <span class="token parameter variable">-n</span> tutorial-application <span class="token parameter variable">-p</span> <span class="token string">'{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-java":"true"}}}} }'</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c19d7073ff79d481181177f76c5ce971/ef0e6/otlp_image_19.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.306748466257666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABqUlEQVR42m1SW5KbMBDU/W/gRzlO1f75FHuNVBIqeHkK9AIBBsedHpYk/jBVXSONNN09I9Tp7Q2H93ecTieciS/E8XjEfr/H4XD4h+MGye8Eux2+ns9IkgRpmuJyuay1Kt5uWMYRz9/j8cCr73X2f16iyssSSfYB1/fwkeg69DGiHwaMFLvf71jmGR33wzStuek2Y+RachPP4o35cVprVF6R8JqicRaNd7DBQzctjHUIJHchoNsEnuG6gEATjnc8o/F+vaecc5jYsmCUSOUPrfE9y/Ajy5EUJQpe1n1EzeKaxQLZGxJYohVCIReHnpd7bgSR+M0W6tbgWlZIa43S0DlFK8aqbRkN2tDBkrDv6TZyFKvjbr2nAluKVJk5m5rrqxAQJdtOiUw30NagpEjZNIwcR0c3JLKbSxmBpUhDc2pZFsx09eDwMx/wjYWOB1KYk1hzbSjU8kwcSBQiIYzycBv+zlO9+g0KzvBXXuBnUeHKtitDcrrNdb06bujGkFSIh41QhGoaUM//nKwFoiSQEdR0Zfjy0k5jP+fp2GYYRrb6+ZCCII/jPf4AAKHu5D10fXsAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/c19d7073ff79d481181177f76c5ce971/a6d36/otlp_image_19.png"
        srcset="/static/c19d7073ff79d481181177f76c5ce971/222b7/otlp_image_19.png 163w,
/static/c19d7073ff79d481181177f76c5ce971/ff46a/otlp_image_19.png 325w,
/static/c19d7073ff79d481181177f76c5ce971/a6d36/otlp_image_19.png 650w,
/static/c19d7073ff79d481181177f76c5ce971/e548f/otlp_image_19.png 975w,
/static/c19d7073ff79d481181177f76c5ce971/3c492/otlp_image_19.png 1300w,
/static/c19d7073ff79d481181177f76c5ce971/ef0e6/otlp_image_19.png 3832w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/23a18/otlp_image_20.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 31.901840490797547%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRUlEQVR42k2QjUrDQBCE8/6voiIWRLBNo30AQcSCUiPWpk0a21yS5nL5uXxuDvwZGPZu7nbYHc+fzZhcXXFxfsbk8oKb6wm+P2Uu+lxqMJ85+rNbqT53dwFBEHDr+wT396zXn0RRxGKxYDqd4unqhKk1usioiyNVfqA8bKmymLbK6c3J1VYXDJ3BNjWd0VSid7alqUvM+GYbrNy9MAxZrVYopThVmrwoSLYb9tGa9csj78sHotUT8fuS3dszm9dH9psQtY/4Sndk8t+YmlqGKssSL01TnpdL4jhGay2PhhFdayjSyE09DFaUwXEYBncaoTrLsev5Dy/Zbd2EWZb9Go5N1lqh1L7HnBS6VFSFbOGYOdaiDX375yZ9XpErwvCNJEmcYdM0zvAHraxziD8o1YFW8jN1RSMZjhyz60yONUfhl+Sb8w30SMDyrdqXjgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/a6d36/otlp_image_20.png"
        srcset="/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/222b7/otlp_image_20.png 163w,
/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/ff46a/otlp_image_20.png 325w,
/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/a6d36/otlp_image_20.png 650w,
/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/e548f/otlp_image_20.png 975w,
/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/3c492/otlp_image_20.png 1300w,
/static/22cbf47b5d8ea1b3cbcef368b8a3cfff/23a18/otlp_image_20.png 3826w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>In addition to traces in the Java auto-instrumentation also emits <strong>logs</strong> and <strong>metrics</strong>. The logs in our case are printed into the collector stdout via <code class="language-text">debug</code> exporter and metrics are sent via OTLP HTTP into Prometheus. The OpenTelemetry spec defines that the following metrics should be collected: <a href="https://opentelemetry.io/docs/specs/semconv/http/http-metrics/">HTTP metrics</a>.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7cc84fa01e99fd741f9989886f6772d6/fb51c/otlp_image_21.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 23.926380368098158%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnUlEQVR42q2OSwoCMRBEc3DxP/+MIm49jidxI+ioiHYi00nKnpFBEd2IBY+C6kU/lek5xnGKUawxTEoMohy9SYH+9NFRqpHksyfFB/ISiV4gW66gahfgnIP3Hr8nYHtmrDeAIiLsqyOqwwHWWhhjQFcCGYKRG7XIJntzb56/w8xg6Vpa7S5iFmR0vrVs6Iy7fuVb2AfcWAxPtpP+T+5KYW/LpF0ePQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/7cc84fa01e99fd741f9989886f6772d6/a6d36/otlp_image_21.png"
        srcset="/static/7cc84fa01e99fd741f9989886f6772d6/222b7/otlp_image_21.png 163w,
/static/7cc84fa01e99fd741f9989886f6772d6/ff46a/otlp_image_21.png 325w,
/static/7cc84fa01e99fd741f9989886f6772d6/a6d36/otlp_image_21.png 650w,
/static/7cc84fa01e99fd741f9989886f6772d6/e548f/otlp_image_21.png 975w,
/static/7cc84fa01e99fd741f9989886f6772d6/3c492/otlp_image_21.png 1300w,
/static/7cc84fa01e99fd741f9989886f6772d6/fb51c/otlp_image_21.png 3816w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e1784e62bf5e72b2d870a70f98e071ba/7ed3f/otlp_image_22.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.306748466257666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA00lEQVR42q2Syw6CMBBF+/0aNYKCKImJGz/E/3BLKT76IAVD22uBsHBlQJuctIv2zJ1MSXo8YRvvEYQRFmGCRRBjtvZ7uMM8SLDaJIiS9AsHrOMUy/0ZRNcvWAe4poG1Fv44ag33hba4XA1IRhmEKlHcH9BVBeccrDEwI2i6MMa/tSBCSDDGUBQFyrLsq3rpWNrujPFCzgXynOF2u3eVpsgGYQvhz15Y13WXzv4qFKIXaq0nt/uZkHNQmkNK9T9hRikqP+G/CKWUUEr1f3CibKAd6hvntv1IgCmV+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/e1784e62bf5e72b2d870a70f98e071ba/a6d36/otlp_image_22.png"
        srcset="/static/e1784e62bf5e72b2d870a70f98e071ba/222b7/otlp_image_22.png 163w,
/static/e1784e62bf5e72b2d870a70f98e071ba/ff46a/otlp_image_22.png 325w,
/static/e1784e62bf5e72b2d870a70f98e071ba/a6d36/otlp_image_22.png 650w,
/static/e1784e62bf5e72b2d870a70f98e071ba/e548f/otlp_image_22.png 975w,
/static/e1784e62bf5e72b2d870a70f98e071ba/3c492/otlp_image_22.png 1300w,
/static/e1784e62bf5e72b2d870a70f98e071ba/7ed3f/otlp_image_22.png 3830w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/728d913ca4952c3cb214e7b6ea71c7e1/936ee/otlp_image_23.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.306748466257666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1ElEQVR42q2S3QqCQBCFff+LwEKlMiMIgh6jB+kyc43STdP277Sz5m2FuXA4Azt8zNkdb7PdYR4nCKMFpuEKfrjEJFi+PcYsiu39+osSBIs1/HgPr2mf0MbAKAWtNYytQfrx9J28UTgcFbz0nKHgd5ysP5rGAZWSVsq5tC6l/CghpOs1xgKLosApTcEtlGBDRemE0gQswVgO8j7yUCDJK0uOPM+RMYa2bbt3+QdIkxHsnDFUVfU/sJvw4mLXdT1S5MuIwOvthszGpd8WQrjNGgqlFXoBNTH84wSyILkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/728d913ca4952c3cb214e7b6ea71c7e1/a6d36/otlp_image_23.png"
        srcset="/static/728d913ca4952c3cb214e7b6ea71c7e1/222b7/otlp_image_23.png 163w,
/static/728d913ca4952c3cb214e7b6ea71c7e1/ff46a/otlp_image_23.png 325w,
/static/728d913ca4952c3cb214e7b6ea71c7e1/a6d36/otlp_image_23.png 650w,
/static/728d913ca4952c3cb214e7b6ea71c7e1/e548f/otlp_image_23.png 975w,
/static/728d913ca4952c3cb214e7b6ea71c7e1/3c492/otlp_image_23.png 1300w,
/static/728d913ca4952c3cb214e7b6ea71c7e1/936ee/otlp_image_23.png 3828w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="customize-java-auto-instrumentation-with-config-capture-more-data" style="position:relative;"><a href="#customize-java-auto-instrumentation-with-config-capture-more-data" aria-label="customize java auto instrumentation with config capture more data permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Customize Java auto-instrumentation with config (capture more data)</strong></h3>
<p>configure the Java auto-instrumentation by modifying <code class="language-text">Instrumentation</code> CR to:</p>
<ul>
<li>create custom spans - for the main method of the application</li>
<li>capture server response HTTP headers</li>
</ul>
<p>See the <a href="https://opentelemetry.io/docs/languages/java/automatic/configuration/">Java agent docs</a> with all the configuration options.</p>
<ul>
<li>
<p>部署 <code class="language-text">instrumentation-java-custom-config.yaml</code></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Instrumentation
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>instrumentation
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">exporter</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
  <span class="token key atrule">propagators</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> tracecontext
    <span class="token punctuation">-</span> baggage
    <span class="token punctuation">-</span> b3
  <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> parentbased_traceidratio
    <span class="token key atrule">argument</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">resource</span><span class="token punctuation">:</span>
    <span class="token key atrule">addK8sUIDAttributes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">python</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># Required if endpoint is set to 4317.</span>
      <span class="token comment"># Python autoinstrumentation uses http/proto by default</span>
      <span class="token comment"># so data must be sent to 4318 instead of 4317.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_ENDPOINT
        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4318</span>
  <span class="token key atrule">java</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_INSTRUMENTATION_METHODS_INCLUDE
        <span class="token key atrule">value</span><span class="token punctuation">:</span> io.opentelemetry.dice.DiceApplication<span class="token punctuation">[</span>main<span class="token punctuation">]</span>;
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_INSTRUMENTATION_HTTP_SERVER_CAPTURE_RESPONSE_HEADERS
        <span class="token key atrule">value</span><span class="token punctuation">:</span> Content<span class="token punctuation">-</span>Type<span class="token punctuation">,</span>Date
<span class="token comment">#      - name: OTEL_INSTRUMENTATION_TOMCAT_ENABLED</span>
<span class="token comment">#        value: "false"</span>
<span class="token comment">#      - name: OTEL_INSTRUMENTATION_SERVLET_ENABLED</span>
<span class="token comment">#        value: "false"</span></code></pre></div>
</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> instrumentation-java-custom-config.yaml
kubectl rollout restart deployment.apps/backend2-deployment <span class="token parameter variable">-n</span> tutorial-application
kubectl get pods <span class="token parameter variable">-w</span> <span class="token parameter variable">-n</span> tutorial-application</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/36795ca850b863108f0ae95c85c2ff4d/d3609/otlp_image_24.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 57.668711656441715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9ElEQVR42o2T2W7bMBBF9f9fF6B26zhOGyvWYkmkxE1ctNzOyAvyUAQlcESKIGe7w+z9/YT9foe30wnnPEdRlOj7AcNwQ2u9YYx5rnlfKQUpJbquQ9u2qMoSUghkRvUQxW+IywnXPz9Rvu8hqg/Iptjm/npG316guwJOtRidRowR3vsnif5diKhlj2y32+HzfEZ7rYkKQy+hewGtJNiZbK80S1jG3CIcx3HDWrtFuq2d2yLPjsdXfJxzONpgzzxGLVC/vaDPf8G2BYyoYbsKkaJb5wXruuIxHmv++mVBdjgc8Ho8kvWbp4U2p+ghrxeUpx/EjtKvoLqaDBewxBQMWZg3M8tym+M84UJBZVoWUHTI6RZp7NFcCxTlBTFFSsPAWY0QPNQg0IsS3nRwA5WnzlFXBZVIQHTNVqKB5gxJYiMKQpI4OZr8E44U052AZEjFQBmkNJGjCSFOGH2gjDw5Y4ECQkrUHSTKEgSY9c4oWwxNA0PtYLk9SDlFB0cqPquZ6CIzTcx0J2GmlFmgbP1ijCPk0JU2mKmWhjwrF5DocKSLD2P/gg0rVvmrQcYabmaDiWtIPSaNhSaxfAj/ZxCxu9ePSAJGS0h6KXyAIxysf6aXvmOety7JghGYnMBMLIQZ6Dm1At6N9NwsBoo2cPEZ/z3OWvwFPSiZGmYe6EwAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/36795ca850b863108f0ae95c85c2ff4d/a6d36/otlp_image_24.png"
        srcset="/static/36795ca850b863108f0ae95c85c2ff4d/222b7/otlp_image_24.png 163w,
/static/36795ca850b863108f0ae95c85c2ff4d/ff46a/otlp_image_24.png 325w,
/static/36795ca850b863108f0ae95c85c2ff4d/a6d36/otlp_image_24.png 650w,
/static/36795ca850b863108f0ae95c85c2ff4d/e548f/otlp_image_24.png 975w,
/static/36795ca850b863108f0ae95c85c2ff4d/3c492/otlp_image_24.png 1300w,
/static/36795ca850b863108f0ae95c85c2ff4d/d3609/otlp_image_24.png 3318w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="customize-java-auto-instrumentation-with-code-capture-more-data" style="position:relative;"><a href="#customize-java-auto-instrumentation-with-code-capture-more-data" aria-label="customize java auto instrumentation with code capture more data permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Customize Java auto-instrumentation with code (capture more data)</strong></h3>
<p>提供了一个代码。</p>
<p>Open the <a href="https://github.com/pavolloffay/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial/blob/main/app/backend2/src/main/java/io/opentelemetry/dice/RollController.java">RollController.java</a> and use the annotations:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"># app<span class="token operator">/</span>backend2<span class="token operator">/</span>build<span class="token punctuation">.</span>gradle
#   implementation 'io<span class="token punctuation">.</span>opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token operator">:</span>opentelemetry<span class="token operator">-</span>instrumentation<span class="token operator">-</span>annotations<span class="token operator">:</span><span class="token number">2.1</span><span class="token number">.0</span>'
#   implementation 'io<span class="token punctuation">.</span>opentelemetry<span class="token operator">:</span>opentelemetry<span class="token operator">-</span>api<span class="token operator">:</span><span class="token number">1.35</span><span class="token number">.0</span>'
 
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>opentelemetry<span class="token punctuation">.</span>api<span class="token punctuation">.</span>trace<span class="token punctuation">.</span></span><span class="token class-name">Span</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">WithSpan</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">SpanAttribute</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">AddingSpanAttributes</span></span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@AddingSpanAttributes</span>
	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/rolldice"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SpanAttribute</span><span class="token punctuation">(</span><span class="token string">"player"</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"player"</span><span class="token punctuation">)</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@WithSpan</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRandomNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SpanAttribute</span><span class="token punctuation">(</span><span class="token string">"min"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token annotation punctuation">@SpanAttribute</span><span class="token punctuation">(</span><span class="token string">"max"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Span</span> span <span class="token operator">=</span> <span class="token class-name">Span</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        span<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>Compile it and deploy:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> app/backend2

<span class="token comment"># Use minikube's docker registry</span>
<span class="token comment"># eval $(minikube -p minikube docker-env)</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> ghcr.io/pavolloffay/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial-backend2:withspan <span class="token builtin class-name">.</span> 
<span class="token comment"># docker push ghcr.io/pavolloffay/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial-backend2:withspan</span>

kubectl <span class="token builtin class-name">set</span> image deployment.apps/backend2-deployment <span class="token assign-left variable">backend2</span><span class="token operator">=</span>ghcr.io/pavolloffay/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial-backend2:withspan <span class="token parameter variable">-n</span> tutorial-application
kubectl get pods <span class="token parameter variable">-w</span> <span class="token parameter variable">-n</span> tutorial-application</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1570a6a26d8d09930d12bb90895375a4/109e2/otlp_image_25.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 57.668711656441715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACMUlEQVR42mVTi46bMBDk/7+uqqr2cpdLQsDGPPzANhgSuOkY9aRrizRa28KzO7ProrqXOL38wu16Qc21aiRiDJiIGDyWlDDPM5ZlwbKuSIzznDDxLE4T3DjCh4C+7zFyXTjdQTc3tLdfUFeifIVWNUwnYVoJ2zcYhwZeK4y6ge0q7gXa9n4gDDWClpijgx8tipfTCVVVwVoD5xwCsyVmtqqCyYlEyR/NgcALTveYvMMUHDquz41A5D7NE7z3KE4kPJ/fuQmHnH3/IDa015+Q5++ssoZ3GqMdEEyH2XWIRmFxLbxt0LHCaCSeKSB/RSdLyPrKzIplWxhaoJh16Fv66Jk5Yl0SHuvCCjUsZfeUKssfqM7fYOQrevkCP5S0qUKxLwZb0tjmAR+rRasEyrJEoxqotj3sqKo7hBAQdQ2lWhhjUAsJIUk+aHRdf5w3jUIRRwWj3o4MsxPo2RBZV1CigrjfYIfu8CgQ/g9iGNF3DaS4MyqqUYcqKepcISsL7/iINyBeoKt3dKyk5fg0koYbjWQt1onSHytWSs8jlDhOE89Smo/RejweGNnUYk8Ddn/GHm6MF0z0NDY0PEMb+hjZ0YAnZ/D5fP6FbduOmMnyOk/If4SJHXxMMx5joLcLtn3H9g9RJvjEV/IvhG8kvFD2BY6EPkSYOKFz4/Ei8kvJEj+xstosO8evZ8cc5i4f1cU7CTn5roclkSP6YYDW+kDubI6WfuaLn48g7/Ozy1PQti1+A47Bj1kepLQZAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/1570a6a26d8d09930d12bb90895375a4/a6d36/otlp_image_25.png"
        srcset="/static/1570a6a26d8d09930d12bb90895375a4/222b7/otlp_image_25.png 163w,
/static/1570a6a26d8d09930d12bb90895375a4/ff46a/otlp_image_25.png 325w,
/static/1570a6a26d8d09930d12bb90895375a4/a6d36/otlp_image_25.png 650w,
/static/1570a6a26d8d09930d12bb90895375a4/e548f/otlp_image_25.png 975w,
/static/1570a6a26d8d09930d12bb90895375a4/3c492/otlp_image_25.png 1300w,
/static/1570a6a26d8d09930d12bb90895375a4/109e2/otlp_image_25.png 3352w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="manual-instrumentation-using-the-opentelemetry-sdk" style="position:relative;"><a href="#manual-instrumentation-using-the-opentelemetry-sdk" aria-label="manual instrumentation using the opentelemetry sdk permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Manual instrumentation using the OpenTelemetry SDK</strong></h2>
<ul>
<li>
<p>golang code</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
        <span class="token string">"context"</span>
        <span class="token string">"crypto/sha256"</span>
        <span class="token string">"fmt"</span>
        <span class="token string">"math/rand"</span>
        <span class="token string">"net/http"</span>
        <span class="token string">"os"</span>
        <span class="token string">"strconv"</span>
        <span class="token string">"strings"</span>
        <span class="token string">"time"</span>

        <span class="token string">"github.com/prometheus/client_golang/prometheus"</span>
        <span class="token string">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
        <span class="token string">"go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"</span>
        <span class="token string">"go.opentelemetry.io/otel"</span>
        <span class="token string">"go.opentelemetry.io/otel/attribute"</span>
        <span class="token string">"go.opentelemetry.io/otel/codes"</span>
        <span class="token string">"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"</span>
        sdktrace <span class="token string">"go.opentelemetry.io/otel/sdk/trace"</span>
        <span class="token string">"go.opentelemetry.io/otel/trace"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> tracer <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTracerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span><span class="token string">"github.com/kubecon-eu-2024/backend"</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
        rollCounter <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounter</span><span class="token punctuation">(</span>
                prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span>
                        Name<span class="token punctuation">:</span> <span class="token string">"dice_roll_count"</span><span class="token punctuation">,</span>
                        Help<span class="token punctuation">:</span> <span class="token string">"How often the dice was rolled"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        numbersCounter <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span>
                prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span>
                        Name<span class="token punctuation">:</span> <span class="token string">"dice_numbers_count"</span><span class="token punctuation">,</span>
                        Help<span class="token punctuation">:</span> <span class="token string">"How often each number of the dice was rolled"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"number"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>rollCounter<span class="token punctuation">)</span>
        prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>numbersCounter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        otelExporter<span class="token punctuation">,</span> err <span class="token operator">:=</span> otlptracegrpc<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to create trace exporter: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        tp <span class="token operator">:=</span> sdktrace<span class="token punctuation">.</span><span class="token function">NewTracerProvider</span><span class="token punctuation">(</span>sdktrace<span class="token punctuation">.</span><span class="token function">WithBatcher</span><span class="token punctuation">(</span>otelExporter<span class="token punctuation">)</span><span class="token punctuation">)</span>
        otel<span class="token punctuation">.</span><span class="token function">SetTracerProvider</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>

        v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span><span class="token string">"RATE_ERROR"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                v <span class="token operator">=</span> <span class="token string">"0"</span>
        <span class="token punctuation">}</span>
        rateError<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        v<span class="token punctuation">,</span> ok <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span><span class="token string">"RATE_HIGH_DELAY"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                v <span class="token operator">=</span> <span class="token string">"0"</span>
        <span class="token punctuation">}</span>
        rateDelay<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        registerHandleFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">,</span> h http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                route <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
                mux<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> otelhttp<span class="token punctuation">.</span><span class="token function">NewHandler</span><span class="token punctuation">(</span>otelhttp<span class="token punctuation">.</span><span class="token function">WithRouteTag</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> pattern<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">registerHandleFunc</span><span class="token punctuation">(</span><span class="token string">"GET /rolldice"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                player <span class="token operator">:=</span> <span class="token string">"Anonymous player"</span>
                <span class="token keyword">if</span> p <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"player"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
                        player <span class="token operator">=</span> p
                <span class="token punctuation">}</span>

                trace<span class="token punctuation">.</span><span class="token function">SpanFromContext</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span><span class="token string">"determine player"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span><span class="token function">WithAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"player.name"</span><span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                max <span class="token operator">:=</span> <span class="token number">8</span>
                <span class="token keyword">if</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"f4b7c19317c929d2a34297d6229defe5262fa556ef654b600fc98f02c6d87fdc"</span> <span class="token punctuation">{</span>
                        max <span class="token operator">=</span> <span class="token number">8</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        max <span class="token operator">=</span> <span class="token number">6</span>
                <span class="token punctuation">}</span>
                result <span class="token operator">:=</span> <span class="token function">doRoll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span>
                <span class="token function">causeDelay</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rateDelay<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">causeError</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rateError<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                resStr <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                rollCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                numbersCounter<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>resStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>resStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">registerHandleFunc</span><span class="token punctuation">(</span><span class="token string">"GET /metrics"</span><span class="token punctuation">,</span> promhttp<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServeHTTP<span class="token punctuation">)</span>
        srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
                Addr<span class="token punctuation">:</span>    <span class="token string">"0.0.0.0:5165"</span><span class="token punctuation">,</span>
                Handler<span class="token punctuation">:</span> mux<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">causeError</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> span <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"causeError"</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        randomNumber <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        span<span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span><span class="token string">"roll"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span><span class="token function">WithAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> randomNumber <span class="token operator">&lt;</span> rate <span class="token punctuation">{</span>
                err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"number(%d)) &lt; rate(%d)"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">,</span> rate<span class="token punctuation">)</span>
                span<span class="token punctuation">.</span><span class="token function">RecordError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                span<span class="token punctuation">.</span><span class="token function">SetStatus</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Error<span class="token punctuation">,</span> <span class="token string">"some error occured"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">causeDelay</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> span <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"causeDelay"</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        randomNumber <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        span<span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span><span class="token string">"roll"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span><span class="token function">WithAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> randomNumber <span class="token operator">&lt;</span> rate <span class="token punctuation">{</span>
                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">doRoll</span><span class="token punctuation">(</span><span class="token boolean">_</span> context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> backend2<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tutorial<span class="token punctuation">-</span>application
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> backend2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> backend2
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> backend2
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
        <span class="token key atrule">instrumentation.opentelemetry.io/inject-sdk</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> backend2
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/pavolloffay/kubecon<span class="token punctuation">-</span>eu<span class="token punctuation">-</span>2024<span class="token punctuation">-</span>opentelemetry<span class="token punctuation">-</span>kubernetes<span class="token punctuation">-</span>tracing<span class="token punctuation">-</span>tutorial<span class="token punctuation">-</span>backend4<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5165</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RATE_ERROR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RATE_HIGH_DELAY
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
        <span class="token comment"># NOTE: alternative to instrumentation annotation</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_EXPORTER_OTLP_ENDPOINT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://otel-collector.observability-backend.svc.cluster.local:4317"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OTEL_SERVICE_NAME
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"go-backend"</span></code></pre></div>
</li>
</ul>
<h3 id="add-a-custom-event" style="position:relative;"><a href="#add-a-custom-event" aria-label="add a custom event permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Add a custom Event</strong></h3>
<p>AddEvent adds an event with the provided name and optionsAddEvent adds an event with the provided name and options.</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">causeDelay</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>	<span class="token boolean">_</span><span class="token punctuation">,</span> span <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"causeDelay"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>	<span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	randomNumber <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token operator">+</span>	span<span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span><span class="token string">"roll"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span><span class="token function">WithAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> randomNumber <span class="token operator">&lt;</span> rate <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1e43f293965f8680ef2ef707f75fc1ab/351ee/otlp_image_26.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 57.668711656441715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABvklEQVR42o2SWXPUMBCE/f9/FRRHKI6HbBEnYck6vnTYkizJ62tfmhnVAgnZAh6+mil53J5uOaseC9zf5iiLA5qqhLM9jmPAMQbM05iYjvFZz894ZowezvTwg4VWItXMqAaul/BWwxuFgfpA1XWCehoyMp39hs7OPc8Heo/nI1fbIXvYfURX3EEf8kRZPKCqW4QQ4YYB1jl4HxDiCE9nP/sQI/reoBUS1jqa9ZBSIWuvX0F+fYd29wY6v8I+3+H+2x5KSdR1hbIs0TYNuq4jgR79uXZaQwhBVhW0VjBkXdNZ1ly/hsw/QN68hyJ0U9ImlNE0UWYzlmXGvCyY5/klT87XdcVAjrJ69xbq7gvxmfiUchlHskcPmeA9hR8vM0a6pCPFE2CNSVtn4nCLQVXwukboGoi6hBTtr5v+G97R7UoB23cJ7rMgviPqR3h5SFWJmkK2CGR5WRds65ZgS3+ykOUUzdkyb5oN7R6BhIIqkqDtFd0k2aRBR9ZZmNm27SInYuV6OqWoLgjqdIuGRC3lxMFPxKUNn8LikeZfCGpBvwgJ8voMb/s/8Cwv8kyQcaZLX+KfmC1M54z+BefJwj8Av/mLNQqrZCYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/1e43f293965f8680ef2ef707f75fc1ab/a6d36/otlp_image_26.png"
        srcset="/static/1e43f293965f8680ef2ef707f75fc1ab/222b7/otlp_image_26.png 163w,
/static/1e43f293965f8680ef2ef707f75fc1ab/ff46a/otlp_image_26.png 325w,
/static/1e43f293965f8680ef2ef707f75fc1ab/a6d36/otlp_image_26.png 650w,
/static/1e43f293965f8680ef2ef707f75fc1ab/e548f/otlp_image_26.png 975w,
/static/1e43f293965f8680ef2ef707f75fc1ab/3c492/otlp_image_26.png 1300w,
/static/1e43f293965f8680ef2ef707f75fc1ab/351ee/otlp_image_26.png 3350w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="recorderror-and-set-span-status" style="position:relative;"><a href="#recorderror-and-set-span-status" aria-label="recorderror and set span status permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>RecordError and set span status</strong></h3>
<p>RecordError will record err as an exception span event for this span. An additional call to SetStatus is required if the Status of the Span should be set to Error, as this method does not change the Span status. If this span is not being recorded or err is nil then this method does nothing.</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">causeError</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>	<span class="token boolean">_</span><span class="token punctuation">,</span> span <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"causeError"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>	<span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	randomNumber <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token operator">+</span>	span<span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span><span class="token string">"roll"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span><span class="token function">WithAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> randomNumber <span class="token operator">&lt;</span> rate <span class="token punctuation">{</span>
		err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"number(%d)) &lt; rate(%d)"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">,</span> rate<span class="token punctuation">)</span>
<span class="token operator">+</span>		span<span class="token punctuation">.</span><span class="token function">RecordError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token operator">+</span>		span<span class="token punctuation">.</span><span class="token function">SetStatus</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Error<span class="token punctuation">,</span> <span class="token string">"some error occured"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/59227e9103a31b583dbb29d9e5cdce49/8c565/otlp_image_27.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACMElEQVR42n2SW0/cMBCF88fLpUXsLtCfU55bqYAqpIoWyi6Q3dzWiR3HTpzb3sqejr3wgCrx8Gmc8fjYMyfe2dln7B8c4MPeHvb3D3B8PMDp6RlGoxMMRyOMTk4wGI7c+pXBcIjDw4/4cn6OIAxxcXmFT0dHOB4M4K0XDfq6RK0lVl2NdV9js+yw/btwABtgu8b2eeWi43kXl61BowWd15Tqsd0s4CXhFJwlMCRYFgIq58iyFEUhUUiJNGVgjCHPBYTgjtc9pQoXtdbQSkHmOTyR+MiiR+gsQiViijFm/gRxMAWLAiThDPNo5uKOqft+JQ58Vzt9nOBpcg9PsymS35fIHn6CWx5vML69Qeg/gM8jEp0hjQPIbI6CszdwFiGePbkaW2sv8wwJsl/fkP25Qnp7ATG5hu/74EJQa4pi7tZSFlDUmtLlCxo5tVsoyhGVMdR6Ca9iPtjNVxK8JMHvyMY/YEyFtuvRth0Wi55YvKG39Lv8crl0saP6qqrgqWSK6O4aIhhDhhNImqeSOSqtUFfkvinR1gZtY1xsLHbd1GjoYltnKaQAJzO9VnOU9EpDhhixM2YyvgebJ+SaQMrmyMjplJwWPEMudgdtztZEYeDyBT3CudyVVvAJhocw2cyJJnECltIhzl1RbrHzKgqHpLWdqXz5ZRT9Mros3d5bQT6jF4Y0ixJN20LWNWqa1Xq9fpfVaoXNZkMzb/8XdG3Tbc41QtGgrQHv0XUdGWncC/8BC61u9MdXP1IAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/59227e9103a31b583dbb29d9e5cdce49/a6d36/otlp_image_27.png"
        srcset="/static/59227e9103a31b583dbb29d9e5cdce49/222b7/otlp_image_27.png 163w,
/static/59227e9103a31b583dbb29d9e5cdce49/ff46a/otlp_image_27.png 325w,
/static/59227e9103a31b583dbb29d9e5cdce49/a6d36/otlp_image_27.png 650w,
/static/59227e9103a31b583dbb29d9e5cdce49/e548f/otlp_image_27.png 975w,
/static/59227e9103a31b583dbb29d9e5cdce49/3c492/otlp_image_27.png 1300w,
/static/59227e9103a31b583dbb29d9e5cdce49/8c565/otlp_image_27.png 3346w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="sampling-1" style="position:relative;"><a href="#sampling-1" aria-label="sampling 1 permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Sampling</strong></h2>
<p>The following diagram illustrates how the telemetry data collected there is exported and stored. <a href="https://excalidraw.com/#json=15BrdSOMEkc9RA5cxeqwz,urTmfk01mbx7V-PpQI7KgA">excalidraw</a></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ea81d84715a37606c446ba9c5e2533e2/42de8/otlp_image_28.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.282208588957054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBUlEQVR42o1S7XKEMAj0/V/Tn3raBAMhX3Sj1uvU680xDrMmrLAuQ2ut1opsZheue9gt0h6lFFVFHvAChAwSi3Bg772wBA5aNObjicgUNwrknJ+mKSUcxYGZl2UB0pI8Ez40z3OUGISdeOIN4YkkRlFBDmHbiFCPfsM1J6ZCBllxI9xx6hM559Z1BcCxobDktgfqh0PqIalZ+1EHWHHR2Sql5C4yJ3sW2En+L7IKRvTORd7Q8F7wjozf8bWu8+NBRLm3/Yx8eoZ2GYNrLclau6S+Iz/dLnr6X7vqu/mvybAHZoYQrm7Lso7jiMX43fw1OUMi9iDna/NEBJ7h8CPNfxTeBZvZNx3mxBY72uG4AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/ea81d84715a37606c446ba9c5e2533e2/a6d36/otlp_image_28.png"
        srcset="/static/ea81d84715a37606c446ba9c5e2533e2/222b7/otlp_image_28.png 163w,
/static/ea81d84715a37606c446ba9c5e2533e2/ff46a/otlp_image_28.png 325w,
/static/ea81d84715a37606c446ba9c5e2533e2/a6d36/otlp_image_28.png 650w,
/static/ea81d84715a37606c446ba9c5e2533e2/e548f/otlp_image_28.png 975w,
/static/ea81d84715a37606c446ba9c5e2533e2/42de8/otlp_image_28.png 1033w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/13dfa51d7bc157fcf60b72801aba47b9/e3829/otlp_image_29.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 69.93865030674846%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVR42q2TbW/aMBDH+f5aX+4D9FU3IU3THrqqIiSBoW5aNbXVYIVqdKxAAiHkgQTbsZP/LgayMgl1L2bpfI5i/3z/u3MN/3nUyikvCsg8R06WrhmCMMYyIAsj7YNwpb2UGZSSZAoFnTkIFJkE55n2QuTgTGHNBPkcjElac/2dyQKZAjhN5d6DwD+DAMpBKHoI+A0i0UeWB9t/BfJoAOVfAioFF0orOghUOYeXfsU4amAcG1ujdWQgkkOAjRAOXsD9fgLpfyYlTwAX6ysNm65ae+YkFr6NLVx3LxD16kjtI2S37zayRUZ5Vdr2gEz6mMRNOtyqbLqyydsY+i28Mg2cnNv4Uq9jWX+G4IzAcw9C5RqWrHlVJA2MxVBL/BVYuF808dNv0tqES8BpbOO0Y+Blw8TVWQPO6zqC8zdYe3PsBJcF3QOG/E7n684xMHAaGC1NjEMTE5Lc99t0QRt910YSP0D96CP3HJIrqxxy8RcwzSY6QjdpV5Ld1Mb7ro3npoXTHslPLerVpKp4CSjN8yPcj1zMvOBxY2dwVx3Ko7kthk0XtHB8YeLog4HjTwYeljcQJI0xRv0pNn1LUS6p6aczX4PLIGvlbZvCLLYgg6RaFC1V1rHxtmeiO7ukXayK7smnt9skVEjtc02SPxLUxjztUMFuScFh2E76Xg73N9OLKATlKyUv/ymqxxH+BvZ/KZaijN75AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/13dfa51d7bc157fcf60b72801aba47b9/a6d36/otlp_image_29.png"
        srcset="/static/13dfa51d7bc157fcf60b72801aba47b9/222b7/otlp_image_29.png 163w,
/static/13dfa51d7bc157fcf60b72801aba47b9/ff46a/otlp_image_29.png 325w,
/static/13dfa51d7bc157fcf60b72801aba47b9/a6d36/otlp_image_29.png 650w,
/static/13dfa51d7bc157fcf60b72801aba47b9/e548f/otlp_image_29.png 975w,
/static/13dfa51d7bc157fcf60b72801aba47b9/e3829/otlp_image_29.png 1077w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/30dedd431979e2fdfbc7971894a0a346/6f278/otlp_image_30.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 27.607361963190186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVR42j1QTUvDQBDN/xTBi//GkxdBPOnFk0UFr/ZiUVuqjdUKBtrUJk2TNM1udjP7Mbvr2qKPmWF48Ib3JrDWEt7mhBXUz7Yg7XJDGxDOObuF20JqmxPpa7kR60Z5AEDQmy0e45S2a2sKxBJNrpFJpbX+bS9+SbK7Sfy+DC3ecLjmosPgtmGFUhic9sOj7iCpQucGGoeIT1LN67opy1IIwaW6HH0c9z6vwguHeyAOpNxv+SFtZpzL4OR51Hn7okxZ4zQ6BQisXeUrQoj37cXnw/FZf/K6GBt9D6KrVFfwh4pUURQFUVGBEIwzpYS1xhhE1GYb1XvWxsxr6mN4YkciOsaRUlbXdcA5j+N4Op1mWbb7jf0D+kvG/JPO+d0K0SbJd5qmAPADVx5N8Tp4/ukAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/30dedd431979e2fdfbc7971894a0a346/a6d36/otlp_image_30.png"
        srcset="/static/30dedd431979e2fdfbc7971894a0a346/222b7/otlp_image_30.png 163w,
/static/30dedd431979e2fdfbc7971894a0a346/ff46a/otlp_image_30.png 325w,
/static/30dedd431979e2fdfbc7971894a0a346/a6d36/otlp_image_30.png 650w,
/static/30dedd431979e2fdfbc7971894a0a346/e548f/otlp_image_30.png 975w,
/static/30dedd431979e2fdfbc7971894a0a346/3c492/otlp_image_30.png 1300w,
/static/30dedd431979e2fdfbc7971894a0a346/6f278/otlp_image_30.png 1488w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="head-sampling" style="position:relative;"><a href="#head-sampling" aria-label="head sampling permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>head-sampling</h3>
<p>For the list of all available samplers, check the <a href="https://opentelemetry.io/docs/languages/sdk-configuration/general/#otel_traces_sampler">offical documentation</a></p>
<p><strong>Auto Instrumentation</strong></p>
<p>Update the sampling % in the Auto Instrumentation CR and restart the deployment for the configurations to take effect.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"> <span class="token key atrule">sampler</span><span class="token punctuation">:</span> 
   <span class="token key atrule">type</span><span class="token punctuation">:</span> parentbased_traceidratio 
   <span class="token key atrule">argument</span><span class="token punctuation">:</span> <span class="token string">"0.5"</span> </code></pre></div>
<p><strong>Manual Instrumentation</strong></p>
<p>You can also configure the ParentBasedTraceIdRatioSampler in code.A <a href="https://pkg.go.dev/go.opentelemetry.io/otel/sdk/trace#Sampler"><code class="language-text">Sampler</code></a> can be set on the tracer provider using the <a href="https://pkg.go.dev/go.opentelemetry.io/otel/sdk/trace#WithSampler"><code class="language-text">WithSampler</code></a> option, as follows:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">provider <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">NewTracerProvider</span><span class="token punctuation">(</span>
    trace<span class="token punctuation">.</span><span class="token function">WithSampler</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span><span class="token function">NewParentBasedTraceIdRatioSampler</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre></div>
<h3 id="tail-sampling" style="position:relative;"><a href="#tail-sampling" aria-label="tail sampling permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tail-sampling</h3>
<ol>
<li>
<p>Sample 100% of traces with ERROR-ing spans</p>
</li>
<li>
<p>Sample 100% of trace which have a duration longer than 500ms</p>
</li>
<li>
<p>Randomized sampling of 10% of traces without errors and latencies.</p>
</li>
</ol>
<ul>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">tail_sampling</span><span class="token punctuation">:</span>
        <span class="token key atrule">decision_wait</span><span class="token punctuation">:</span> 10s <span class="token comment"># time to wait before making a sampling decision</span>
        <span class="token key atrule">num_traces</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># number of traces to be kept in memory</span>
        <span class="token key atrule">expected_new_traces_per_sec</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># expected rate of new traces per second</span>
        <span class="token key atrule">policies</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>errors
            <span class="token key atrule">type</span><span class="token punctuation">:</span> status_code
            <span class="token key atrule">status_code</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">status_codes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>slow<span class="token punctuation">-</span>traces
            <span class="token key atrule">type</span><span class="token punctuation">:</span> latency
            <span class="token key atrule">latency</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">threshold_ms</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> randomized<span class="token punctuation">-</span>policy
            <span class="token key atrule">type</span><span class="token punctuation">:</span> probabilistic
            <span class="token key atrule">probabilistic</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">sampling_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>tail_sampling<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
</li>
</ul>
<p>You also have the flexibility to add other policies. For the list of all policies, check the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/tailsamplingprocessor/README.md">offical documentation</a></p>
<h3 id="advanced-topic-tail-sampling-at-scale-with-opentelemetry" style="position:relative;"><a href="#advanced-topic-tail-sampling-at-scale-with-opentelemetry" aria-label="advanced topic tail sampling at scale with opentelemetry permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Advanced Topic: Tail Sampling at scale with OpenTelemetry</strong></h3>
<p>with the first layer routing all spans of a trace to the same collector in the downstream deployment (using a <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/loadbalancingexporter/README.md">load-balancing exporter</a>), and the second layer performing the tail sampling.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/63e5130e144883cd220d6adced0188fc/1719c/otlp_image_31.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 63.190184049079754%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVR42nXSS5OCMBAEYP7/D/TihYOWCD4WRXmpu18xbHalyjlAkpnu6Z4k+/4Qz+fzeDxWVZXn+Waz2e/3ZVmO4/i/Jqvr+nQ6fU3Rtm1KPB6P+/0+TmEt1fd913VSr9drBjdNAx9NxDAMKvopkMI4tLher5fLZQmOH3o52qICherD4YB3mMKhFCJ2lmBpeBXJlQVRFjDn89mCit1uh1HxDFZkowOdYTKBb7db+IzOIoai2BT0z8yJYdy+5qmPHM3Ot9utrVY8IyqnsFiv16vVynkWrEp96bRFyZiekFqFZ6LaKfRMZbPnEAwgt/BMBV1KsRdFYf3nOQ1Mc3W4tY0TCn3Ddkyb/rer0iouRsJN4I7XopTnuDDdEDlPPWdw9xsSoTmIgxFLvJlk/g386W3HYGAMP7SIxdv+AfhA8fRVK7p/AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/63e5130e144883cd220d6adced0188fc/a6d36/otlp_image_31.png"
        srcset="/static/63e5130e144883cd220d6adced0188fc/222b7/otlp_image_31.png 163w,
/static/63e5130e144883cd220d6adced0188fc/ff46a/otlp_image_31.png 325w,
/static/63e5130e144883cd220d6adced0188fc/a6d36/otlp_image_31.png 650w,
/static/63e5130e144883cd220d6adced0188fc/e548f/otlp_image_31.png 975w,
/static/63e5130e144883cd220d6adced0188fc/3c492/otlp_image_31.png 1300w,
/static/63e5130e144883cd220d6adced0188fc/1719c/otlp_image_31.png 2914w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ul>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed
      <span class="token key atrule">loadbalancing</span><span class="token punctuation">:</span>
        <span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">"traceID"</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
          <span class="token key atrule">otlp</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 1s
            <span class="token key atrule">tls</span><span class="token punctuation">:</span>
              <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">resolver</span><span class="token punctuation">:</span>
          <span class="token key atrule">k8s</span><span class="token punctuation">:</span>
            <span class="token key atrule">service</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>gateway.observability<span class="token punctuation">-</span>backend
            <span class="token key atrule">ports</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token number">4317</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>loadbalancing<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>gateway
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> statefulset
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">tail_sampling</span><span class="token punctuation">:</span>
        <span class="token key atrule">decision_wait</span><span class="token punctuation">:</span> 10s <span class="token comment"># time to wait before making a sampling decision is made</span>
        <span class="token key atrule">num_traces</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># number of traces to be kept in memory</span>
        <span class="token key atrule">expected_new_traces_per_sec</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># expected rate of new traces per second</span>
        <span class="token key atrule">policies</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>errors
            <span class="token key atrule">type</span><span class="token punctuation">:</span> status_code
            <span class="token key atrule">status_code</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">status_codes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>slow<span class="token punctuation">-</span>traces
            <span class="token key atrule">type</span><span class="token punctuation">:</span> latency
            <span class="token key atrule">latency</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">threshold_ms</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> randomized<span class="token punctuation">-</span>policy
            <span class="token key atrule">type</span><span class="token punctuation">:</span> probabilistic
            <span class="token key atrule">probabilistic</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">sampling_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>tail_sampling<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
</li>
<li></li>
</ul>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0857664cd3065aaeb674f7b9eecfeeb4/ce0a7/otlp_image_32.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 22.085889570552148%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAu0lEQVR42j2OiQqEMAxE/f9/UxBFraAW7aEL4oJX1ZZZEnAHSiHzJpkoFSk+3w+CD3CXw/M8uO8bIQS8uq4LXdfBOYdxHKGUYs4Yg2EYsO87z8mPZCthjYXWGlJKhpumgbUW27ZhXVec58k+qe979l/Pe89zyh3HgYguKK0ghOAQvbZt+adFFCJwmiYOEl/X9f/QKypDJaKyLJHnOZIkYTDLMn7UYp5nhilIzUhVVSGOYyzLwktfFUXBzA8WqixGRP6J2AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/0857664cd3065aaeb674f7b9eecfeeb4/a6d36/otlp_image_32.png"
        srcset="/static/0857664cd3065aaeb674f7b9eecfeeb4/222b7/otlp_image_32.png 163w,
/static/0857664cd3065aaeb674f7b9eecfeeb4/ff46a/otlp_image_32.png 325w,
/static/0857664cd3065aaeb674f7b9eecfeeb4/a6d36/otlp_image_32.png 650w,
/static/0857664cd3065aaeb674f7b9eecfeeb4/e548f/otlp_image_32.png 975w,
/static/0857664cd3065aaeb674f7b9eecfeeb4/3c492/otlp_image_32.png 1300w,
/static/0857664cd3065aaeb674f7b9eecfeeb4/ce0a7/otlp_image_32.png 1590w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="advanced-topic-jaegers-remote-sampling-extension" style="position:relative;"><a href="#advanced-topic-jaegers-remote-sampling-extension" aria-label="advanced topic jaegers remote sampling extension permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Advanced Topic: Jaeger’s Remote Sampling extension</strong></h3>
<p>This extension allows serving sampling strategies following the Jaeger’s remote sampling API. This extension can be configured to proxy requests to a backing remote sampling server, which could potentially be a Jaeger Collector down the pipeline, or a static JSON file from the local file system.</p>
<p><strong>Example Configuration</strong></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">extensions</span><span class="token punctuation">:</span>
  <span class="token key atrule">jaegerremotesampling</span><span class="token punctuation">:</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">reload_interval</span><span class="token punctuation">:</span> 30s
      <span class="token key atrule">remote</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">14250</span>
  <span class="token key atrule">jaegerremotesampling/1</span><span class="token punctuation">:</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">reload_interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">file</span><span class="token punctuation">:</span> /etc/otelcol/sampling_strategies.json
  <span class="token key atrule">jaegerremotesampling/2</span><span class="token punctuation">:</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">reload_interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">file</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//jaeger.example.com/sampling_strategies.json</code></pre></div>
<p>For more details, check the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/extension/jaegerremotesampling/README.md">offical documentation</a></p>
<h2 id="red-metrics" style="position:relative;"><a href="#red-metrics" aria-label="red metrics permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>RED Metrics</strong></h2>
<p>the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/spanmetricsconnector"><code class="language-text">spanmetrics</code> connector</a> in a separate collector pipeline. This connector will derive Rate, Error, and Duration (RED) metrics from the spans it processes.</p>
<ul>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">tail_sampling</span><span class="token punctuation">:</span>
        <span class="token key atrule">decision_wait</span><span class="token punctuation">:</span> 10s <span class="token comment"># time to wait before making a sampling decision</span>
        <span class="token key atrule">num_traces</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># number of traces to be kept in memory</span>
        <span class="token key atrule">expected_new_traces_per_sec</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># expected rate of new traces per second</span>
        <span class="token key atrule">policies</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>errors
            <span class="token key atrule">type</span><span class="token punctuation">:</span> status_code
            <span class="token key atrule">status_code</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">status_codes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>slow<span class="token punctuation">-</span>traces
            <span class="token key atrule">type</span><span class="token punctuation">:</span> latency
            <span class="token key atrule">latency</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">threshold_ms</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> randomized<span class="token punctuation">-</span>policy
            <span class="token key atrule">type</span><span class="token punctuation">:</span> probabilistic
            <span class="token key atrule">probabilistic</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">sampling_percentage</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">connectors</span><span class="token punctuation">:</span>
      <span class="token key atrule">spanmetrics</span><span class="token punctuation">:</span>

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>tail_sampling<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">]</span>
        <span class="token key atrule">traces/spanmetrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>spanmetrics<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">,</span>spanmetrics<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
</li>
</ul>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/59a06f0f0136a325d67d204d35e8fd74/e7dd1/otlp_image_33.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABeklEQVR42qVS207CQBDt/xuCcpOCBBPjg29+iYlifLG0ZVsqpHh5aLstvRxnlhYogolxkpOdncvZmZ3Rrm9uoY/GaPd0XHR1NHsjnHf6OGsN0GjT2R6g2dHR7Q/R06+O4lIfotUfozG4gyaTDEmSoCgKHJPj1j1/GeB9ZbifJNBcbwHDtOC9LRTxcunj/eNT3Z+eX/DwOIG/WilfFEWQUtYQRRJhSPY4QpZKqpCMaZoiyzLkeb4F37eobHu+w1gZhgiCEFocx9sAbnsfu7aKmv9Qr+7cxa+Ep1AjLErCnAhjImTW/xAyOD+UAcKobLkK+Iv8+BLaB+ZSFQb0odUEeWKsM8LSvtF3dk7kQXJuBZ72ep1C43Id4cCyZ3AcF8Z0Csd1YVk2TFqnGflM0i3bxmwm1On7K1qTuNY+qEbeWiLMIYQLmwIFJb8ahiKcmqYCk6hTCAhnQ85+rviwdRaNX5jPPRXsunMFQZUyEVfMdiZQhPSg7/uqqlPyDS1RjbBFyQQmAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/59a06f0f0136a325d67d204d35e8fd74/a6d36/otlp_image_33.png"
        srcset="/static/59a06f0f0136a325d67d204d35e8fd74/222b7/otlp_image_33.png 163w,
/static/59a06f0f0136a325d67d204d35e8fd74/ff46a/otlp_image_33.png 325w,
/static/59a06f0f0136a325d67d204d35e8fd74/a6d36/otlp_image_33.png 650w,
/static/59a06f0f0136a325d67d204d35e8fd74/e548f/otlp_image_33.png 975w,
/static/59a06f0f0136a325d67d204d35e8fd74/3c492/otlp_image_33.png 1300w,
/static/59a06f0f0136a325d67d204d35e8fd74/e7dd1/otlp_image_33.png 3354w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="jaeger-configuration" style="position:relative;"><a href="#jaeger-configuration" aria-label="jaeger configuration permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Jaeger Configuration</strong></h3>
<p>To tie together our new RED metrics with our trace data we can configure Jaeger to display service performance metrics from Prometheus. We can do this by adding environment variables that tell Jaeger where to find metrics and how to interpret them.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> METRICS_STORAGE_TYPE 
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"prometheus"</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROMETHEUS_SERVER_URL 
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://prometheus.observability-backend"</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROMETHEUS_QUERY_SUPPORT_SPANMETRICS_CONNECTOR 
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROMETHEUS_QUERY_NORMALIZE_CALLS 
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROMETHEUS_QUERY_NORMALIZE_DURATION 
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/06c8bd75ba5e40fc08056134541b7d24/5068c/otlp_image_34.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 34.355828220858896%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42o2QS26EMAyGc/SpNILCApUuqjkAh5ijIA7QJ6VJwMRxXnVgaNVdP3mR+PH/iUVZlk3TPLTtY9M8Xa93bXs+neq6vv9LVVVFUVwul77vh2Houo57BCKGEFJKkcN7v53/iVBKGYNEzlqy5MgHPa+cdL+wpF+WRUpprQ0hchB5CUZsZkzcMUAAmNs5vZXykYWJwu2SC0hOAop1NQBgDrgpxkPph0M73b6Xsn8M4nPj+eV1HMdpmlhI6tnkRXiesIgc7MbzGmBU6mueJ60XWNhJ7NtyLr9oXwOgA4Np8+EZ72jvAcQ3pT60fldqxcw3OfeCemGfwtUAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/06c8bd75ba5e40fc08056134541b7d24/a6d36/otlp_image_34.png"
        srcset="/static/06c8bd75ba5e40fc08056134541b7d24/222b7/otlp_image_34.png 163w,
/static/06c8bd75ba5e40fc08056134541b7d24/ff46a/otlp_image_34.png 325w,
/static/06c8bd75ba5e40fc08056134541b7d24/a6d36/otlp_image_34.png 650w,
/static/06c8bd75ba5e40fc08056134541b7d24/e548f/otlp_image_34.png 975w,
/static/06c8bd75ba5e40fc08056134541b7d24/3c492/otlp_image_34.png 1300w,
/static/06c8bd75ba5e40fc08056134541b7d24/5068c/otlp_image_34.png 1917w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/5d50ffe7b9d4e5981295c0cd06418932/37cd1/otlp_image_35.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41.104294478527606%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJ0lEQVR42pVRy27CMBD0//9FT0iVIoWgRHwAZz6Bqhcq8iKExK/Yme6aOKKISy2Ndtfex3hWbDYbpGmKPM8Div0eH4cDPrdbZHSfvkGWZUiSBMfjEU3T4HQ6oSgK7HY7CCkljDHw3mOe52CdUsH/z4n54nbrMY4jpmmCtTZgcg73UaHruhA7iiN4INe0bQut9UrCGIu71BAxyXu2c0hw1FxLtbL+A3p7/RFbMzn0yj4aWkpghg8WPoB/EAteMb+5YzIMwaJWVYWyLFHXdbAcj8MQhvioa2wWh9DweWnuFtacL/q+h1IadXMLWrJm2mj81C36QS5SeChanlYy6MtNz9crvi4XfNPwM5Hi5SrSVDxv89l3rOVSvLyS79fY0puk4YowELu40F9jpmTYytbotwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/5d50ffe7b9d4e5981295c0cd06418932/a6d36/otlp_image_35.png"
        srcset="/static/5d50ffe7b9d4e5981295c0cd06418932/222b7/otlp_image_35.png 163w,
/static/5d50ffe7b9d4e5981295c0cd06418932/ff46a/otlp_image_35.png 325w,
/static/5d50ffe7b9d4e5981295c0cd06418932/a6d36/otlp_image_35.png 650w,
/static/5d50ffe7b9d4e5981295c0cd06418932/e548f/otlp_image_35.png 975w,
/static/5d50ffe7b9d4e5981295c0cd06418932/3c492/otlp_image_35.png 1300w,
/static/5d50ffe7b9d4e5981295c0cd06418932/37cd1/otlp_image_35.png 3332w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="opentelemetry-transformation-language-and-spans-ottl" style="position:relative;"><a href="#opentelemetry-transformation-language-and-spans-ottl" aria-label="opentelemetry transformation language and spans ottl permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>OpenTelemetry Transformation Language and Spans (OTTL)</strong></h2>
<p>The OpenTelemetry Transformation Language (OTTL) is a powerful language that allows you to transform telemetry data flowing through the Collector. The transformation of data is executed based on OTTL statements, which define how the telemetry should be transformed. It is a stand-alone part of the Collector codebase that is (re)used in several components, such as <code class="language-text">filterprocessor</code>, <code class="language-text">transformprocessor</code> or <code class="language-text">routingprocessor</code>.</p>
<h3 id="contexts" style="position:relative;"><a href="#contexts" aria-label="contexts permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Contexts</strong></h3>
<p>Context determines which part of telemetry data should the statement be applied to. This can be universal for all signals, such as <code class="language-text">Resource</code> and <code class="language-text">Instrumentation Scope</code>, or they differ depending on the type of the signal such <code class="language-text">Span</code>, <code class="language-text">Datapoint</code> or <code class="language-text">Log</code>. In the statement, a particular part of the context can be accessed via <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/ottl/LANGUAGE.md#paths">paths</a>, which support the familiar <code class="language-text">.</code> notation and accessing particular keys with <code class="language-text">[]</code> (see the example above - <code class="language-text">attributes["client_error"]</code> - accessing a particular attribute). Full list of all contexts can be found <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/ottl#getting-started">here</a>.</p>
<h3 id="functions" style="position:relative;"><a href="#functions" aria-label="functions permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Functions</strong></h3>
<p>OTTL provides a list of predefined functions that come in two flavors - <strong>editors</strong> and <strong>converters</strong>. Editors work directly on and transform telemetry itself. Editors functions include functions such as a <code class="language-text">set</code>, <code class="language-text">delete_key</code>, <code class="language-text">replace_match</code> or <code class="language-text">limit</code>. Conversely, converters are used to transform input within a statement and they do <strong>not</strong> modify the telemetry themselves. These can be used e.g. to get input length (<code class="language-text">Len</code>), manipulate strings (<code class="language-text">Concat</code>) or assert types (<code class="language-text">IsInt</code>, <code class="language-text">IsMap</code>, <code class="language-text">IsString</code>…). Full list of both types of functions can be found <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/ottl/ottlfuncs#ottl-functions">here</a></p>
<p>inspect the configuration for our <code class="language-text">transformprocessor</code> below:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">processors</span><span class="token punctuation">:</span>
    <span class="token key atrule">transform</span><span class="token punctuation">:</span>
        <span class="token key atrule">error_mode</span><span class="token punctuation">:</span> ignore
        <span class="token key atrule">trace_statements</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span> span
            <span class="token key atrule">statements</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""</code></pre></div>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">processors</span><span class="token punctuation">:</span>
    <span class="token key atrule">transform</span><span class="token punctuation">:</span>
        <span class="token key atrule">error_mode</span><span class="token punctuation">:</span> ignore
        <span class="token key atrule">trace_statements</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span> span
            <span class="token key atrule">statements</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""
                <span class="token punctuation">-</span> replace_all_patterns(attributes<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"player1=[a-zA-Z]*"</span><span class="token punctuation">,</span> "player1=<span class="token punctuation">{</span>playerName<span class="token punctuation">}</span>")
                <span class="token punctuation">-</span> replace_all_patterns(attributes<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"player2=[a-zA-Z]*"</span><span class="token punctuation">,</span> "player2=<span class="token punctuation">{</span>playerName<span class="token punctuation">}</span>")
</code></pre></div>
<ul>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> otel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> observability<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>telemetry/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>releases/opentelemetry<span class="token punctuation">-</span>collector<span class="token punctuation">-</span>contrib<span class="token punctuation">:</span>0.94.0
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> deployment
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318</span>

    <span class="token key atrule">processors</span><span class="token punctuation">:</span>
      <span class="token key atrule">batch</span><span class="token punctuation">:</span>
      <span class="token key atrule">transform</span><span class="token punctuation">:</span>
        <span class="token key atrule">error_mode</span><span class="token punctuation">:</span> ignore
        <span class="token key atrule">trace_statements</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span> span
            <span class="token key atrule">statements</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player1"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""
                <span class="token punctuation">-</span> set(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Substring(attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1)) where attributes<span class="token punctuation">[</span><span class="token string">"app.player2"</span><span class="token punctuation">]</span> <span class="token tag">!=</span> ""
                <span class="token punctuation">-</span> replace_all_patterns(attributes<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"player1=[a-zA-Z_]*"</span><span class="token punctuation">,</span> "player1=<span class="token punctuation">{</span>playerName<span class="token punctuation">}</span>")
                <span class="token punctuation">-</span> replace_all_patterns(attributes<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"player2=[a-zA-Z_]*"</span><span class="token punctuation">,</span> "player2=<span class="token punctuation">{</span>playerName<span class="token punctuation">}</span>")

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp/traces</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>collector<span class="token punctuation">:</span><span class="token number">4317</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">otlphttp/metrics</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//prometheus.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span>80/api/v1/otlp/
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> detailed

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>transform<span class="token punctuation">,</span> batch<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp/traces<span class="token punctuation">]</span>
        <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlphttp/metrics<span class="token punctuation">]</span>
        <span class="token key atrule">logs</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>debug<span class="token punctuation">]</span></code></pre></div>
</li>
</ul>
<h3 id="trace-your-k8s-environment-with-opentelemetry" style="position:relative;"><a href="#trace-your-k8s-environment-with-opentelemetry" aria-label="trace your k8s environment with opentelemetry permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Trace your k8s environment with OpenTelemetry</strong></h3>
<p>Deploy OpenTelemetry Collector as Daemonset with hostnetowrk access:</p>
<ul>
<li>
<p>yaml</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> opentelemetry.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> OpenTelemetryCollector
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>tracing
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> daemonset
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
    processors:</span>

    <span class="token key atrule">exporters</span><span class="token punctuation">:</span>
      <span class="token key atrule">otlp</span><span class="token punctuation">:</span>
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">"otel-collector.observability-backend.svc.cluster.local:4317"</span>
        <span class="token key atrule">tls</span><span class="token punctuation">:</span>
          <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
        <span class="token key atrule">traces</span><span class="token punctuation">:</span>
          <span class="token key atrule">receivers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span>
          <span class="token key atrule">processors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token key atrule">exporters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>otlp<span class="token punctuation">]</span></code></pre></div>
</li>
</ul>
<h3 id="etcd" style="position:relative;"><a href="#etcd" aria-label="etcd permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ETCD</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">spec:
  containers:
  - command:
    - etcd
    - --data-dir=/var/lib/etcd
+   - --experimental-distributed-tracing-address=127.0.0.1:4317
+   - --experimental-distributed-tracing-instance-id=caf201fd-8d5b-467b-a70f-09ad3beb5a21
+   - --experimental-distributed-tracing-sampling-rate=1000000
+   - --experimental-distributed-tracing-service-name=etcd
+   - --experimental-enable-distributed-tracing=true
    - --experimental-initial-corrupt-check=true
    image: quay.io/coreos/etcd:v3.5.11
  hostNetwork: true</code></pre></div>
<h3 id="api-server" style="position:relative;"><a href="#api-server" aria-label="api server permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>API-Server</strong></h3>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>mode=Node<span class="token punctuation">,</span>RBAC
<span class="token punctuation">-</span>   <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>feature<span class="token punctuation">-</span>gates=KubeletInUserNamespace=true
+   <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>feature<span class="token punctuation">-</span>gates=APIServerTracing=true<span class="token punctuation">,</span>KubeletInUserNamespace=true
+   <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tracing<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file=/api<span class="token punctuation">-</span>server/tracing<span class="token punctuation">-</span>config.yaml
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.k8s.io/kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">:</span>v1.29.1
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> kind<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical</code></pre></div>
<p>Once the API-Server and ETCD are reporting telemetry data we can make some noise by creating and deleting an nginx instance:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl create deployment nginx-project <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx
deployment.apps/nginx-project created
---
$ kubectl get deployments.apps
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
nginx-project   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           1m
---
$ kubectl delete deployments.apps nginx-project
deployment.apps <span class="token string">"nginx-project"</span> deleted</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bb45f028ee3db896d2a6f3b8beeb8c26/7ebf9/otlp_image_36.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpUlEQVR42n3RzW7UMBAA4Lz/OwAqW8KuknLh0gfg0ku7tGy1W6SuKN04ieP4Z2zHTvyDN0tBPYD1aTQaa+SxnZ0vl2/Pzt4tFm8+5OdFkRfFqixXF59mF8myLD/O8qJcLFdfrq52j4+fLy/f53lmvXcxjjFy71UIEEIbIw4BB09iwNH3866KUc6RjrbVins3hZA9VVXTESqACUG5IIxjxjrKqo5sqmqL6m2FdhV6qFNS7RD63jQpeUj1wyG7peyasjXjN7P1LCV3PX1++okxFkoJrX9TioMkjFEhes6zjYA1F19fS5UNZbKpdUeMgFHKEzeOzjk/m8bxf82s62hPO9L3hCRAqR0Ga60x5hT/2XzPBRwHNspOLj2q9z6EKR34Ypym7BsXp9vepOTFNRd3jDcYAwcjh0FJJUSiAYzWRqtjBSD7UaE9quu+b0A2Sv9RS0U43zO+pRQBVCBnUEuZPHN+YCyTlDa4BdpPWk/G/GVtjFF7R6y9B7hlZM3IXintvXROem/SPwuM2xpJQo7zvF4hhNSf4uidnUyS3rodNJIUKcat/QWONVt1jGNyzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/bb45f028ee3db896d2a6f3b8beeb8c26/a6d36/otlp_image_36.png"
        srcset="/static/bb45f028ee3db896d2a6f3b8beeb8c26/222b7/otlp_image_36.png 163w,
/static/bb45f028ee3db896d2a6f3b8beeb8c26/ff46a/otlp_image_36.png 325w,
/static/bb45f028ee3db896d2a6f3b8beeb8c26/a6d36/otlp_image_36.png 650w,
/static/bb45f028ee3db896d2a6f3b8beeb8c26/e548f/otlp_image_36.png 975w,
/static/bb45f028ee3db896d2a6f3b8beeb8c26/3c492/otlp_image_36.png 1300w,
/static/bb45f028ee3db896d2a6f3b8beeb8c26/7ebf9/otlp_image_36.png 1919w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="kubelet" style="position:relative;"><a href="#kubelet" aria-label="kubelet permalink" class="toc-anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong>Kubelet</strong></h3>
<p>This should be the effect:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1
    <span class="token key atrule">featureGates</span><span class="token punctuation">:</span>
      <span class="token key atrule">KubeletInUserNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">+     KubeletTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">...</span>
    <span class="token key atrule">syncFrequency</span><span class="token punctuation">:</span> 0s
<span class="token key atrule">+   tracing</span><span class="token punctuation">:</span>
<span class="token key atrule">+     endpoint</span><span class="token punctuation">:</span> otel<span class="token punctuation">-</span>collector.observability<span class="token punctuation">-</span>backend.svc.cluster.local<span class="token punctuation">:</span><span class="token number">4317</span>
<span class="token key atrule">+     samplingRatePerMillion</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
    <span class="token key atrule">volumeStatsAggPeriod</span><span class="token punctuation">:</span> 0s</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/7ebf9/otlp_image_37.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 51.533742331288344%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfUlEQVR42nXRbW+bMBAHcL7/N5k0KeqWpK3o+73otIc0SbcuWxdoEtsY23d2wGBDd1AJ5c1OP1nHoYO/ILlaLN7NZu+vPszm8/ntLVmm6Zubu7ubdHCdpm8+Lq8/3d9nxyOd88Uy4dbppsEYie06jJ3tegIhMt/wpiWiDcV4Sc2p9rtCvljHqyp5EMW6VFulNwO1KQc0ybT5mee/GMuVzpTKtaZmOLXel+Veln84T1ZovwLByTfAz4CHc9V5f/Ye68o3zWvXDWLsR9SHxidrAysDDwRw8h0wd45LmQmRcc6UKrRhspQG0DkC1pZKJTtaU3przCPgZAtI8x9Z9pi/PB0Oz0JQzr9S7qWUAGoklU527vxljHqJJjtro/d124Yx5KSLMQaaxbqu/7v8hMgZY0IU9LaSMio5VimlVgoBwJjkN+JKm42BLeJkjfhsLTudCC0IIWjZGKO1PnCec76nv3A8JnSTnm0Aagp5YfjCY/V9/3pRVQiubV0IWNf/AK5cImMciuj+AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image.png"
        title=""
        src="/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/a6d36/otlp_image_37.png"
        srcset="/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/222b7/otlp_image_37.png 163w,
/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/ff46a/otlp_image_37.png 325w,
/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/a6d36/otlp_image_37.png 650w,
/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/e548f/otlp_image_37.png 975w,
/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/3c492/otlp_image_37.png 1300w,
/static/e6a713cc0d57ed99f6fc7ebe1061bdaa/7ebf9/otlp_image_37.png 1919w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><a href="https://www.notion.so/kubecon-eu-2023-opentelemetry-kubernetes-tutorial-f1183194544b4f5388182d23596c068d?pvs=21">kubecon-eu-2023-opentelemetry-kubernetes-tutorial</a></p>
<p><a href="https://www.notion.so/kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial-e19707c8d8694ffaa9ce17e7ce9dc6f5?pvs=21">kubecon-na-2023-opentelemetry-kubernetes-metrics-tutorial</a></p>
<p>[<a href="https://github.com/pavolloffay/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial">kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial</a>](<a href="https://www.notion.so/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial-73cc3f20c41b483cba868a4fb2cd5319?pvs=21">https://www.notion.so/kubecon-eu-2024-opentelemetry-kubernetes-tracing-tutorial-73cc3f20c41b483cba868a4fb2cd5319?pvs=21</a>)</p>
<p><a href="https://www.notion.so/otlp-06a83b387055416dbbadf700671da68e?pvs=21">otlp使用指南</a></p></div></div></div><div class="max-w-4xl mx-auto mt-8"><div class="giscus"></div></div><div class="hidden lg:block fixed left-4 top-32 w-64"><div class="bg-white p-4 rounded-lg shadow-lg" style="max-height:calc(100vh - 12rem);overflow-y:auto"><h3 class="font-bold mb-2 text-left">目录: </h3><div class="text-left"><ul>
<li>
<p><a href="#otlp">OTLP</a></p>
</li>
<li>
<p><a href="#eu-2023">EU 2023</a></p>
<ul>
<li>
<p><a href="#otelcol">otelcol</a></p>
</li>
<li>
<p><a href="#otelinst">otelinst</a></p>
<ul>
<li><a href="#resource-attributes"><strong>Resource attributes</strong></a></li>
<li><a href="#sampling"><strong>Sampling</strong></a></li>
<li><a href="#pii-and-data-manipulation"><strong>PII and data manipulation</strong></a></li>
</ul>
</li>
<li>
<p><a href="#metrics"><strong>Metrics</strong></a></p>
</li>
<li>
<p><a href="#logs"><strong>Logs</strong></a></p>
</li>
<li>
<p><a href="#roadmap">Roadmap</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#na-2023">NA 2023</a></p>
<ul>
<li>
<p><a href="#auto-instrumentation"><strong>Auto-instrumentation</strong></a></p>
</li>
<li>
<p><a href="#collector-overview"><strong>Collector Overview</strong></a></p>
</li>
<li>
<p><a href="#collecting-prometheus-metrics"><strong>Collecting Prometheus Metrics</strong></a></p>
<ul>
<li><a href="#1-configure-prometheus-target-discovery"><strong>1. Configure Prometheus Target Discovery</strong></a></li>
<li><a href="#2-scaling-metrics-pipeline-with-the-target-allocator"><strong>2. Scaling metrics pipeline with the target allocator</strong></a></li>
</ul>
</li>
<li>
<p><a href="#collecting-kubernetes-infrastracture-metrics"><strong>Collecting Kubernetes infrastracture metrics</strong></a></p>
<ul>
<li><a href="#kubelet-stats-receiver"><strong>Kubelet Stats Receiver</strong></a></li>
<li><a href="#kubernetes-cluster-receiver"><strong>Kubernetes Cluster Receiver</strong></a></li>
<li><a href="#host-metrics-receiver"><strong>Host Metrics Receiver</strong></a></li>
<li><a href="#prometheus-receiver"><strong>Prometheus Receiver</strong></a></li>
</ul>
</li>
<li>
<p><a href="#correlation"><strong>Correlation</strong></a></p>
<ul>
<li><a href="#collecting-kubernetes-resource-attributes"><strong>Collecting Kubernetes resource attributes</strong></a></li>
<li><a href="#resource-detection-processor"><strong>Resource Detection Processor</strong></a></li>
<li><a href="#exemplars"><strong>Exemplars</strong></a></li>
<li><a href="#collector-spanmetrics-connector"><strong>Collector: Spanmetrics Connector</strong></a></li>
<li><a href="#baggage"><strong>Baggage</strong></a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#eu-2024">EU-2024</a></p>
<ul>
<li>
<p><a href="#auto-instrumentation-1">Auto-instrumentation</a></p>
<ul>
<li><a href="#customize-java-auto-instrumentation-with-config-capture-more-data"><strong>Customize Java auto-instrumentation with config (capture more data)</strong></a></li>
<li><a href="#customize-java-auto-instrumentation-with-code-capture-more-data"><strong>Customize Java auto-instrumentation with code (capture more data)</strong></a></li>
</ul>
</li>
<li>
<p><a href="#manual-instrumentation-using-the-opentelemetry-sdk"><strong>Manual instrumentation using the OpenTelemetry SDK</strong></a></p>
<ul>
<li><a href="#add-a-custom-event"><strong>Add a custom Event</strong></a></li>
<li><a href="#recorderror-and-set-span-status"><strong>RecordError and set span status</strong></a></li>
</ul>
</li>
<li>
<p><a href="#sampling-1"><strong>Sampling</strong></a></p>
<ul>
<li><a href="#head-sampling">head-sampling</a></li>
<li><a href="#tail-sampling">tail-sampling</a></li>
<li><a href="#advanced-topic-tail-sampling-at-scale-with-opentelemetry"><strong>Advanced Topic: Tail Sampling at scale with OpenTelemetry</strong></a></li>
<li><a href="#advanced-topic-jaegers-remote-sampling-extension"><strong>Advanced Topic: Jaeger’s Remote Sampling extension</strong></a></li>
</ul>
</li>
<li>
<p><a href="#red-metrics"><strong>RED Metrics</strong></a></p>
<ul>
<li><a href="#jaeger-configuration"><strong>Jaeger Configuration</strong></a></li>
</ul>
</li>
<li>
<p><a href="#opentelemetry-transformation-language-and-spans-ottl"><strong>OpenTelemetry Transformation Language and Spans (OTTL)</strong></a></p>
<ul>
<li><a href="#contexts"><strong>Contexts</strong></a></li>
<li><a href="#functions"><strong>Functions</strong></a></li>
<li><a href="#trace-your-k8s-environment-with-opentelemetry"><strong>Trace your k8s environment with OpenTelemetry</strong></a></li>
<li><a href="#etcd">ETCD</a></li>
<li><a href="#api-server"><strong>API-Server</strong></a></li>
<li><a href="#kubelet"><strong>Kubelet</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul></div></div></div></div><footer class="text-center py-4 mt-8 border-t">© 2025 · Built with Gatsby</footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/otlp/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-ec515adc39aa7430d310.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-051f7e1a395ea4ec2b2a.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-093de8076e2cf835e1d3.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-c34369a01a85b628d9ac.js\"],\"component---src-pages-links-js\":[\"/component---src-pages-links-js-7666f811b66803f137c5.js\"],\"component---src-pages-tags-js\":[\"/component---src-pages-tags-js-512d381bd81244b1af9c.js\"],\"component---src-pages-using-ssr-js\":[\"/component---src-pages-using-ssr-js-005fd2817f4487ca3dc9.js\"],\"component---src-templates-blog-list-js\":[\"/component---src-templates-blog-list-js-5fadf6a59ac6c5cfa4ee.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-9498a20d0ef2eefd61ce.js\"],\"component---src-templates-tags-js\":[\"/component---src-templates-tags-js-13eab85942606ca6630c.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="7d877e823468a4de5503";</script><script src="/webpack-runtime-7789ddc4cd9085cabb24.js" async></script><script src="/framework-6a525285796fb83f2864.js" async></script><script src="/app-ec515adc39aa7430d310.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>